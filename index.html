<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Volunteer Time Tracking</title>
  <style>
    :root { color-scheme: light dark; --primary: #000000; --text: #ffffff; --accent1: #35b1fb; --accent2: #0289db; --accent3: #054a74; --accent4: #00433a; --accent5: #ffffff; --header-bg-image: url('https://i.postimg.cc/t4S6CDjx/cityscape.jpg'); --footer-bg-image: url('https://i.postimg.cc/8Cfgxn5P/theater-seats.jpg'); }
    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.35; background-size: cover; background-repeat: no-repeat; color: var(--text); background-color: var(--primary); min-height: 100vh; display: flex; flex-direction: column; }
    header { position: relative; display:flex; justify-content:center; align-items:center; padding: 51px 0; margin-bottom: -32px; overflow: hidden; border-radius: 0; margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); }
    header::before { content: ""; position: absolute; inset: 0; background-image: var(--header-bg-image); background-position: 50% 34%; background-size: cover; background-repeat: no-repeat; opacity: 0.75; pointer-events: none; }
    header > * { position: relative; z-index: 1; }
    #logo { max-height: 112px; border-radius: 6px; transform: translateY(-7%); }
    h1 { margin: 0 0 16px; font-size: 22px; color: var(--accent1); text-align:center; }
    #appTitle { display:block; width: fit-content; margin: 0 auto 16px; background: #000; padding: 8px 12px; border-radius: 8px; position: relative; z-index: 2; transform: translateY(4%); }
    h2 { margin: 14px 0 10px; font-size: 18px; color: var(--accent2); }
    h3 { margin: 12px 0 8px; font-size: 16px; color: var(--accent3); }
    a { color: var(--accent1); }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 360px; border: 1px solid var(--accent3); padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.04); }
    label { display:block; margin-top: 6px; font-size: 14px; color: var(--accent5); }
    input, select { margin: 4px 0 8px; padding: 8px; width: 100%; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--accent3); background: rgba(0,0,0,0.25); color: var(--text); }
    button { padding: 8px 12px; margin: 6px 6px 0 0; border-radius: 10px; border: 1px solid var(--accent2); background: var(--primary); color: var(--text); cursor: pointer; }
    button:hover { background: var(--accent2); }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    thead th { background: rgba(255,255,255,0.06); color: var(--text); }
    th, td { border: 1px solid var(--accent3); padding: 6px 8px; vertical-align: top; }
    .hidden { display: none !important; }
    .error { color: #b00020; margin-top: 6px; }
    .hint { color: var(--accent2); margin-top: 6px; }
    .ok { color: #0b6; }
    .nowrap { white-space: nowrap; }
    .optional-field { margin-top: 10px; }
    .optional-field button { margin: 6px 0; }
    .optional-field-body { margin-top: 6px; }
    .ghost-btn {
      background: transparent;
      border-style: dashed;
    }
    .ghost-btn:hover {
      background: rgba(255,255,255,0.08);
    }
    /* Defensive: hide extension popovers/overlays if present */
    *[popover]{display:none!important;visibility:hidden!important;opacity:0!important;}
    #top-layer{display:none!important}

    /* Predictive org suggestions (site-styled blue panel) */
    .org-suggest-wrap { position: relative; }
    .org-suggest {
      position: absolute; left: 0; right: 0; top: 100%; z-index: 1000;
      border: 1px solid var(--accent2);
      background: linear-gradient(180deg, rgba(2,137,219,0.12), rgba(5,74,116,0.12)), rgba(0,8,20,0.98);
      border-radius: 10px; margin-top: 6px; max-height: 260px; overflow-y: auto;
      box-shadow: 0 10px 24px rgba(2,137,219,0.25), 0 2px 6px rgba(0,0,0,0.35);
    }
    .org-suggest::before {
      content: ""; position: absolute; top: -8px; left: 16px; width: 0; height: 0;
      border-left: 8px solid transparent; border-right: 8px solid transparent;
      border-bottom: 8px solid var(--accent2);
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.25));
    }
    .org-suggest.hidden { display: none !important; }
    .org-suggest div { padding: 10px 12px; cursor: pointer; color: var(--text); }
    .org-suggest div + div { border-top: 1px solid rgba(2,137,219,0.22); }
    .org-suggest div:hover, .org-suggest div.active { background: rgba(2,137,219,0.28); }
    .org-suggest div mark { background: transparent; color: var(--accent1); font-weight: 600; }

    /* Toolbar */
    nav#toolbar { display:flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 12px 0 16px; background: rgba(0,0,0,0.6); border: 1px solid var(--accent3); border-radius: 8px; padding: 8px; }
    nav#toolbar button { background: rgba(0,0,0,0.2); }

    /* Calendar */
    #calendarSection { width: min(100%, 960px); margin: 0 auto; }
    #calendarFilterRow .col { min-width: 200px; }
    .calendar-month-controls { display: flex; align-items: center; gap: 8px; }
    .calendar-month-controls button { margin: 0; }
    .calendar-month-label { font-weight: 600; font-size: 16px; min-width: 140px; text-align: center; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 6px; margin: 12px 0 6px; text-align: center; font-weight: 600; color: var(--accent5); }
    .calendar-weekdays div { padding: 4px 0; background: rgba(255,255,255,0.04); border-radius: 6px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 6px; min-height: 360px; }
    .calendar-day { border: 1px solid var(--accent3); border-radius: 10px; padding: 6px; min-height: 90px; background: rgba(0,0,0,0.25); display: flex; flex-direction: column; aspect-ratio: 1; }
    .calendar-day-number { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: var(--accent5); }
    .calendar-day--muted { opacity: 0.45; }
    .calendar-events { display: flex; flex-direction: column; gap: 4px; }
    .calendar-event { border: 1px solid rgba(53,177,251,0.4); background: rgba(2,137,219,0.16); border-left: 4px solid var(--accent1); border-radius: 8px; padding: 4px 6px; font-size: 13px; color: var(--text); cursor: pointer; text-align: left; transition: background 0.2s ease, border-color 0.2s ease; }
    .calendar-event:hover { background: rgba(2,137,219,0.32); }
    .calendar-more { font-size: 12px; color: var(--accent1); margin-top: 2px; }
    #calendarEventPanel .col { flex: 1 1 100%; }
    #calendarEventSummary div { margin-bottom: 4px; }
    #calendarStatus.error { color: #ff8a80; }
    .calendar-day-event-picker { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    .calendar-day-event-picker button { width: 100%; text-align: left; border-radius: 8px; border: 1px solid var(--accent2); background: rgba(2,137,219,0.15); color: var(--text); padding: 6px 8px; }
    .calendar-day-event-picker button:hover { background: rgba(2,137,219,0.3); }
    .calendar-day-schedule { margin-top: 18px; padding: 16px; border: 1px solid var(--accent3); border-radius: 12px; background: rgba(0,0,0,0.2); }
    .calendar-day-schedule-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .calendar-day-schedule-header strong { font-size: 16px; }
    .calendar-day-schedule-meta { font-size: 13px; color: var(--accent5); margin-top: 2px; }
    .calendar-day-schedule-controls { display: flex; gap: 8px; }
    .calendar-day-schedule-controls button { margin: 0; }
    .calendar-day-schedule-body { min-height: 60px; }
    .calendar-schedule-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .calendar-schedule-column { border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; background: rgba(255,255,255,0.04); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .calendar-schedule-column.is-focused { box-shadow: 0 0 0 2px rgba(53,177,251,0.4); }
    .calendar-schedule-column-header { font-weight: 600; font-size: 14px; display: flex; flex-direction: column; gap: 2px; border-left: 4px solid var(--accent1); padding-left: 8px; }
    .calendar-schedule-column-header span { font-weight: 400; font-size: 12px; color: var(--accent5); }
    .calendar-schedule-duty { border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.18); }
    .calendar-schedule-duty h4 { margin: 0 0 6px; font-size: 13px; font-weight: 600; }
    .calendar-schedule-duty-location { font-size: 12px; color: var(--accent5); margin-bottom: 6px; }
    .calendar-schedule-assignment { border-left: 4px solid var(--accent1); padding-left: 6px; margin-bottom: 6px; border-radius: 4px; background: rgba(255,255,255,0.05); }
    .calendar-schedule-assignment:last-child { margin-bottom: 0; }
    .calendar-schedule-assignment-name { font-weight: 600; font-size: 13px; }
    .calendar-schedule-assignment-time { font-size: 12px; color: var(--accent5); }
    .calendar-day-schedule-empty { padding: 8px; font-size: 13px; color: var(--accent5); }

    /* Home section tweaks */
    #homeSection { max-width: 640px; margin: 0 auto 16px; text-align: center; flex: 0 1 640px; }
    #homeHero { display: block; margin: 8px auto 0; max-width: 420px; width: 100%; border-radius: 10px; }

    /* Footer background image */
    footer#footer { position: relative; height: 288px; margin-top: auto; border-radius: 0; overflow: hidden; pointer-events: none; margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); }
    footer#footer::before { content: ""; position: absolute; inset: 0; background-image: var(--footer-bg-image); background-position: 50% 78%; background-size: cover; background-repeat: no-repeat; opacity: 0.75; pointer-events: none; }
    @media (max-width: 640px) {
      body { margin: 0; padding: 12px; overflow-x: hidden; }
      header, footer#footer { margin: 0 !important; width: 100% !important; }
      nav#toolbar, section, .col { width: 100%; max-width: 100%; box-sizing: border-box; }
      section { margin: 12px 0; padding: 12px; }
      .row { flex-direction: column; gap: 12px; }
      .col { flex: 1 1 100%; min-width: 0; }
      nav#toolbar { justify-content: flex-start; flex-wrap: wrap; gap: 8px; }
      nav#toolbar button { flex: 1 1 100%; min-width: 0; }
      table {
        width: 100%;
        max-width: 100%;
        table-layout: fixed;
        font-size: 13px;
      }
      table th, table td {
        padding: 6px 4px;
        word-break: break-word;
      }
      .stacked-table {
        border: none;
      }
      .stacked-table thead {
        display: none;
      }
      .stacked-table,
      .stacked-table tbody,
      .stacked-table tr,
      .stacked-table td {
        display: block;
        width: 100%;
      }
      .stacked-table tr {
        border: 1px solid var(--accent3);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 12px;
        background: rgba(0,0,0,0.35);
      }
      .stacked-table td {
        border: none;
        padding: 6px 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .stacked-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--accent2);
      }
      form, select, input, button, textarea { width: 100%; max-width: 100%; box-sizing: border-box; }
      input[type="date"],
      input[type="time"],
      input[type="datetime-local"] {
        min-width: 0;
        width: 100%;
        display: block;
      }
      .nowrap { white-space: normal; }
      #calendarGridWrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }
  </style>

  <!-- Strip any tracking params like ?utm_source=... to avoid parser oddities -->
  <script>
    (function stripQuery() {
      if (location.search && /utm_|fbclid|gclid/i.test(location.search)) {
        history.replaceState({}, document.title, location.pathname);
      }
    })();
  </script>
</head>
<body>
  <!-- build: 6cd6141 (signup typeahead prefix-first) refreshed at 2025-11-20T00:00:00Z -->
  <header>
    <a id="logoLink" href="#" target="_blank" rel="noopener noreferrer">
      <img id="logo" alt="logo" class="hidden" />
    </a>
  </header>
  <h1 id="appTitle">Volunteer Time Tracking</h1>
  <nav id="toolbar" class="hidden">
    <button id="navHomeBtn">Home</button>
    <button id="navAccountBtn">Account</button>
    <button id="navAdminBtn">Admin Tools</button>
    <button id="navEventsBtn">Events</button>
    <button id="navCreateDutyBtn">Create Duty</button>
    <button id="navVolunteerMgmtBtn" class="hidden">Volunteer Management</button>
    <button id="navCalendarBtn">Calendar</button>
    <button id="navClockBtn">Time Clock</button>
    <button id="navLogoutBtn">Logout</button>
  </nav>
  <div id="globalStatus" class="ok hidden" style="margin:8px 0;"></div>
  <section id="homeSection" class="col hidden">
    <h2>Welcome to the TTTC Volunteer Tracker App</h2>
    <img id="homeHero" alt="Welcome" src="https://i.postimg.cc/gjsftpNw/original-ticket.jpg" />
    <p>Use the toolbar above to navigate: create duties, clock time, manage events, and more.</p>
  </section>

  <!-- VOLUNTEER: TIME CLOCK PAGE -->
  <section id="clockSection" class="col hidden">
    <h2>Time Clock</h2>
    <div id="clockSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization</label>
        <select id="clockOrgFilter"><option value="">— Select organization —</option></select>
        <label style="margin-left:10px">Event</label>
        <select id="clockEventFilter" disabled><option value="">— Select event —</option></select>
        <label style="margin-left:10px">Duty</label>
        <select id="clockDutyFilter" disabled><option value="">— Select duty —</option></select>
      </div>
    </div>
    <div id="clockSuperNote" class="hint"></div>
    <div id="clockAdminAdjustWrap" class="hidden">
      <div id="clockAdminOrgRow" class="row hidden">
        <div class="col">
          <label>Organization</label>
          <select id="clockAdminOrgPicker"><option value="">— Select organization —</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Volunteer</label>
          <select id="clockAdminVolunteer"><option value="">— Select volunteer —</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <h3>Volunteer Timesheet</h3>
          <table class="stacked-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Event</th>
                <th>Duty</th>
                <th>Start</th>
                <th>End</th>
                <th>Hours</th>
                <th>Date</th>
                <th>Status</th>
                <th>Approve</th>
                <th>Save</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody id="clockAdminTimeList"></tbody>
          </table>
          <div id="clockAdminEmpty" class="hint"></div>
        </div>
      </div>
    </div>
    <div id="clockDutiesWrap">
      <h3>My Duties</h3>
      <table>
        <thead><tr><th>ID</th><th>Title</th><th>Description</th><th>Status</th><th>Capacity</th><th>Active</th><th>Track Time</th></tr></thead>
        <tbody id="dutyList"></tbody>
      </table>
      <div class="row">
        <div class="col">
          <button id="volDownloadDutiesBtn" class="ghost-btn">Download Duties CSV</button>
          <div id="volDownloadDutiesError" class="error"></div>
        </div>
      </div>
    </div>

    <div id="clockTimesWrap">
      <h3>My Timesheet</h3>
      <table class="stacked-table">
        <thead><tr><th>ID</th><th>Event</th><th>Duty</th><th>Start</th><th>End</th><th>Hours</th><th>Date</th></tr></thead>
        <tbody id="timeList"></tbody>
      </table>
      <button id="volDownloadCsvBtn" class="ghost-btn">Download My Timesheet CSV</button>
      <div id="volDownloadCsvError" class="error"></div>
    </div>
    <div id="clockActionMsg" class="ok hidden"></div>
  </section>

  <!-- VOLUNTEER: PHOTOS PAGE -->
  <!-- VOLUNTEER: EVENTS PAGE -->
  <section id="eventsSection" class="col hidden">
    <h2>Events</h2>
    <div id="eventsSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization (superadmin filter)</label>
        <select id="superEventGroupFilter"><option value="">— Select organization —</option></select>
        <div id="eventsSuperNote" class="hint"></div>
      </div>
    </div>
    <div id="eventsCreateWrap" class="row hidden">
      <div class="col">
        <h3>Create Event</h3>
        <label>Title</label><input id="eventTitle2" type="text" />
        <label>Description</label><input id="eventDesc2" type="text" />
        <label>Organization</label>
        <select id="eventGroup2"><option value="">— Select group —</option></select>
        <label>Start Date</label><input id="eventStart2" type="date" />
        <label>End Date</label><input id="eventEnd2" type="date" />
        <label>Start Time</label><input id="eventStartTime2" type="time" />
        <label>End Time</label><input id="eventEndTime2" type="time" />
        <div class="optional-field">
          <button id="eventAddressToggle" type="button" class="ghost-btn">Add Event Address</button>
          <div id="eventAddressField" class="optional-field-body hidden">
            <label>Event Address</label>
            <input id="eventAddress" type="text" placeholder="123 Main St, City, ST" />
          </div>
        </div>
        <button id="createEventBtn2">Create Event</button>
        <div id="createEventError2" class="error"></div>
      </div>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Title</th><th>Date(s)</th><th id="eventJoinHeader">Join</th><th id="eventActionsHeader" class="hidden">Actions</th></tr></thead>
      <tbody id="eventList"></tbody>
    </table>
    <div id="eventEditWrap" class="row hidden">
      <div class="col">
        <h3>Edit Event</h3>
        <label>Event ID</label><input id="editEventId" type="number" />
        <label>Title</label><input id="editEventTitle" type="text" />
        <label>Description</label><input id="editEventDesc" type="text" />
        <label>Address</label><input id="editEventAddress" type="text" />
        <label>Start Date</label><input id="editEventStart" type="date" />
        <label>End Date</label><input id="editEventEnd" type="date" />
        <label>Start Time</label><input id="editEventStartTime" type="time" />
        <label>End Time</label><input id="editEventEndTime" type="time" />
        <button id="saveEventBtn">Save Event</button>
        <div id="editEventError" class="error"></div>
      </div>
    </div>
  </section>

  <section id="calendarSection" class="col hidden">
    <h2>Calendar</h2>
    <div id="calendarFilterRow" class="row">
      <div class="col" id="calendarOrgFilterCol">
        <label>Organization</label>
        <select id="calendarGroupFilter"><option value="">All organizations</option></select>
        <div id="calendarFilterHint" class="hint"></div>
      </div>
      <div class="col">
        <label>Month</label>
        <div class="calendar-month-controls">
          <button id="calendarPrevMonth" type="button">&lt; Prev</button>
          <div id="calendarMonthLabel" class="calendar-month-label"></div>
          <button id="calendarNextMonth" type="button">Next &gt;</button>
        </div>
      </div>
    </div>
    <div class="calendar-weekdays">
      <div>Sun</div>
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
    </div>
    <div id="calendarGrid" class="calendar-grid"></div>
    <div id="calendarStatus" class="hint"></div>
    <div id="calendarEventPanel" class="row hidden">
      <div class="col">
        <h3>Event Details</h3>
        <div id="calendarEventSummary">
          <div>Select an event to view details.</div>
        </div>
        <div id="calendarEventAdminWrap" class="hidden" style="margin-top:12px">
          <label>Title</label><input id="calendarEditTitle" type="text" />
          <label>Description</label><input id="calendarEditDescription" type="text" />
          <div class="row">
            <div class="col">
              <label>Start Date</label><input id="calendarEditStartDate" type="date" />
              <label>Start Time</label><input id="calendarEditStartTime" type="time" />
            </div>
            <div class="col">
              <label>End Date</label><input id="calendarEditEndDate" type="date" />
              <label>End Time</label><input id="calendarEditEndTime" type="time" />
            </div>
          </div>
          <div class="row" id="calendarColorRow" style="gap:12px; align-items:flex-end">
            <div class="col" style="flex:0 0 180px">
              <label>Event Color</label>
              <input id="calendarEditColor" type="color" value="#118ab2" data-cleared="true" />
            </div>
            <div class="col" style="flex:0 0 140px">
              <button id="calendarClearColorBtn" type="button">Clear Color</button>
            </div>
          </div>
              <label>Address</label><input id="calendarEditAddress" type="text" />
          <div id="calendarEditGroupRow" class="row hidden">
            <div class="col">
              <label>Organization</label>
              <select id="calendarEditGroup"><option value="">— Select organization —</option></select>
            </div>
          </div>
          <div style="margin-top:10px">
            <button id="calendarSaveEventBtn" type="button">Save Changes</button>
            <button id="calendarArchiveEventBtn" type="button" style="margin-left:8px">Archive</button>
            <button id="calendarDeleteEventBtn" type="button" style="margin-left:8px;color:#b00020">Delete</button>
          </div>
          <div id="calendarEditError" class="error"></div>
        </div>
        <div id="calendarDaySchedule" class="calendar-day-schedule hidden">
          <div class="calendar-day-schedule-header">
            <div>
              <strong id="calendarDayScheduleTitle">Selected Day</strong>
              <div id="calendarDayScheduleMeta" class="calendar-day-schedule-meta"></div>
            </div>
            <div class="calendar-day-schedule-controls">
              <button id="calendarDayScheduleRefresh" type="button">Refresh</button>
            </div>
          </div>
          <div id="calendarDayScheduleBody" class="calendar-day-schedule-body">
            <div class="hint">Select a day to view volunteer assignments.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="createDutySection" class="col hidden">
    <h2>Create Duty</h2>
    <div id="dutiesSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization (superadmin filter)</label>
        <select id="superDutyGroupFilter"><option value="">— Select organization —</option></select>
        <div id="dutiesSuperNote" class="hint"></div>
      </div>
    </div>
    <div id="createDutyAdmin" class="row">
      <div class="col">
        <h3>Admin Create Duty</h3>
        <label>Title</label><input id="dutyTitle" type="text" />
        <label>Description</label><input id="dutyDesc" type="text" />
        <label>Group</label>
        <select id="dutyGroup"><option value="">— Select group —</option></select>
        <label>Event</label>
        <select id="dutyEvent"><option value="">— Select event —</option></select>
        <label>Status</label>
        <select id="dutyStatus">
          <option value="open">open</option>
          <option value="closed">closed</option>
        </select>
        <label>Color</label><input id="dutyColor" type="color" value="#2563eb" />
        <label>Max Volunteers (optional)</label>
        <input id="dutyCapacity" type="number" min="1" placeholder="Unlimited" />
        <div class="optional-field">
          <button id="dutyLocationToggle" type="button" class="ghost-btn">Add Duty Location</button>
          <div id="dutyLocationField" class="optional-field-body hidden">
            <label>Location</label>
            <input id="dutyLocation" type="text" placeholder="Backstage, Hall B" />
          </div>
        </div>
        <button id="createDutyBtn">Create Duty</button>
        <div id="createDutyError" class="error"></div>
      </div>
    </div>
    <div id="createDutyVol" class="row">
      <div class="col">
        <h3>Volunteer Create Duty</h3>
        <label>Title</label><input id="volDutyTitle" type="text" />
        <label>Description</label><input id="volDutyDesc" type="text" />
        <label>Event (optional)</label>
        <select id="volDutyEvent"><option value="">— None —</option></select>
        <div class="optional-field">
          <button id="volDutyLocationToggle" type="button" class="ghost-btn">Add Duty Location</button>
          <div id="volDutyLocationField" class="optional-field-body hidden">
            <label>Location</label>
            <input id="volDutyLocation" type="text" placeholder="Lobby, Front Desk" />
          </div>
        </div>
        <button id="volCreateDutyBtn">Create Duty</button>
        <div id="volCreateDutyError" class="error"></div>
      </div>
    </div>
    <div id="dutyTemplatePanel" class="row hidden">
      <div class="col">
        <h3>Duty Template Pool</h3>
        <label>Template Options</label>
        <select id="dutyTemplateMode">
          <option value="use">Use saved duty</option>
          <option value="add">Add new template</option>
        </select>
        <div id="dutyTemplateUseWrap">
          <label>Saved Duties</label>
          <select id="dutyTemplateSelect" disabled><option value="">— No saved duties —</option></select>
          <button id="applyDutyTemplateBtn" type="button">Apply to Create Duty</button>
        </div>
        <div id="dutyTemplateAddWrap" class="hidden">
          <label>Title</label><input id="templateTitle" type="text" />
          <label>Description</label><input id="templateDesc" type="text" />
          <label>Status</label>
          <select id="templateStatus">
            <option value="open">open</option>
            <option value="closed">closed</option>
          </select>
          <label>Color</label><input id="templateColor" type="color" value="#2563eb" />
          <label>Max Volunteers (optional)</label>
          <input id="templateCapacity" type="number" min="1" placeholder="Unlimited" />
          <div id="dutyTemplateGroupRow" class="hidden">
            <label>Organization</label>
            <select id="dutyTemplateGroup"><option value="">— Select group —</option></select>
          </div>
          <button id="saveDutyTemplateBtn" type="button">Save to Pool</button>
        </div>
        <div id="dutyTemplateStatus" class="hint hidden"></div>
      </div>
    </div>
    <div id="dutyEditSelectorWrap" class="row hidden">
      <div class="col">
        <label>Select Duty to Edit</label>
        <select id="dutyEditSelect"><option value="">— Select duty —</option></select>
      </div>
    </div>
    <div id="dutyEditWrap" class="row hidden">
      <div class="col">
        <h3>Edit Duty</h3>
        <label>Duty ID</label><input id="editDutyId" type="number" />
        <label>Title</label><input id="editDutyTitle" type="text" />
        <label>Description</label><input id="editDutyDesc" type="text" />
        <label>Status</label>
        <select id="editDutyStatus">
          <option value="pending">pending</option>
          <option value="in_progress">in_progress</option>
          <option value="completed">completed</option>
        </select>
        <label>Color</label><input id="editDutyColor" type="color" value="#2563eb" />
        <label>Max Volunteers (optional)</label>
        <input id="editDutyCapacity" type="number" min="1" placeholder="Unlimited" />
        <div class="optional-field">
          <button id="editDutyLocationToggle" type="button" class="ghost-btn">Add Duty Location</button>
          <div id="editDutyLocationField" class="optional-field-body hidden">
            <label>Location</label>
            <input id="editDutyLocation" type="text" placeholder="Backstage, Hall B" />
          </div>
        </div>
        <button id="saveDutyBtn">Save Duty</button>
        <div id="editDutyError" class="error"></div>
        <div id="dutyRestrictionsWrap" class="hidden" style="margin-top:16px">
          <h4>Restrict Volunteers From This Duty</h4>
          <div class="row" style="gap:12px">
            <div class="col">
              <label>Volunteer</label>
              <select id="dutyRestrictionVolunteer"><option value="">— Select volunteer —</option></select>
            </div>
            <div class="col" style="align-self:flex-end">
              <button id="addDutyRestrictionBtn" type="button">Restrict Volunteer</button>
            </div>
          </div>
          <div id="dutyRestrictionStatus" class="error"></div>
          <ul id="dutyRestrictionList" class="restrictionList" style="margin-top:8px;padding-left:18px"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- LOGIN -->
  <section id="authSection" class="col">
    <h2>Login</h2>
    <label>Email</label>
    <input id="email" type="email" autocomplete="username" />
    <label>Password</label>
    <input id="password" type="password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <div id="loginError" class="error"></div>

    <button id="showSignupBtn" style="margin-top:16px">Sign up</button>
    <div id="signupWrap" class="hidden">
      <h2 style="margin-top:16px">Sign Up</h2>
      <label>Name</label>
      <input id="signupName" type="text" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
      <label>Email</label>
      <input id="signupEmail" type="email" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
      <label>Password</label>
      <input id="signupPassword" type="password" autocomplete="new-password" />
      <label>Organization</label>
      <div id="signupGroupWrap" class="org-suggest-wrap">
        <input id="signupGroupInput" type="text" autocomplete="off" spellcheck="false" placeholder="Type to search organizations" />
        <!-- Removed native datalist to avoid grey browser dropdown -->
        <div id="signupGroupSuggestions" class="org-suggest hidden"></div>
      </div>
      <div id="signupOrgError" class="error"></div>
      <label>Phone</label>
      <input id="signupPhone" type="text" autocomplete="off" inputmode="tel" />
      <button id="signupBtn" type="button">Create Account</button>
      <div id="signupError" class="error"></div>
    </div>
  </section>

  <!-- ACCOUNT INFO (Name, Email, Phone, Address only) -->
  <section id="infoSection" class="col hidden">
    <h2>Account</h2>
    <div>Role: <strong id="role"></strong></div>
    <div>Group: <strong id="groupName"></strong> <span id="groupIdWrap" class="nowrap hidden">(ID: <span id="groupId"></span>)</span></div>
    <div>Time Zone: <strong id="accountTimeZone">—</strong></div>
    <div>User ID: <strong id="userId"></strong></div>
    <button id="logoutBtn">Logout</button>
    <hr />
    <h3>Profile</h3>
    <div class="row">
      <div class="col">
        <label>Name</label>
        <input id="acctName" type="text" />
        <label>Email</label>
        <input id="acctEmail" type="email" />
        <label>Phone</label>
        <input id="acctPhone" type="text" />
        <label>Address</label>
        <input id="acctAddress" type="text" />
        <button id="saveAccountInfo">Save</button>
        <div id="accountInfoError" class="error"></div>
      </div>
    </div>
    <div class="row hidden" id="brandingToggleRow">
      <div class="col">
        <button id="brandingToggleBtn" type="button">Show Organization Branding</button>
      </div>
    </div>
    <div id="brandingSettings" class="row hidden">
      <div class="col">
        <h3 id="brandingHeader">Organization Branding</h3>
        <p class="hint" style="margin-top:0">Customize how this application looks for members of your organization.</p>
        <label>Logo URL</label>
        <input id="brandingLogoUrl" type="url" placeholder="https://example.com/logo.png" />
        <input id="brandingLogoFile" type="file" accept="image/png,image/jpeg,image/webp" />
        <label>Banner Image URL</label>
        <input id="brandingBannerUrl" type="url" placeholder="https://example.com/banner.jpg" />
        <input id="brandingBannerFile" type="file" accept="image/png,image/jpeg,image/webp" />
        <label>Welcome Image URL</label>
        <input id="brandingHeroUrl" type="url" placeholder="https://example.com/welcome.jpg" />
        <input id="brandingHeroFile" type="file" accept="image/png,image/jpeg,image/webp" />
        <label>Footer Image URL</label>
        <input id="brandingFooterUrl" type="url" placeholder="https://example.com/footer.jpg" />
        <input id="brandingFooterFile" type="file" accept="image/png,image/jpeg,image/webp" />
        <div class="row" style="gap:12px">
          <div style="flex:1 1 160px">
            <label>Primary Color</label>
            <input id="brandingPrimaryColor" type="color" value="#000000" />
          </div>
          <div style="flex:1 1 160px">
            <label>Text Color</label>
            <input id="brandingTextColor" type="color" value="#ffffff" />
          </div>
          <div style="flex:1 1 160px">
            <label>Accent 1</label>
            <input id="brandingAccent1" type="color" value="#35b1fb" />
          </div>
          <div style="flex:1 1 160px">
            <label>Accent 2</label>
            <input id="brandingAccent2" type="color" value="#0289db" />
          </div>
          <div style="flex:1 1 160px">
            <label>Accent 3</label>
            <input id="brandingAccent3" type="color" value="#054a74" />
          </div>
          <div style="flex:1 1 160px">
            <label>Accent 4</label>
            <input id="brandingAccent4" type="color" value="#00433a" />
          </div>
          <div style="flex:1 1 160px">
            <label>Accent 5</label>
            <input id="brandingAccent5" type="color" value="#ffffff" />
          </div>
        </div>
        <div style="margin-top:12px">
          <button id="saveBrandingBtn">Save Branding</button>
          <button id="resetBrandingBtn" type="button">Reset to Default</button>
        </div>
        <div id="brandingStatus" class="ok hidden"></div>
      </div>
    </div>
  </section>

  <!-- SUPERADMIN -->
  <section id="superadminSection" class="col hidden">
    <h2>Superadmin Tools</h2>

    <h3>Create Organization (Group)</h3>
    <div class="row">
      <div class="col">
        <label>Organization Name</label><input id="groupNameInput" type="text" />
        <label>Status</label>
        <select id="groupStatus">
          <option value="active">active</option>
          <option value="inactive">inactive</option>
        </select>
        <label>Time Zone</label>
        <select id="groupTimeZone"></select>
        <button id="createGroupBtn">Create Group</button>
        <div id="createGroupError" class="error"></div>
      </div>
    </div>

    <h3>All Organizations</h3>
    <div class="row">
      <div class="col">
        <label>Organizations</label>
        <select id="superadminOrgPicker"><option value="">— Select organization —</option></select>
      </div>
    </div>
    <div id="superadminOrgInfo" class="row hidden">
      <div class="col">
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Time Zone</th><th>Save</th></tr></thead>
          <tbody id="superadminOrgInfoBody"></tbody>
        </table>
        <div id="superadminOrgInfoErr" class="error"></div>
      </div>
    </div>
    <table id="groupTable" class="hidden">
      <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Time Zone</th><th>Actions</th></tr></thead>
      <tbody id="groupList"></tbody>
    </table>

    <h3>User Management</h3>
    <div class="row" id="saUserRoleRow">
      <div class="col">
        <label>Role</label>
        <select id="saUserRole">
          <option value="admin">admin</option>
          <option value="superadmin">superadmin</option>
          <option value="volunteer">volunteer</option>
          <option value="all">all</option>
        </select>
      </div>
    </div>
    <div class="row hidden" id="saAdminRow">
      <div class="col">
        <label>Select User to Edit</label>
        <select id="saAdminSelect"><option value="">— Select user —</option></select>
      </div>
    </div>
    <div id="saAdminEditPanel" class="row hidden">
      <div class="col">
        <h3>Edit User</h3>
        <label>User ID</label><input id="saAdminEditId" type="number" />
        <label>Name</label><input id="saAdminEditName" type="text" />
        <label>Email</label><input id="saAdminEditEmail" type="email" />
        <label>New Password (leave blank to keep)</label><input id="saAdminEditPassword" type="password" />
        <div style="margin:6px 0">
          <button id="saTogglePwBtn" type="button">Show</button>
          <button id="saUpdatePwBtn" type="button" style="margin-left:8px">Update Password</button>
        </div>
        <label>Phone</label><input id="saAdminEditPhone" type="text" />
        <label>Address</label><input id="saAdminEditAddress" type="text" />
        <button id="saSaveAdminBtn">Save User</button>
        <button id="saDeleteUserBtn" style="margin-left:8px;color:#b00020">Delete User</button>
        <button id="saCloseAdminEditBtn" style="margin-left:8px">Close</button>
        <div id="saAdminSaveErr" class="error"></div>
      </div>
    </div>

    <h3>All Time Logs (By Organization)</h3>
    <div class="row" id="superTimeVolunteerRow">
      <div class="col">
        <label>Volunteers to review</label>
        <select id="superTimeVolunteerSelect">
          <option value="">Select an organization above.</option>
        </select>
        <div class="hint" id="superTimeVolunteerHint">Select an organization, then choose a volunteer.</div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:10px">
          <input type="checkbox" id="superDownloadCsvApprovedOnly" />
          Approved entries only
        </label>
        <button id="superDownloadCsvBtn">Download Selected CSV</button>
        <div id="superDownloadCsvError" class="error"></div>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Volunteer</th>
          <th>Event</th>
          <th>Duty</th>
          <th>Start</th>
          <th>End</th>
          <th>Hours</th>
          <th>Date</th>
          <th>Status</th>
          <th>Approve</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="superAdminTimeList"></tbody>
    </table>

    <h3>Create User (Superadmin)</h3>
    <div class="row">
      <div class="col">
        <label>Role</label>
        <select id="newUserRole">
          <option value="superadmin">superadmin</option>
          <option value="admin">admin</option>
          <option value="volunteer">volunteer</option>
        </select>
        <label>Name</label><input id="newUserName" type="text" />
        <label>Email</label><input id="newUserEmail" type="email" />
        <label>Password</label><input id="newUserPassword" type="password" />
        <label>Group (optional for superadmin/global)</label>
        <select id="newUserGroup"><option value="">— None —</option></select>
        <button id="createUserBtn">Create User</button>
        <div id="createUserError" class="error"></div>
      </div>
    </div>

    
  </section>

  <!-- ADMIN -->
  <section id="adminSection" class="col hidden">
    <h2>Admin Tools</h2>

    

    

    <h3>Create Admin</h3>
    <div class="row">
      <div class="col">
        <label>Email</label><input id="adminEmail" type="email" />
        <label>Password</label><input id="adminPassword" type="password" />
        <label>Group</label>
        <select id="adminGroup"><option value="">— None —</option></select>
        <button id="createAdminBtn">Create Admin</button>
        <div id="createAdminErr" class="error"></div>
      </div>
    </div>

    

    

    <h3>Pending Approvals</h3>
    <table>
      <thead><tr><th>Log ID</th><th>Volunteer</th><th>Hours</th><th>Date</th><th>Approve</th><th>Delete</th></tr></thead>
      <tbody id="approvalList"></tbody>
    </table>

    <div class="row" id="adminTimeVolunteerRow">
      <div class="col">
        <label>Volunteers to review</label>
        <select id="adminTimeVolunteerSelect" multiple size="6">
          <option value="">Select volunteers to begin.</option>
        </select>
        <div class="hint" id="adminTimeVolunteerHint">Select one or more volunteers to view logs.</div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:10px">
          <input type="checkbox" id="downloadCsvApprovedOnly" />
          Approved entries only
        </label>
        <button id="downloadCsvBtn">Download Selected CSV</button>
        <div id="downloadCsvError" class="error"></div>
      </div>
    </div>

    <h3>All Time Logs (Scoped to Org)</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Volunteer</th>
          <th>Event</th>
          <th>Duty</th>
          <th>Start</th>
          <th>End</th>
          <th>Hours</th>
          <th>Date</th>
          <th>Status</th>
          <th>Approve</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="adminTimeList"></tbody>
    </table>

  </section>

  <!-- VOLUNTEER MANAGEMENT (Admin/Superadmin) -->
  <section id="volMgmtSection" class="col hidden">
    <h2>Volunteer Management</h2>
    <div id="vmSuperOrgRow" class="row hidden">
      <div class="col">
        <label>Organization</label>
        <select id="vmOrgPicker"><option value="">— Select organization —</option></select>
      </div>
    </div>
    <div id="vmEventRow" class="row">
      <div class="col">
        <label>Event</label>
        <select id="vmEvent"><option value="">— Select event —</option></select>
      </div>
    </div>
    <div class="row" id="vmVolunteerRow">
      <div class="col">
        <label>Volunteer</label>
        <select id="vmVolunteer"><option value="">— Select volunteer —</option></select>
        <label style="margin-top:10px">Duty</label>
        <select id="vmDuty"><option value="">— Select duty —</option></select>
        <label>Start Time</label>
        <input id="vmStart" type="datetime-local" />
        <label>End Time (optional)</label>
        <input id="vmEnd" type="datetime-local" />
        
        <button id="vmAddBtn">Add Time Entry</button>
        <div id="vmErr" class="error"></div>
        <div id="vmTimeStatus" class="ok hidden"></div>
      </div>
    </div>
    <div id="vmEditPanel" class="row hidden">
      <div class="col">
        <h3>Edit Volunteer</h3>
        <label>User ID</label><input id="vmEditId" type="number" />
        <label>Name</label><input id="vmEditName" type="text" />
        <label>Email</label><input id="vmEditEmail" type="email" />
        <label>New Password (leave blank to keep)</label><input id="vmEditPassword" type="password" />
        <div style="margin:6px 0">
          <button id="vmTogglePwBtn" type="button">Show</button>
          <button id="vmUpdatePwBtn" type="button" style="margin-left:8px">Update Password</button>
        </div>
        <label>Phone</label><input id="vmEditPhone" type="text" />
        <label>Address</label><input id="vmEditAddress" type="text" />
        <button id="vmSaveUserBtn">Save User</button>
        <button id="vmDeleteUserBtn" style="margin-left:8px;color:#b00020">Delete</button>
        <button id="vmCloseEditBtn" style="margin-left:8px">Close</button>
        <div id="vmSaveUserErr" class="error"></div>
      </div>
    </div>
    <div class="row" id="vmLogsRow">
      <div class="col">
        <h3>Selected Volunteer Logs</h3>
        <table class="stacked-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Duty</th>
              <th>Start</th>
              <th>End</th>
              <th>Hours</th>
              <th>Date</th>
              <th>Status</th>
              <th>Approve</th>
            </tr>
          </thead>
          <tbody id="vmLogList"></tbody>
        </table>
      </div>
    </div>
    <div class="row" id="vmEditSelectRow">
      <div class="col">
        <label>Select Volunteer to Edit</label>
        <select id="vmEditSelect"><option value="">— Select volunteer —</option></select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <h3>Create Volunteer</h3>
        <label>Name</label><input id="vmVolName" type="text" />
        <label>Email</label><input id="vmVolEmail" type="email" />
        <label>Password</label><input id="vmVolPassword" type="password" />
        <label>Group</label>
        <select id="vmVolGroup"><option value="">— None —</option></select>
        <button id="vmCreateVolBtn">Create Volunteer</button>
        <div id="vmCreateVolErr" class="error"></div>
      </div>
    </div>
  </section>

  <!-- VOLUNTEER (legacy combined section removed; now split into dedicated pages) -->

  <footer id="footer"></footer>

  <script>
    const apiUrl = window.location.origin;
    let token = null;
    let role = null;
    let groupId = null;
    let userId = null;
    // North America focused list; add more later if needed
    const supportedTimeZones = [
      { value: 'America/New_York', label: 'Eastern (America/New_York)' },
      { value: 'America/Chicago', label: 'Central (America/Chicago)' },
      { value: 'America/Denver', label: 'Mountain (America/Denver)' },
      { value: 'America/Phoenix', label: 'Mountain AZ - no DST (America/Phoenix)' },
      { value: 'America/Los_Angeles', label: 'Pacific (America/Los_Angeles)' },
      { value: 'America/Anchorage', label: 'Alaska (America/Anchorage)' },
      { value: 'Pacific/Honolulu', label: 'Hawaii (Pacific/Honolulu)' },
      { value: 'UTC', label: 'UTC' }
    ];
    const DEFAULT_TIME_ZONE = 'America/Chicago';
    let groupTimeZoneById = {};
    let groupNameById = {};
    let volunteerTimeZoneById = {};
    let timeEntryTimeZoneById = {};
    let activeTimeZone = DEFAULT_TIME_ZONE;
    const CALENDAR_EVENT_COLORS = [
      '#35b1fb',
      '#ef476f',
      '#ffd166',
      '#06d6a0',
      '#118ab2',
      '#9b5de5',
      '#f3722c',
      '#ff6f91'
    ];
    const calendarState = {
      currentMonth: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      events: [],
      eventsByDate: {},
      selectedEventId: null,
      lastStatusIsError: false,
      needsRefresh: true,
      activeDateKey: null,
      scheduleCache: {},
      scheduleFocusEventId: null,
    };
    let dutyRestrictionVolunteerCache = {};
    let dutyRestrictionState = { currentDutyId: null };
    const optionalFieldControls = {};
    const DEFAULT_LOGO_URL = 'https://i.postimg.cc/Ght5qLQw/TTTC-Logo-Redesign2.jpg';
    const DEFAULT_HEADER_IMAGE = 'https://i.postimg.cc/t4S6CDjx/cityscape.jpg';
    const DEFAULT_HERO_IMAGE = 'https://i.postimg.cc/gjsftpNw/original-ticket.jpg';
    const DEFAULT_FOOTER_IMAGE = 'https://i.postimg.cc/8Cfgxn5P/theater-seats.jpg';
    const rootStyle = getComputedStyle(document.documentElement);
    let defaultBranding = {
      primary_color: rootStyle.getPropertyValue('--primary')?.trim() || '#000000',
      text_color: rootStyle.getPropertyValue('--text')?.trim() || '#ffffff',
      accent1: rootStyle.getPropertyValue('--accent1')?.trim() || '#35b1fb',
      accent2: rootStyle.getPropertyValue('--accent2')?.trim() || '#0289db',
      accent3: rootStyle.getPropertyValue('--accent3')?.trim() || '#054a74',
      accent4: rootStyle.getPropertyValue('--accent4')?.trim() || '#00433a',
      accent5: rootStyle.getPropertyValue('--accent5')?.trim() || '#ffffff',
      logo_url: DEFAULT_LOGO_URL,
      banner_url: DEFAULT_HEADER_IMAGE,
      hero_image: DEFAULT_HERO_IMAGE,
      footer_url: DEFAULT_FOOTER_IMAGE,
    };
    let currentOrgBranding = null;

    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }
    function updateStatusMessage(elId, message = '', isError = false) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('hidden','error','ok');
      if (!message) { el.classList.add('hidden'); return; }
      el.classList.add(isError ? 'error' : 'ok');
    }
    let actionStatusTimeout = null;
    function showActionStatus(message = '', isError = false) {
      updateStatusMessage('globalStatus', message, isError);
      if (actionStatusTimeout) clearTimeout(actionStatusTimeout);
      if (message) {
        actionStatusTimeout = setTimeout(() => updateStatusMessage('globalStatus',''), 4000);
      }
    }
    function setupOptionalFieldToggle({ buttonId, fieldId, inputId, showLabel, hideLabel }) {
      const button = document.getElementById(buttonId);
      const field = document.getElementById(fieldId);
      const input = inputId ? document.getElementById(inputId) : (field ? field.querySelector('input,textarea,select') : null);
      if (!button || !field) {
        return {
          show() {},
          hide() {},
          isActive() { return false; },
        };
      }
      const setState = (active) => {
        field.classList.toggle('hidden', !active);
        button.textContent = active ? hideLabel : showLabel;
        button.dataset.active = active ? 'true' : 'false';
        if (!active && input) input.value = '';
      };
      button.addEventListener('click', () => {
        const next = button.dataset.active !== 'true';
        setState(next);
        if (next && input) input.focus();
      });
      setState(false);
      return {
        show: () => setState(true),
        hide: () => setState(false),
        isActive: () => button.dataset.active === 'true',
      };
    }
    function populateTimeZoneSelect(select, selected) {
      if (!select) return;
      select.innerHTML = '';
      supportedTimeZones.forEach(tz => {
        const opt = document.createElement('option');
        opt.value = tz.value;
        opt.textContent = tz.label;
        if (tz.value === (selected || DEFAULT_TIME_ZONE)) opt.selected = true;
        select.appendChild(opt);
      });
      if (!select.value) select.value = DEFAULT_TIME_ZONE;
    }
    function formatTimeZoneLabel(value) {
      const match = supportedTimeZones.find(tz => tz.value === value);
      return match ? match.label : (value || 'UTC');
    }
    function refreshAccountTimeZoneDisplay() {
      const tzEl = document.getElementById('accountTimeZone');
      if (!tzEl) return;
      const tz = (groupId != null && groupTimeZoneById[groupId]) ? groupTimeZoneById[groupId] : activeTimeZone;
      tzEl.textContent = formatTimeZoneLabel(tz || DEFAULT_TIME_ZONE);
    }
    refreshAccountTimeZoneDisplay();
    const pad2 = n => String(n).padStart(2, '0');
    function getGroupTimeZone(id) {
      return (id != null && groupTimeZoneById[id]) ? groupTimeZoneById[id] : DEFAULT_TIME_ZONE;
    }
    function setActiveTimeZoneForGroup(id) {
      activeTimeZone = getGroupTimeZone(id);
    }
    function getVolunteerTimeZone(volId) {
      return volunteerTimeZoneById[volId] || activeTimeZone;
    }
    function formatVolunteerLabel(row) {
      if (!row) return '';
      const id = row.volunteer_id;
      if (id == null || id === '') return '';
      const source = row.volunteer_name || row.volunteer_email || '';
      if (source) return `${source} (#${id})`;
      return `#${id}`;
    }
    function mapDateParts(parts = []) {
      return parts.reduce((acc, part) => {
        if (part.type && part.type !== 'literal') acc[part.type] = part.value;
        return acc;
      }, {});
    }
    function convertUtcToLocalInput(iso, tz) {
      if (!iso) return '';
      try {
        const formatter = new Intl.DateTimeFormat('en-CA', {
          timeZone: tz || activeTimeZone,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
        const parts = mapDateParts(formatter.formatToParts(new Date(iso)));
        if (!parts.year || !parts.month || !parts.day || !parts.hour || !parts.minute) return iso;
        return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`;
      } catch {
        return iso;
      }
    }
    function convertLocalInputToUtc(value, tz) {
      if (!value) return null;
      const match = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/.exec(value);
      if (!match) return null;
      const [ , yearStr, monthStr, dayStr, hourStr, minuteStr ] = match;
      const year = Number(yearStr);
      const month = Number(monthStr);
      const day = Number(dayStr);
      const hour = Number(hourStr);
      const minute = Number(minuteStr);
      if ([year, month, day, hour, minute].some(n => Number.isNaN(n))) return null;
      const targetLocalMs = Date.UTC(year, month - 1, day, hour, minute);
      const timeZone = tz || activeTimeZone;
      const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: timeZone,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      let utcMs = targetLocalMs;
      let iterations = 0;
      const maxIterations = 5;
      while (iterations < maxIterations) {
        const parts = mapDateParts(formatter.formatToParts(new Date(utcMs)));
        if (!parts.year || !parts.month || !parts.day || !parts.hour || !parts.minute) break;
        const renderedLocalMs = Date.UTC(Number(parts.year), Number(parts.month) - 1, Number(parts.day), Number(parts.hour), Number(parts.minute));
        const diff = renderedLocalMs - targetLocalMs;
        if (diff === 0) break;
        utcMs -= diff;
        iterations += 1;
      }
      return new Date(utcMs).toISOString();
    }
    function formatDisplayDateTime(iso, tz) {
      if (!iso) return '';
      try {
        return new Intl.DateTimeFormat(undefined, {
          timeZone: tz || activeTimeZone,
          month: '2-digit', day: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit', hour12: true
        }).format(new Date(iso));
      } catch {
        return iso;
      }
    }
    function setDutyRestrictionStatus(message = '', isError = false) {
      const el = document.getElementById('dutyRestrictionStatus');
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('hidden','error','ok');
      if (!message) { el.classList.add('hidden'); return; }
      el.classList.add(isError ? 'error' : 'ok');
    }
    function clearDutyRestrictionUI() {
      dutyRestrictionState.currentDutyId = null;
      const wrap = document.getElementById('dutyRestrictionsWrap');
      if (wrap) wrap.classList.add('hidden');
      const list = document.getElementById('dutyRestrictionList');
      if (list) list.innerHTML = '';
      const sel = document.getElementById('dutyRestrictionVolunteer');
      if (sel) { sel.innerHTML = '<option value="">— Select volunteer —</option>'; sel.disabled = true; }
      setDutyRestrictionStatus('');
    }

    function autoSelectGroupDropdown(elementId, value) {
      const el = document.getElementById(elementId);
      if (!el || !value || el.value) return;
      el.value = String(value);
      try { el.dispatchEvent(new Event('change')); } catch { /* ignore */ }
    }

    function formatDutyLabel(dutyId, fallbackTitle) {
      if (!dutyId) return '';
      const dutyMap = window.dutyById || {};
      const duty = dutyMap[dutyId];
      const title = fallbackTitle || (duty && duty.title);
      if (title) return `${dutyId} — ${title}`;
      return `Duty #${dutyId}`;
    }

    function formatEventLabel(eventId, fallbackTitle) {
      if (!eventId && !fallbackTitle) return '';
      if (eventId && fallbackTitle) return `${eventId} — ${fallbackTitle}`;
      if (fallbackTitle) return fallbackTitle;
      return `Event #${eventId}`;
    }

    function describeAssignment(row = {}) {
      const dutyId = row.duty_id ?? null;
      const dutyMap = window.dutyById || {};
      const dutyMeta = dutyMap[dutyId] || {};
      const eventMap = window.eventById || {};
      const resolvedEventId = row.resolved_event_id ?? row.event_id ?? row.duty_event_id ?? dutyMeta.event_id ?? null;
      const dutyLabel = formatDutyLabel(dutyId, row.duty_title || dutyMeta.title);
      let eventTitle = row.event_title;
      if (!eventTitle && resolvedEventId && eventMap[resolvedEventId]?.title) {
        eventTitle = eventMap[resolvedEventId].title;
      } else if (!eventTitle && dutyMeta.event_title) {
        eventTitle = dutyMeta.event_title;
      }
      const eventLabel = formatEventLabel(resolvedEventId, eventTitle);
      return { dutyLabel, eventLabel };
    }

    function getSelectedAdminVolunteerIds() {
      const sel = document.getElementById('adminTimeVolunteerSelect');
      if (!sel || sel.disabled) return [];
      return Array.from(sel.selectedOptions || [])
        .map(opt => Number(opt.value))
        .filter(id => Number.isFinite(id));
    }

    function getSelectedSuperVolunteerIds() {
      const sel = document.getElementById('superTimeVolunteerSelect');
      if (!sel || sel.disabled || !sel.value) return [];
      const val = Number(sel.value);
      return Number.isFinite(val) ? [val] : [];
    }

    async function populateAdminTimeVolunteerSelect() {
      const sel = document.getElementById('adminTimeVolunteerSelect');
      const hint = document.getElementById('adminTimeVolunteerHint');
      if (!sel) return;
      if (role !== 'admin') {
        sel.innerHTML = '';
        sel.disabled = true;
        if (hint) hint.textContent = '';
        return;
      }
      let targetGroupId = null;
      targetGroupId = groupId != null ? String(groupId) : '';
      if (!targetGroupId) {
        sel.innerHTML = '<option value="">Organization required.</option>';
        sel.disabled = true;
        if (hint) hint.textContent = 'Organization context missing.';
        return;
      }
      const previousSelection = new Set(getSelectedAdminVolunteerIds().map(id => String(id)));
      sel.disabled = true;
      sel.innerHTML = '<option value="">Loading volunteers…</option>';
      const volunteers = await fetchVolunteers(targetGroupId);
      sel.innerHTML = '';
      if (!volunteers || volunteers.length === 0) {
        sel.innerHTML = '<option value="">No volunteers found.</option>';
        sel.disabled = true;
        if (hint) hint.textContent = 'No volunteers found for this organization.';
        return;
      }
      sel.disabled = false;
      volunteers.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name ? `${v.name}` : v.email;
        if (previousSelection.has(String(v.id))) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.dataset.groupId = String(targetGroupId);
      if (!sel._wired) {
        sel.addEventListener('change', () => {
          if (hint) hint.textContent = '';
          fetchAdminTimes();
        });
        sel._wired = true;
      }
      if (hint) hint.textContent = 'Hold Cmd/Ctrl (or Shift) to select multiple volunteers.';
      await fetchAdminTimes();
    }

    async function populateSuperTimeVolunteerSelect() {
      const sel = document.getElementById('superTimeVolunteerSelect');
      const hint = document.getElementById('superTimeVolunteerHint');
      if (!sel) return;
      if (role !== 'superadmin') {
        sel.innerHTML = '';
        sel.disabled = true;
        if (hint) hint.textContent = '';
        return;
      }
      const orgPicker = document.getElementById('superadminOrgPicker');
      const gid = orgPicker?.value;
      if (!gid) {
        sel.innerHTML = '<option value="">Select an organization above.</option>';
        sel.disabled = true;
        if (hint) hint.textContent = 'Select an organization to load volunteers.';
        return;
      }
      const previousSelection = sel.value ? String(sel.value) : '';
      sel.disabled = true;
      sel.innerHTML = '<option value="">Loading volunteers…</option>';
      const volunteers = await fetchVolunteers(gid);
      sel.innerHTML = '<option value="">— Select volunteer —</option>';
      if (!volunteers || volunteers.length === 0) {
        sel.innerHTML = '<option value="">No volunteers found.</option>';
        sel.disabled = true;
        if (hint) hint.textContent = 'No volunteers found for this organization.';
        return;
      }
      sel.disabled = false;
      volunteers.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name ? `${v.name}` : v.email;
        if (previousSelection && String(v.id) === previousSelection) opt.selected = true;
        sel.appendChild(opt);
      });
      if (!sel._wired) {
        sel.addEventListener('change', () => {
          if (hint) hint.textContent = '';
          fetchAdminTimes();
        });
        sel._wired = true;
      }
      if (hint) hint.textContent = 'Select a volunteer to view logs.';
      await fetchAdminTimes();
    }

    function showCalendarStatus(message = '', isError = false) {
      const el = document.getElementById('calendarStatus');
      if (!el) return;
      const hasMessage = Boolean(message);
      calendarState.lastStatusIsError = hasMessage && Boolean(isError);
      el.textContent = message || '';
      if (!hasMessage) {
        el.classList.remove('error');
        el.classList.add('hint');
      } else {
        el.classList.toggle('error', Boolean(isError));
        if (!isError) {
          el.classList.add('hint');
        } else {
          el.classList.remove('hint');
        }
      }
    }

    function isCalendarVisible() {
      const section = document.getElementById('calendarSection');
      return Boolean(section && !section.classList.contains('hidden'));
    }

    async function refreshCalendarIfVisible(options = {}) {
      if (isCalendarVisible()) {
        await refreshCalendarEvents(options);
      } else {
        calendarState.needsRefresh = true;
      }
    }

    function formatDateKeyToReadable(key) {
      if (!key) return '';
      const [year, month, day] = key.split('-').map(Number);
      if (!year || !month || !day) return key;
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString(undefined, {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function extractDatePart(value) {
      if (!value) return '';
      if (value instanceof Date) {
        return `${value.getUTCFullYear()}-${pad2(value.getUTCMonth() + 1)}-${pad2(value.getUTCDate())}`;
      }
      const str = String(value).trim();
      const match = str.match(/^(\d{4}-\d{2}-\d{2})/);
      if (match && match[1]) return match[1];
      try {
        const date = new Date(str);
        if (!Number.isNaN(date.getTime())) {
          return `${date.getUTCFullYear()}-${pad2(date.getUTCMonth() + 1)}-${pad2(date.getUTCDate())}`;
        }
      } catch {}
      return '';
    }

    function parseEventDateValue(value) {
      const datePart = extractDatePart(value);
      if (!datePart) return null;
      const iso = `${datePart}T00:00:00Z`;
      const date = new Date(iso);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatTime12(value) {
      if (!value) return '';
      const parts = String(value).split(':');
      const hour = Number(parts[0]);
      const minute = Number(parts[1]);
      if (Number.isNaN(hour)) return value;
      const suffix = hour >= 12 ? 'PM' : 'AM';
      const normalizedHour = (hour % 12) || 12;
      const minuteStr = Number.isNaN(minute) ? '00' : String(minute).padStart(2, '0');
      return `${normalizedHour}:${minuteStr} ${suffix}`;
    }

    function hashString(str = '') {
      let hash = 0;
      for (let i = 0; i < str.length; i += 1) {
        hash = (hash * 31 + str.charCodeAt(i)) | 0;
      }
      return Math.abs(hash);
    }

    function normalizeHexColor(value) {
      if (typeof value !== 'string') return null;
      const trimmed = value.trim();
      if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(trimmed)) return null;
      if (trimmed.length === 4) {
        return '#' + trimmed.slice(1).split('').map(ch => ch + ch).join('').toLowerCase();
      }
      return trimmed.toLowerCase();
    }

    function getEventColor(event) {
      if (!event) return null;
      const explicit = normalizeHexColor(event.color_hex);
      if (explicit) return explicit;
      const palette = CALENDAR_EVENT_COLORS;
      if (!Array.isArray(palette) || palette.length === 0) return null;
      const key = event.group_id != null ? `g-${event.group_id}` : `e-${event.id ?? 0}`;
      const idx = hashString(String(key)) % palette.length;
      return palette[idx];
    }

    function hexToRgba(hex, alpha = 0.2) {
      if (typeof hex !== 'string' || !hex.startsWith('#')) return `rgba(53,177,251,${alpha})`;
      let normalized = hex.replace('#', '');
      if (normalized.length === 3) {
        normalized = normalized.split('').map(ch => ch + ch).join('');
      }
      const value = Number.parseInt(normalized, 16);
      if (Number.isNaN(value)) return `rgba(53,177,251,${alpha})`;
      const r = (value >> 16) & 255;
      const g = (value >> 8) & 255;
      const b = value & 255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function getCalendarScheduleGroupId() {
      if (role === 'superadmin') {
        const sel = document.getElementById('calendarGroupFilter');
        return sel && sel.value ? Number(sel.value) : null;
      }
      return groupId != null ? Number(groupId) : null;
    }

    function hideCalendarDaySchedule() {
      const wrap = document.getElementById('calendarDaySchedule');
      const body = document.getElementById('calendarDayScheduleBody');
      if (wrap) wrap.classList.add('hidden');
      if (body) body.innerHTML = '<div class="hint">Select a day to view volunteer assignments.</div>';
      calendarState.activeDateKey = null;
    }

    function clearCalendarSchedule(options = {}) {
      calendarState.scheduleCache = {};
      if (options.hide) hideCalendarDaySchedule();
    }

    function setCalendarScheduleLoading(isLoading) {
      if (!isLoading) return;
      const body = document.getElementById('calendarDayScheduleBody');
      if (body) body.innerHTML = '<div class="hint">Loading volunteers…</div>';
    }

    function formatScheduleTimeRange(startIso, endIso, tz, fallbackDate) {
      if (!startIso && !endIso) return fallbackDate || 'Time TBD';
      try {
        const fmt = new Intl.DateTimeFormat(undefined, {
          timeZone: tz || activeTimeZone,
          hour: 'numeric',
          minute: '2-digit'
        });
        const startLabel = startIso ? fmt.format(new Date(startIso)) : null;
        const endLabel = endIso ? fmt.format(new Date(endIso)) : null;
        if (startLabel && endLabel) return `${startLabel} – ${endLabel}`;
        return startLabel || endLabel || fallbackDate || 'Time TBD';
      } catch {
        return fallbackDate || 'Time TBD';
      }
    }

    function getDutyColor(dutyLike) {
      const colorHex = normalizeHexColor(typeof dutyLike === 'string' ? dutyLike : dutyLike?.color_hex);
      if (colorHex) return colorHex;
      const id = (typeof dutyLike === 'object' && dutyLike) ? dutyLike.id : dutyLike;
      if (!Number.isFinite(Number(id))) return null;
      const palette = ['#4F46E5','#DB2777','#059669','#D97706','#2563EB','#7C3AED','#0EA5E9','#EF4444','#10B981','#F59E0B'];
      const idx = Math.abs(Number(id)) % palette.length;
      return palette[idx];
    }

    function ensureDutyColorPreview(anchorId, previewId) {
      const anchor = document.getElementById(anchorId);
      if (!anchor) return null;
      let box = document.getElementById(previewId);
      if (!box) {
        box = document.createElement('div');
        box.id = previewId;
        box.className = 'duty-color-preview hint';
        box.style.display = 'flex';
        box.style.alignItems = 'center';
        box.style.gap = '6px';
        box.style.marginTop = '6px';
        anchor.insertAdjacentElement('afterend', box);
      }
      return box;
    }

    function renderDutyColorPreview(previewId, dutyInput) {
      const el = document.getElementById(previewId);
      if (!el) return;
      const direct = normalizeHexColor(typeof dutyInput === 'string' ? dutyInput : null);
      const color = direct || getDutyColor(dutyInput);
      if (color) {
        el.innerHTML = `<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${color};"></span><span>${color}</span>`;
        el.classList.remove('hidden');
      } else {
        el.innerHTML = '';
        el.classList.add('hidden');
      }
    }

    function buildScheduleAssignmentHtml(assign, color, tz) {
      const timeLabel = formatScheduleTimeRange(assign.start_time, assign.end_time, tz, assign.duty_date);
      const styleParts = [];
      if (color) {
        styleParts.push(`border-left-color:${color}`);
        styleParts.push(`background:${hexToRgba(color, 0.18)}`);
      }
      const styleAttr = styleParts.length ? ` style="${styleParts.join(';')}"` : '';
      const youLabel = (assign.volunteer_id != null && assign.volunteer_id === userId) ? ' (You)' : '';
      return `<div class="calendar-schedule-assignment"${styleAttr}>
        <div class="calendar-schedule-assignment-name">${assign.volunteer_name || 'Volunteer'}${youLabel}</div>
        <div class="calendar-schedule-assignment-time">${timeLabel}</div>
      </div>`;
    }

    function buildScheduleDutyHtml(dutyEntry, eventColor, tz) {
      const assignments = Array.isArray(dutyEntry.assignments) ? dutyEntry.assignments : [];
      const dutyColor = getDutyColor(dutyEntry) || eventColor;
      const assignmentsHtml = assignments.length
        ? assignments.map(assign => buildScheduleAssignmentHtml(assign, dutyColor, tz)).join('')
        : '<div class="calendar-day-schedule-empty">No volunteers assigned.</div>';
      const locationRow = dutyEntry.location ? `<div class="calendar-schedule-duty-location">${dutyEntry.location}</div>` : '';
      return `<div class="calendar-schedule-duty">
        <h4>${dutyEntry.title || 'Duty'}</h4>
        ${locationRow}
        ${assignmentsHtml}
      </div>`;
    }

    function buildScheduleColumnHtml(eventEntry, focusEventId) {
      const firstDutyId = eventEntry?.duties?.[0]?.id;
      const color = getEventColor({
        id: eventEntry.event_id || (firstDutyId ? `duty-${firstDutyId}` : undefined),
        group_id: eventEntry.group_id,
        color_hex: eventEntry.color_hex
      });
      const columnClasses = ['calendar-schedule-column'];
      if (focusEventId && eventEntry.event_id && Number(eventEntry.event_id) === Number(focusEventId)) {
        columnClasses.push('is-focused');
      }
      const orgName = (eventEntry.group_id != null && groupNameById[eventEntry.group_id])
        ? groupNameById[eventEntry.group_id]
        : null;
      const tz = getGroupTimeZone(eventEntry.group_id);
      const duties = Array.isArray(eventEntry.duties) ? eventEntry.duties : [];
      const allAssignments = duties.flatMap(d => Array.isArray(d.assignments) ? d.assignments : []);
      const totalHours = allAssignments.reduce((sum, a) => sum + (Number(a?.duration_hours) || 0), 0);
      const dutiesHtml = duties.length
        ? duties.map(duty => buildScheduleDutyHtml(duty, color, tz)).join('')
        : '<div class="calendar-day-schedule-empty">No duties scheduled.</div>';
      const metaLabel = orgName || eventEntry.address || '';
      const metaHtml = metaLabel ? `<span>${metaLabel}</span>` : '';
      const hoursHtml = totalHours > 0 ? `<div class="calendar-schedule-hours">Hours logged: ${totalHours.toFixed(2)}</div>` : '';
      const headerStyle = color ? ` style="border-left-color:${color}"` : '';
      return `<div class="${columnClasses.join(' ')}">
        <div class="calendar-schedule-column-header"${headerStyle}>
          <div>${eventEntry.event_title || eventEntry.title || 'Event'}</div>
          ${metaHtml}
          ${hoursHtml}
        </div>
        ${dutiesHtml}
      </div>`;
    }

    function renderCalendarDaySchedule(dateKey) {
      const wrap = document.getElementById('calendarDaySchedule');
      const body = document.getElementById('calendarDayScheduleBody');
      const title = document.getElementById('calendarDayScheduleTitle');
      const meta = document.getElementById('calendarDayScheduleMeta');
      if (!wrap || !body) return;
      wrap.classList.remove('hidden');
      if (title) title.textContent = formatDateKeyToReadable(dateKey) || 'Selected Day';
      if (meta) {
        meta.textContent = role === 'volunteer'
          ? 'Showing your scheduled duties.'
          : 'Showing scheduled volunteers for this day.';
      }
      const data = calendarState.scheduleCache?.[dateKey];
      let events = Array.isArray(data?.events) ? data.events : [];
      const selectedEventId = calendarState.selectedEventId != null ? Number(calendarState.selectedEventId) : null;
      if (selectedEventId) {
        events = events.filter(ev => ev.event_id != null && Number(ev.event_id) === selectedEventId);
      }
      if (!events || events.length === 0) {
        body.innerHTML = '<div class="calendar-day-schedule-empty">No scheduled duties for this date.</div>';
        return;
      }
      const focusId = calendarState.scheduleFocusEventId || calendarState.selectedEventId || null;
      const columns = events.map(ev => buildScheduleColumnHtml(ev, focusId)).join('');
      body.innerHTML = `<div class="calendar-schedule-columns">${columns}</div>`;
    }

    async function loadCalendarDaySchedule(dateKey, options = {}) {
      const { force = false } = options || {};
      const effectiveForce = force || role === 'volunteer';
      const wrap = document.getElementById('calendarDaySchedule');
      const body = document.getElementById('calendarDayScheduleBody');
      const title = document.getElementById('calendarDayScheduleTitle');
      const meta = document.getElementById('calendarDayScheduleMeta');
      if (!wrap || !body) return;
      calendarState.activeDateKey = dateKey || null;
      wrap.classList.remove('hidden');
      if (title) title.textContent = formatDateKeyToReadable(dateKey) || 'Selected Day';
      if (meta) {
        meta.textContent = role === 'volunteer'
          ? 'Showing your scheduled duties.'
          : 'Showing scheduled volunteers for this day.';
      }
      if (!dateKey) {
        body.innerHTML = '<div class="hint">Select a day to view volunteer assignments.</div>';
        return;
      }
      const groupFilter = getCalendarScheduleGroupId();
      if (role === 'superadmin' && !groupFilter) {
        body.innerHTML = '<div class="hint">Select an organization above to view volunteers.</div>';
        return;
      }
      if (!effectiveForce && calendarState.scheduleCache?.[dateKey]) {
        renderCalendarDaySchedule(dateKey);
        return;
      }
      setCalendarScheduleLoading(true);
      try {
        const params = new URLSearchParams({ date: dateKey });
        if (role === 'superadmin' && groupFilter) params.set('group_id', groupFilter);
        const res = await authed(`/calendar/assignments?${params.toString()}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Failed to load schedule');
        if (role === 'volunteer') {
          const dayEvents = (calendarState.eventsByDate || {})[dateKey] || [];
          const merged = [];
          const seen = new Set();
          (Array.isArray(data.events) ? data.events : []).forEach(ev => {
            const key = ev.event_id != null ? String(ev.event_id) : `evt-${merged.length}`;
            seen.add(key);
            merged.push(ev);
          });
          dayEvents.forEach(ev => {
            const key = ev.id != null ? String(ev.id) : '';
            if (key && !seen.has(key)) {
              merged.push({
                event_id: ev.id,
                event_title: ev.title || 'Event',
                group_id: ev.group_id,
                color_hex: ev.color_hex,
                duties: []
              });
            }
          });
          data.events = merged;
        }
        calendarState.scheduleCache[dateKey] = data;
        renderCalendarDaySchedule(dateKey);
      } catch (err) {
        body.innerHTML = `<div class="error">${err?.message || 'Failed to load schedule.'}</div>`;
      }
    }

    function invalidateCalendarSchedule(dateKey, options = {}) {
      const { refresh = false } = options || {};
      if (!calendarState.scheduleCache) calendarState.scheduleCache = {};
      if (dateKey) {
        delete calendarState.scheduleCache[dateKey];
        if (refresh && calendarState.activeDateKey === dateKey) {
          loadCalendarDaySchedule(dateKey, { force: true });
        }
      } else {
        calendarState.scheduleCache = {};
      }
    }

    function applyEventColorStyles(el, event) {
      if (!el) return;
      const color = getEventColor(event);
      if (!color) return;
      el.style.borderColor = color;
      el.style.background = hexToRgba(color, 0.18);
    }

    function setCalendarColorInput(event) {
      const colorInput = document.getElementById('calendarEditColor');
      const clearBtn = document.getElementById('calendarClearColorBtn');
      if (!colorInput) return;
      const existing = normalizeHexColor(event?.color_hex);
      if (existing) {
        colorInput.value = existing;
        colorInput.dataset.cleared = 'false';
        if (clearBtn) clearBtn.disabled = false;
      } else {
        colorInput.value = '#118ab2';
        colorInput.dataset.cleared = 'true';
        if (clearBtn) clearBtn.disabled = false;
      }
    }

    function readCalendarColorInput() {
      const colorInput = document.getElementById('calendarEditColor');
      if (!colorInput) return null;
      if (colorInput.dataset.cleared === 'true') return null;
      return normalizeHexColor(colorInput.value) || null;
    }

    function getEventSortTimestamp(event) {
      const datePart = extractDatePart(event.start_date || event.event_date);
      if (!datePart) return 0;
      const time = (event.start_time || '00:00').slice(0, 5) || '00:00';
      const iso = `${datePart}T${time || '00:00'}Z`;
      const value = Date.parse(iso);
      return Number.isNaN(value) ? 0 : value;
    }

    function showCalendarDayEvents(dateKey) {
      const summary = document.getElementById('calendarEventSummary');
      const panel = document.getElementById('calendarEventPanel');
      if (!summary || !panel) return;
      const events = calendarState.eventsByDate[dateKey] || [];
      panel.classList.remove('hidden');
      calendarState.selectedEventId = null;
      calendarState.scheduleFocusEventId = null;
      calendarState.activeDateKey = dateKey;
      loadCalendarDaySchedule(dateKey);
      summary.innerHTML = '';
      const header = document.createElement('div');
      header.innerHTML = `<strong>${formatDateKeyToReadable(dateKey) || 'Selected Day'}</strong>`;
      summary.appendChild(header);
      if (!events.length) {
        const empty = document.createElement('div');
        empty.textContent = 'No events scheduled for this day.';
        summary.appendChild(empty);
        const adminWrap = document.getElementById('calendarEventAdminWrap');
        if (adminWrap) adminWrap.classList.add('hidden');
        return;
      }
      const helper = document.createElement('div');
      helper.textContent = 'Select an event to view details:';
      summary.appendChild(helper);
      const list = document.createElement('div');
      list.className = 'calendar-day-event-picker';
      events
        .slice()
        .sort((a, b) => getEventSortTimestamp(a) - getEventSortTimestamp(b))
        .forEach(ev => {
          const btn = document.createElement('button');
          const parts = [];
          const startTime = formatTime12((ev.start_time || '').slice(0, 5));
          if (startTime) parts.push(startTime);
          parts.push(ev.title || `Event #${ev.id}`);
          if (role === 'superadmin' && ev.group_id != null) {
            const orgName = groupNameById[ev.group_id];
            if (orgName) parts.push(`(${orgName})`);
          }
          btn.textContent = parts.join(' ');
          applyEventColorStyles(btn, ev);
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            openCalendarEvent(ev.id);
          });
          list.appendChild(btn);
        });
      summary.appendChild(list);
      const adminWrap = document.getElementById('calendarEventAdminWrap');
      if (adminWrap) adminWrap.classList.add('hidden');
    }

    function resetCalendarView() {
      calendarState.selectedEventId = null;
      calendarState.scheduleFocusEventId = null;
      const panel = document.getElementById('calendarEventPanel');
      if (panel) panel.classList.add('hidden');
      const summary = document.getElementById('calendarEventSummary');
      if (summary) {
        summary.innerHTML = '';
        const placeholder = document.createElement('div');
        placeholder.textContent = 'Select an event to view details.';
        summary.appendChild(placeholder);
      }
      const err = document.getElementById('calendarEditError');
      if (err) err.textContent = '';
      hideCalendarDaySchedule();
    }

    function formatCalendarDateKey(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
      return `${date.getUTCFullYear()}-${pad2(date.getUTCMonth() + 1)}-${pad2(date.getUTCDate())}`;
    }

    function describeEventRange(event) {
      if (!event) return 'Date TBD';
      const startDate = extractDatePart(event.start_date || event.event_date);
      const endDate = extractDatePart(event.end_date || event.start_date || event.event_date);
      const startTime = formatTime12((event.start_time || '').slice(0, 5));
      const endTime = formatTime12((event.end_time || '').slice(0, 5));
      if (!startDate) return 'Date TBD';
      if (endDate && endDate !== startDate) {
        const first = `${startDate}${startTime ? ` ${startTime}` : ''}`.trim();
        const last = `${endDate}${endTime ? ` ${endTime}` : ''}`.trim();
        return `${first} – ${last}`.trim();
      }
      let label = startDate;
      if (startTime && endTime) label += ` ${startTime} – ${endTime}`;
      else if (startTime) label += ` ${startTime}`;
      return label;
    }

    function buildCalendarEventsByDay(events = []) {
      const map = {};
      events.forEach(ev => {
        const start = parseEventDateValue(ev.start_date || ev.event_date);
        if (!start) return;
        let end = parseEventDateValue(ev.end_date || ev.start_date || ev.event_date);
        if (!end || end < start) end = new Date(start);
        const cursor = new Date(start.getTime());
        while (cursor <= end) {
          const key = formatCalendarDateKey(cursor);
          if (!map[key]) map[key] = [];
          map[key].push(ev);
          cursor.setUTCDate(cursor.getUTCDate() + 1);
        }
      });
      return map;
    }

    function updateCalendarMonthLabel() {
      const label = document.getElementById('calendarMonthLabel');
      if (!label) return;
      const d = calendarState.currentMonth;
      label.textContent = d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
    }

    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      if (!grid) return;
      grid.innerHTML = '';
      updateCalendarMonthLabel();
      const monthRef = calendarState.currentMonth;
      const startOfMonth = new Date(monthRef.getFullYear(), monthRef.getMonth(), 1);
      const gridStart = new Date(startOfMonth);
      gridStart.setDate(startOfMonth.getDate() - startOfMonth.getDay());
      let hasEventsThisMonth = false;
      for (let i = 0; i < 42; i += 1) {
        const cellDate = new Date(gridStart);
        cellDate.setDate(gridStart.getDate() + i);
        const key = formatCalendarDateKey(cellDate);
        const dayEvents = calendarState.eventsByDate[key] || [];
        if (dayEvents.length && cellDate.getMonth() === monthRef.getMonth()) {
          hasEventsThisMonth = true;
        }
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        if (cellDate.getMonth() !== monthRef.getMonth()) cell.classList.add('calendar-day--muted');
        cell.dataset.dateKey = key;
        const number = document.createElement('div');
        number.className = 'calendar-day-number';
        number.textContent = cellDate.getDate();
        cell.appendChild(number);
        const list = document.createElement('div');
        list.className = 'calendar-events';
        dayEvents.slice(0, 3).forEach(ev => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'calendar-event';
          const pieces = [];
          const startTime = formatTime12((ev.start_time || '').slice(0, 5));
          if (startTime) pieces.push(startTime);
          pieces.push(ev.title || `Event #${ev.id}`);
          if (role === 'superadmin' && ev.group_id != null) {
            const gName = groupNameById[ev.group_id];
            if (gName) pieces.push(`(${gName})`);
          }
          btn.textContent = pieces.join(' ');
          applyEventColorStyles(btn, ev);
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            openCalendarEvent(ev.id);
          });
          list.appendChild(btn);
        });
        if (dayEvents.length > 3) {
          const more = document.createElement('div');
          more.className = 'calendar-more';
          more.textContent = `+${dayEvents.length - 3} more`;
          more.addEventListener('click', (event) => {
            event.stopPropagation();
            showCalendarDayEvents(key);
          });
          list.appendChild(more);
        }
        cell.appendChild(list);
        cell.addEventListener('click', (event) => {
          if (event.target.closest('.calendar-event')) return;
          if (event.target.classList && event.target.classList.contains('calendar-more')) return;
          if (dayEvents.length) {
            showCalendarDayEvents(key);
          } else {
            showCalendarStatus('No events scheduled for this day.');
          }
        });
        grid.appendChild(cell);
      }
      if (!calendarState.lastStatusIsError) {
        if (!calendarState.events.length) {
          showCalendarStatus('No events found for this organization.');
        } else if (!hasEventsThisMonth) {
          showCalendarStatus('No events scheduled for this month.');
        } else {
          showCalendarStatus('');
        }
      }
    }

    function getCalendarGroupFilterValue() {
      if (role === 'superadmin') {
        const sel = document.getElementById('calendarGroupFilter');
        return sel ? (sel.value || null) : null;
      }
      if (groupId != null) return String(groupId);
      return null;
    }

    async function fetchCalendarEventsData(filterValue) {
      let path = '/events';
      if (filterValue) {
        path = `/events?group_id=${encodeURIComponent(filterValue)}`;
      }
      const res = await authed(path);
      if (!res.ok) throw new Error('Failed to load calendar events');
      const events = await res.json();
      return Array.isArray(events) ? events : [];
    }

    async function refreshCalendarEvents(options = {}) {
      const { preserveSelectionId = null, skipReset = false } = options || {};
      if (!token) return;
      if (!skipReset) resetCalendarView();
      const filterValue = getCalendarGroupFilterValue();
      if (((role === 'admin' || role === 'volunteer') && !filterValue) ||
          (role === 'superadmin' && !filterValue)) {
        const message = role === 'superadmin'
          ? 'Select an organization above to view its calendar.'
          : 'You must belong to an organization to view its calendar.';
        showCalendarStatus(message, true);
        const grid = document.getElementById('calendarGrid');
        if (grid) grid.innerHTML = '';
        return;
      }
      try {
        showCalendarStatus('Loading…');
        const events = await fetchCalendarEventsData(filterValue);
        calendarState.events = events;
        calendarState.eventsByDate = buildCalendarEventsByDay(events);
        renderCalendar();
        calendarState.needsRefresh = false;
        if (preserveSelectionId) openCalendarEvent(preserveSelectionId);
      } catch {
        showCalendarStatus('Failed to load calendar events.', true);
        const grid = document.getElementById('calendarGrid');
        if (grid) grid.innerHTML = '';
      }
    }

    function populateCalendarEventSummary(event) {
      const summary = document.getElementById('calendarEventSummary');
      if (!summary) return;
      summary.innerHTML = '';
      const titleRow = document.createElement('div');
      const strong = document.createElement('strong');
      strong.textContent = event.title || 'Untitled Event';
      const color = getEventColor(event);
      if (color) {
        const swatch = document.createElement('span');
        swatch.style.display = 'inline-block';
        swatch.style.width = '12px';
        swatch.style.height = '12px';
        swatch.style.borderRadius = '50%';
        swatch.style.marginRight = '6px';
        swatch.style.background = color;
        titleRow.appendChild(swatch);
      }
      titleRow.appendChild(strong);
      const dateRow = document.createElement('div');
      dateRow.textContent = describeEventRange(event);
      let addressRow = null;
      if (event.address) {
        addressRow = document.createElement('div');
        addressRow.textContent = `Address: ${event.address}`;
      }
      const groupRow = document.createElement('div');
      const groupLabel = groupNameById[event.group_id] || (event.group_id ? `Group ${event.group_id}` : 'No organization specified');
      groupRow.textContent = `Organization: ${groupLabel}`;
      const descRow = document.createElement('div');
      descRow.textContent = event.description ? `Notes: ${event.description}` : 'Notes: None provided.';
      summary.appendChild(titleRow);
      summary.appendChild(dateRow);
      if (addressRow) summary.appendChild(addressRow);
      summary.appendChild(groupRow);
      summary.appendChild(descRow);
    }

    function populateCalendarEditGroupSelect(selectedId) {
      const sel = document.getElementById('calendarEditGroup');
      if (!sel) return;
      const entries = Object.entries(groupNameById || {});
      sel.innerHTML = '<option value="">— Select organization —</option>';
      entries
        .sort((a, b) => String(a[1]).localeCompare(String(b[1])))
        .forEach(([id, name]) => {
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = name;
          sel.appendChild(opt);
        });
      if (selectedId != null) sel.value = String(selectedId);
    }

    function openCalendarEvent(eventId) {
      const events = calendarState.events || [];
      const event = events.find(ev => Number(ev.id) === Number(eventId));
      if (!event) return;
      calendarState.selectedEventId = Number(event.id);
      const panel = document.getElementById('calendarEventPanel');
      if (panel) panel.classList.remove('hidden');
      populateCalendarEventSummary(event);
      const adminWrap = document.getElementById('calendarEventAdminWrap');
      const canEdit = role === 'admin' || role === 'superadmin';
      if (adminWrap) {
        adminWrap.classList.toggle('hidden', !canEdit);
        if (canEdit) {
          const titleInput = document.getElementById('calendarEditTitle');
          if (titleInput) titleInput.value = event.title || '';
          const descInput = document.getElementById('calendarEditDescription');
          if (descInput) descInput.value = event.description || '';
          const startDateInput = document.getElementById('calendarEditStartDate');
          if (startDateInput) startDateInput.value = extractDatePart(event.start_date || event.event_date) || '';
          const endDateInput = document.getElementById('calendarEditEndDate');
          if (endDateInput) endDateInput.value = extractDatePart(event.end_date || event.start_date || event.event_date) || '';
          const startTimeInput = document.getElementById('calendarEditStartTime');
          if (startTimeInput) startTimeInput.value = (event.start_time || '').slice(0, 5);
          const endTimeInput = document.getElementById('calendarEditEndTime');
          if (endTimeInput) endTimeInput.value = (event.end_time || '').slice(0, 5);
          const addressInput = document.getElementById('calendarEditAddress');
          if (addressInput) addressInput.value = event.address || '';
          const groupRow = document.getElementById('calendarEditGroupRow');
          if (groupRow) groupRow.classList.toggle('hidden', role !== 'superadmin');
          if (role === 'superadmin') populateCalendarEditGroupSelect(event.group_id);
          setCalendarColorInput(event);
        }
      }
      const err = document.getElementById('calendarEditError');
      if (err) err.textContent = '';
      calendarState.scheduleFocusEventId = Number(event.id) || null;
      if (calendarState.activeDateKey) {
        renderCalendarDaySchedule(calendarState.activeDateKey);
      } else {
        const inferredDate = extractDatePart(event.start_date || event.event_date);
        if (inferredDate) loadCalendarDaySchedule(inferredDate);
      }
    }

    async function saveCalendarEventEdits() {
      if (!(role === 'admin' || role === 'superadmin')) return;
      const eventId = calendarState.selectedEventId;
      if (!eventId) return;
      const err = document.getElementById('calendarEditError');
      if (err) err.textContent = '';
      const payload = {
        title: document.getElementById('calendarEditTitle')?.value.trim() || null,
        description: document.getElementById('calendarEditDescription')?.value.trim() || null,
        start_date: document.getElementById('calendarEditStartDate')?.value || null,
        end_date: document.getElementById('calendarEditEndDate')?.value || null,
        start_time: document.getElementById('calendarEditStartTime')?.value || null,
        end_time: document.getElementById('calendarEditEndTime')?.value || null,
        address: document.getElementById('calendarEditAddress')?.value.trim() || null,
        color_hex: readCalendarColorInput(),
      };
      if (role === 'superadmin') {
        payload.group_id = document.getElementById('calendarEditGroup')?.value || null;
      }
      try {
        const res = await authed(`/events/${eventId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          if (err) err.textContent = data.message || 'Failed to save event';
          return;
        }
        showActionStatus('Event updated.');
        await refreshCalendarEvents({ preserveSelectionId: eventId, skipReset: true });
        openCalendarEvent(eventId);
      } catch {
        if (err) err.textContent = 'Error saving event';
      }
    }

    async function archiveCalendarEvent() {
      if (!(role === 'admin' || role === 'superadmin')) return;
      const eventId = calendarState.selectedEventId;
      if (!eventId) return;
      const err = document.getElementById('calendarEditError');
      if (err) err.textContent = '';
      try {
        const res = await authed(`/events/${eventId}/archive`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          if (err) err.textContent = data.message || 'Failed to archive event';
          return;
        }
        showActionStatus('Event archived.');
        await refreshCalendarEvents();
      } catch {
        if (err) err.textContent = 'Error archiving event';
      }
    }

    async function deleteCalendarEvent() {
      if (!(role === 'admin' || role === 'superadmin')) return;
      const eventId = calendarState.selectedEventId;
      if (!eventId) return;
      if (!confirm('Delete this event? This cannot be undone.')) return;
      const err = document.getElementById('calendarEditError');
      if (err) err.textContent = '';
      try {
        const res = await authed(`/events/${eventId}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          if (err) err.textContent = data.message || 'Failed to delete event';
          return;
        }
        showActionStatus('Event deleted.');
        await refreshCalendarEvents();
      } catch {
        if (err) err.textContent = 'Error deleting event';
      }
    }

    function shiftCalendarMonth(delta) {
      const base = calendarState.currentMonth;
      calendarState.currentMonth = new Date(base.getFullYear(), base.getMonth() + delta, 1);
      renderCalendar();
    }

    function prepareCalendarSection() {
      const prevBtn = document.getElementById('calendarPrevMonth');
      if (prevBtn && !prevBtn._wired) {
        prevBtn.addEventListener('click', () => shiftCalendarMonth(-1));
        prevBtn._wired = true;
      }
      const nextBtn = document.getElementById('calendarNextMonth');
      if (nextBtn && !nextBtn._wired) {
        nextBtn.addEventListener('click', () => shiftCalendarMonth(1));
        nextBtn._wired = true;
      }
      const groupSel = document.getElementById('calendarGroupFilter');
      if (groupSel && !groupSel._wired) {
        groupSel.addEventListener('change', () => {
          if (role !== 'superadmin') return;
          clearCalendarSchedule({ hide: true });
          refreshCalendarEvents();
        });
        groupSel._wired = true;
      }
      const colorInput = document.getElementById('calendarEditColor');
      if (colorInput && !colorInput._wired) {
        colorInput.addEventListener('input', () => {
          colorInput.dataset.cleared = 'false';
        });
        colorInput._wired = true;
      }
      const clearColorBtn = document.getElementById('calendarClearColorBtn');
      if (clearColorBtn && !clearColorBtn._wired) {
        clearColorBtn.addEventListener('click', () => {
          const input = document.getElementById('calendarEditColor');
          if (!input) return;
          input.dataset.cleared = 'true';
          input.value = '#118ab2';
        });
        clearColorBtn._wired = true;
      }
      const saveBtn = document.getElementById('calendarSaveEventBtn');
      if (saveBtn && !saveBtn._wired) {
        saveBtn.addEventListener('click', saveCalendarEventEdits);
        saveBtn._wired = true;
      }
      const archiveBtn = document.getElementById('calendarArchiveEventBtn');
      if (archiveBtn && !archiveBtn._wired) {
        archiveBtn.addEventListener('click', archiveCalendarEvent);
        archiveBtn._wired = true;
      }
      const deleteBtn = document.getElementById('calendarDeleteEventBtn');
      if (deleteBtn && !deleteBtn._wired) {
        deleteBtn.addEventListener('click', deleteCalendarEvent);
        deleteBtn._wired = true;
      }
      const scheduleRefreshBtn = document.getElementById('calendarDayScheduleRefresh');
      if (scheduleRefreshBtn && !scheduleRefreshBtn._wired) {
        scheduleRefreshBtn.addEventListener('click', () => {
          if (calendarState.scheduleCache && calendarState.activeDateKey) {
            delete calendarState.scheduleCache[calendarState.activeDateKey];
          }
          if (calendarState.activeDateKey) {
            loadCalendarDaySchedule(calendarState.activeDateKey, { force: true });
          } else {
            loadCalendarDaySchedule(null, { force: true });
          }
        });
        scheduleRefreshBtn._wired = true;
      }
      renderCalendar();
    }
    async function prepareDutyRestrictionUI(dutyId) {
      const wrap = document.getElementById('dutyRestrictionsWrap');
      if (!wrap || !dutyId || (role !== 'admin' && role !== 'superadmin')) {
        clearDutyRestrictionUI();
        return;
      }
      dutyRestrictionState.currentDutyId = dutyId;
      wrap.classList.remove('hidden');
      setDutyRestrictionStatus('');
      await populateDutyRestrictionVolunteerSelect(dutyId);
      await loadDutyRestrictions(dutyId);
    }
    async function populateDutyRestrictionVolunteerSelect(dutyId) {
      const sel = document.getElementById('dutyRestrictionVolunteer');
      if (!sel) return;
      sel.innerHTML = '<option value="">— Select volunteer —</option>';
      const duty = (window.dutyById || {})[dutyId];
      const dutyGroup = duty?.group_id ?? groupId ?? null;
      if (!dutyGroup) { sel.disabled = true; return; }
      let list = dutyRestrictionVolunteerCache[dutyGroup];
      if (!list || list.length === 0) {
        list = await fetchVolunteers(dutyGroup) || [];
        dutyRestrictionVolunteerCache[dutyGroup] = list;
      }
      sel.disabled = false;
      const options = Array.isArray(list) ? list : [];
      if (options.length === 0) {
        sel.innerHTML = '<option value="">No volunteers found for this organization</option>';
        sel.disabled = true;
        return;
      }
      options.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name ? `${v.name} (${v.email || v.id})` : (v.email || `Volunteer #${v.id}`);
          sel.appendChild(opt);
        });
    }
    async function loadDutyRestrictions(dutyId) {
      const listEl = document.getElementById('dutyRestrictionList');
      if (!listEl) return;
      listEl.innerHTML = '<li class="hint">Loading…</li>';
      try {
        const res = await authed(`/duties/${dutyId}/restrictions`);
        if (!res.ok) throw new Error('failed');
        const rows = await res.json();
        renderDutyRestrictionList(rows, dutyId);
      } catch (e) {
        listEl.innerHTML = '';
        setDutyRestrictionStatus('Failed to load restrictions', true);
      }
    }
    function renderDutyRestrictionList(list, dutyId) {
      const listEl = document.getElementById('dutyRestrictionList');
      if (!listEl) return;
      listEl.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        const li = document.createElement('li');
        li.className = 'hint';
        li.textContent = 'No restricted volunteers.';
        listEl.appendChild(li);
        return;
      }
      list.forEach(vol => {
        const li = document.createElement('li');
        const label = vol.name || vol.email || `Volunteer #${vol.id}`;
        li.innerHTML = `${label} <button type="button" data-vid="${vol.id}" class="dutyUnrestrictBtn" style="margin-left:8px">Allow</button>`;
        listEl.appendChild(li);
      });
      listEl.querySelectorAll('.dutyUnrestrictBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
        const volunteerId = Number(ev.currentTarget.getAttribute('data-vid'));
        const currentDutyId = dutyId || dutyRestrictionState.currentDutyId;
        if (!currentDutyId || !volunteerId) return;
        setDutyRestrictionStatus('');
        try {
          const res = await authed(`/duties/${currentDutyId}/restrictions/${volunteerId}`, { method: 'DELETE' });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            setDutyRestrictionStatus(data.message || 'Failed to remove restriction', true);
            return;
          }
          await loadDutyRestrictions(currentDutyId);
          setDutyRestrictionStatus('Volunteer allowed.');
        } catch {
          setDutyRestrictionStatus('Error removing restriction', true);
        }
      }));
    }
    function applyBranding(branding) {
      if (!defaultBranding) return;
      currentOrgBranding = branding || null;
      const theme = Object.assign({}, defaultBranding, branding || {});
      const root = document.documentElement;
      root.style.setProperty('--primary', theme.primary_color || defaultBranding.primary_color);
      root.style.setProperty('--text', theme.text_color || defaultBranding.text_color);
      root.style.setProperty('--accent1', theme.accent1 || defaultBranding.accent1);
      root.style.setProperty('--accent2', theme.accent2 || defaultBranding.accent2);
      root.style.setProperty('--accent3', theme.accent3 || defaultBranding.accent3);
      root.style.setProperty('--accent4', theme.accent4 || defaultBranding.accent4);
      root.style.setProperty('--accent5', theme.accent5 || defaultBranding.accent5);
      const bannerImage = (branding && branding.banner_url) || defaultBranding.banner_url || DEFAULT_HEADER_IMAGE;
      root.style.setProperty('--header-bg-image', `url('${bannerImage}')`);
      const heroImage = (branding && branding.hero_url) || defaultBranding.hero_image || DEFAULT_HERO_IMAGE;
      const heroEl = document.getElementById('homeHero');
      if (heroEl) heroEl.src = heroImage;
      const footerImage = (branding && branding.footer_url) || defaultBranding.footer_url || DEFAULT_FOOTER_IMAGE;
      root.style.setProperty('--footer-bg-image', `url('${footerImage}')`);
      const logoUrl = (branding && branding.logo_url) || defaultBranding.logo_url || DEFAULT_LOGO_URL;
      const logoEl = document.getElementById('logo');
      const logoLink = document.getElementById('logoLink');
      if (logoEl && logoUrl) {
        logoEl.src = logoUrl;
        logoEl.classList.remove('hidden');
      } else if (logoEl) {
        logoEl.classList.add('hidden');
      }
      if (logoLink && logoUrl) logoLink.href = logoUrl;
    }
    async function loadBrandingForCurrentGroup(options = {}) {
      const { populateForm = false } = options;
      if (!token || !groupId) {
        applyBranding(null);
        if (populateForm && role === 'admin') populateBrandingForm(null);
        return;
      }
      try {
        const res = await authed('/branding');
        if (!res.ok) throw new Error('failed');
        const data = await res.json();
        applyBranding(data.branding || null);
        if (populateForm && role === 'admin') populateBrandingForm(data.branding || null);
      } catch {
        applyBranding(null);
        if (populateForm && role === 'admin') populateBrandingForm(null);
      }
    }
    function populateBrandingForm(branding) {
      if (role !== 'admin') return;
      const assign = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value || '';
      };
      const assignColor = (id, value, fallback) => {
        const el = document.getElementById(id);
        if (el) el.value = value || fallback;
      };
      assign('brandingLogoUrl', branding?.logo_url || '');
      assign('brandingBannerUrl', branding?.banner_url || '');
      assign('brandingHeroUrl', branding?.hero_url || '');
      assign('brandingFooterUrl', branding?.footer_url || '');
      assignColor('brandingPrimaryColor', branding?.primary_color, defaultBranding.primary_color || '#000000');
      assignColor('brandingTextColor', branding?.text_color, defaultBranding.text_color || '#ffffff');
      assignColor('brandingAccent1', branding?.accent1, defaultBranding.accent1 || '#35b1fb');
      assignColor('brandingAccent2', branding?.accent2, defaultBranding.accent2 || '#0289db');
      assignColor('brandingAccent3', branding?.accent3, defaultBranding.accent3 || '#054a74');
      assignColor('brandingAccent4', branding?.accent4, defaultBranding.accent4 || '#00433a');
      assignColor('brandingAccent5', branding?.accent5, defaultBranding.accent5 || '#ffffff');
      setBrandingStatus('');
    }
    function collectBrandingFormValues() {
      const clean = (id) => document.getElementById(id)?.value?.trim() || '';
      const colorVal = (id) => document.getElementById(id)?.value || null;
      return {
        logo_url: clean('brandingLogoUrl') || null,
        banner_url: clean('brandingBannerUrl') || null,
        hero_url: clean('brandingHeroUrl') || null,
        footer_url: clean('brandingFooterUrl') || null,
        primary_color: colorVal('brandingPrimaryColor'),
        text_color: colorVal('brandingTextColor'),
        accent1: colorVal('brandingAccent1'),
        accent2: colorVal('brandingAccent2'),
        accent3: colorVal('brandingAccent3'),
        accent4: colorVal('brandingAccent4'),
        accent5: colorVal('brandingAccent5'),
      };
    }
    function setBrandingStatus(message = '', isError = false) {
      const statusEl = document.getElementById('brandingStatus');
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('hidden','error','ok');
      if (!message) {
        statusEl.classList.add('hidden');
        return;
      }
      statusEl.classList.add(isError ? 'error' : 'ok');
    }
    function wireBrandingFileInputs() {
      const pairs = [
        { inputId: 'brandingLogoFile', target: 'logo' },
        { inputId: 'brandingBannerFile', target: 'banner' },
        { inputId: 'brandingHeroFile', target: 'hero' },
        { inputId: 'brandingFooterFile', target: 'footer' },
      ];
      pairs.forEach(({ inputId, target }) => {
        const el = document.getElementById(inputId);
        if (!el || el._wired) return;
        el.addEventListener('change', async (event) => {
          const file = event.target?.files?.[0];
          if (!file) return;
          await handleBrandingFileUpload(target, file, event.target);
        });
        el._wired = true;
      });
    }
    async function handleBrandingFileUpload(target, file, inputEl) {
      if (!file) return;
      if (!groupId) {
        setBrandingStatus('You must belong to an organization to upload branding.', true);
        if (inputEl) inputEl.value = '';
        return;
      }
      try {
        setBrandingStatus(`Uploading ${target} image…`);
        const formData = new FormData();
        formData.append('target', target);
        formData.append('image', file);
        const res = await authed('/branding/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setBrandingStatus(data.message || 'Failed to upload image', true);
          return;
        }
        await loadBrandingForCurrentGroup({ populateForm: true });
        setBrandingStatus(`${target.charAt(0).toUpperCase() + target.slice(1)} image updated.`);
      } catch {
        setBrandingStatus('Error uploading image', true);
      } finally {
        if (inputEl) inputEl.value = '';
      }
    }
    populateTimeZoneSelect(document.getElementById('groupTimeZone'), DEFAULT_TIME_ZONE);

    // CONFIG/BRANDING
    async function fetchConfig() {
      try {
        const res = await fetch(`${apiUrl}/config`);
        if (!res.ok) return;
        const cfg = await res.json();
        if (cfg.appName) {
          document.title = cfg.appName;
          const titleEl = document.getElementById('appTitle');
          if (titleEl) titleEl.textContent = cfg.appName;
        }
        if (cfg.bgImageUrl) document.body.style.backgroundImage = `url('${cfg.bgImageUrl}')`;
        defaultBranding = Object.assign({}, defaultBranding, {
          primary_color: cfg.primaryColor || defaultBranding.primary_color,
          text_color: cfg.textColor || defaultBranding.text_color,
          accent1: cfg.accents && cfg.accents[0] ? cfg.accents[0] : defaultBranding.accent1,
          accent2: cfg.accents && cfg.accents[1] ? cfg.accents[1] : defaultBranding.accent2,
          accent3: cfg.accents && cfg.accents[2] ? cfg.accents[2] : defaultBranding.accent3,
          accent4: cfg.accents && cfg.accents[3] ? cfg.accents[3] : defaultBranding.accent4,
          accent5: cfg.accents && cfg.accents[4] ? cfg.accents[4] : defaultBranding.accent5,
          logo_url: cfg.logoUrl || defaultBranding.logo_url || DEFAULT_LOGO_URL,
          banner_url: cfg.bannerUrl || defaultBranding.banner_url || DEFAULT_HEADER_IMAGE,
          footer_url: cfg.footerUrl || defaultBranding.footer_url || DEFAULT_FOOTER_IMAGE,
        });
        applyBranding(currentOrgBranding);
      } catch { /* silent */ }
    }
    fetchConfig();

    // Try to restore session on page load
    (async function restoreSession() {
      try {
        const saved = localStorage.getItem('auth');
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (!parsed || !parsed.token) return;
        token = parsed.token;
        const res = await authed('/me');
        if (!res.ok) { try { localStorage.removeItem('auth'); } catch {} ; return; }
        const me = await res.json();
        await bootstrapAfterAuth({ token: parsed.token, role: me.role, group_id: me.group_id, id: me.id });
      } catch {}
    })();

    // (Per-user theming removed)
    // SUPERADMIN: Create User
    document.getElementById('createUserBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('newUserName')?.value?.trim() || undefined;
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const roleSel = document.getElementById('newUserRole');
      const roleVal = roleSel ? roleSel.value : 'volunteer';
      const grpSel = document.getElementById('newUserGroup');
      const gid = grpSel && grpSel.value ? Number(grpSel.value) : null;
      const errEl = document.getElementById('createUserError');
      errEl.textContent = '';
      try {
        if (!email || !password) { errEl.textContent = 'Email and password required'; return; }
        const res = await authed('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, role: roleVal, group_id: gid })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { errEl.textContent = data.message || 'Failed to create user'; return; }
        if (document.getElementById('newUserName')) document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        if (grpSel) grpSel.value = '';
        errEl.textContent = '';
        alert('User created.');
      } catch {
        errEl.textContent = 'Error creating user';
      }
    });

    // Admin tools: create specific roles
    async function createUserWith(roleVal, emailId, passId, groupSelId, errId, nameId) {
      const email = document.getElementById(emailId).value.trim();
      const password = document.getElementById(passId).value;
      const grpSel = document.getElementById(groupSelId);
      const gid = grpSel && grpSel.value ? Number(grpSel.value) : (groupId ?? null);
      const errEl = document.getElementById(errId);
      errEl.textContent = '';
      try {
        const name = nameId ? document.getElementById(nameId).value.trim() : undefined;
        if (!email || !password) { errEl.textContent = 'Email and password required'; return; }
        const res = await authed('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role: roleVal, group_id: gid, name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { errEl.textContent = data.message || 'Failed to create user'; return; }
        document.getElementById(emailId).value = '';
        document.getElementById(passId).value = '';
        if (grpSel) grpSel.value = '';
        if (nameId) document.getElementById(nameId).value = '';
        alert('User created.');
      } catch { errEl.textContent = 'Error creating user'; }
    }

    // Removed ability for admins to create superadmins
    document.getElementById('createAdminBtn')?.addEventListener('click', async () => {
      await createUserWith('admin', 'adminEmail', 'adminPassword', 'adminGroup', 'createAdminErr', 'adminName');
    });
    document.getElementById('createVolBtn')?.addEventListener('click', async () => {
      await createUserWith('volunteer', 'volEmail', 'volPassword', 'volGroup', 'createVolErr', 'volName');
    });
    // Volunteer Management: Create Volunteer
    document.getElementById('vmCreateVolBtn')?.addEventListener('click', async () => {
      await createUserWith('volunteer', 'vmVolEmail', 'vmVolPassword', 'vmVolGroup', 'vmCreateVolErr', 'vmVolName');
      await populateVolunteerMgmt();
    });

    // UTIL: fetch wrapper with auth
    async function authed(path, opts = {}) {
      const headers = Object.assign({}, opts.headers || {}, token ? { Authorization: `Bearer ${token}` } : {});
      const res = await fetch(`${apiUrl}${path}`, Object.assign({}, opts, { headers }));
      return res;
    }

    async function bootstrapAfterAuth(data) {
      token = data.token;
      role = data.role;
      groupId = data.group_id || null;
      userId = data.id;

      try {
        localStorage.setItem('auth', JSON.stringify({ token, role, group_id: groupId, id: userId }));
      } catch {}

      document.getElementById('role').textContent = role;
      document.getElementById('groupId').textContent = groupId ?? '-';
      if (groupId != null) document.getElementById('groupIdWrap').classList.remove('hidden');
      document.getElementById('userId').textContent = userId;

      hide('authSection');
      setupToolbar(role);
      navigateTo('homeSection');

      await loadMe();
      await fetchConfig();
      await loadBrandingForCurrentGroup({ populateForm: role === 'admin' });
      await fetchGroups();
      if (role === 'admin') {
        await populateAdminTimeVolunteerSelect();
      } else if (role === 'superadmin') {
        await populateSuperTimeVolunteerSelect();
      }
      await fetchEvents();
      await fetchDuties();
      await loadDutyTemplates();
      await fetchTimeTracking();
      await fetchApprovals();
      await fetchAdminTimes();
    }

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      document.getElementById('loginError').textContent = '';
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value
          })
        });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('loginError').textContent = data.message || 'Login failed';
          return;
        }
        await bootstrapAfterAuth(data);
      } catch (e) {
        document.getElementById('loginError').textContent = 'Error logging in';
      }
    });

    // SIGNUP
    async function fetchPublicGroups() {
      try {
        // Front-page signup should always use the public list so volunteers can choose before login
        const res = await fetch(`${apiUrl}/public/groups`);
        if (!res.ok) return;
        const groups = await res.json();
        window.signupGroups = groups || [];
        window.signupGroupMap = {};
        groups
          .sort((a,b) => String(a.name).localeCompare(String(b.name)))
          .forEach(g => {
            window.signupGroupMap[String(g.name).toLowerCase()] = g.id;
          });
        // Wire site-styled suggestions dropdown (keyboard + highlight)
        const input = document.getElementById('signupGroupInput');
        const sugg = document.getElementById('signupGroupSuggestions');
        // Lightweight predictive suggestions (no native datalist)
        if (input && sugg && !input._wiredPredict) {
          function highlight(name, q) {
            if (!q) return name;
            const idx = name.toLowerCase().indexOf(q);
            if (idx === -1) return name;
            return name.slice(0, idx) + '<mark>' + name.slice(idx, idx + q.length) + '</mark>' + name.slice(idx + q.length);
          }
          function selectByIndex(i) {
            const items = Array.from(sugg.children);
            if (i < 0 || i >= items.length) return;
            const val = items[i].getAttribute('data-value') || items[i].textContent;
            input.value = val;
            sugg.classList.add('hidden');
          }
          const render = () => {
            const q = (input.value || '').trim().toLowerCase();
            const all = window.signupGroups || [];
            let matches = [];
            if (q) {
              const starts = all.filter(g => String(g.name).toLowerCase().startsWith(q));
              const contains = all.filter(g => {
                const n = String(g.name).toLowerCase();
                return n.includes(q) && !n.startsWith(q);
              });
              matches = [...starts, ...contains].slice(0, 5);
            }
            sugg.innerHTML = '';
            if (matches.length === 0) { sugg.classList.add('hidden'); return; }
            input._selIndex = -1;
            matches.forEach((g, idx) => {
              const div = document.createElement('div');
              div.innerHTML = highlight(g.name, q);
              div.setAttribute('data-value', g.name);
              if (idx === input._selIndex) div.classList.add('active');
              sugg.appendChild(div);
            });
            sugg.classList.remove('hidden');
          };
          input.addEventListener('input', render);
          input.addEventListener('keydown', (ev) => {
            if (sugg.classList.contains('hidden')) return;
            const items = Array.from(sugg.children);
            if (ev.key === 'ArrowDown') {
              ev.preventDefault();
              input._selIndex = (typeof input._selIndex === 'number' ? input._selIndex : -1) + 1;
              if (input._selIndex >= items.length) input._selIndex = 0;
              items.forEach((el, i) => el.classList.toggle('active', i === input._selIndex));
              items[input._selIndex]?.scrollIntoView({ block: 'nearest' });
            } else if (ev.key === 'ArrowUp') {
              ev.preventDefault();
              input._selIndex = (typeof input._selIndex === 'number' ? input._selIndex : items.length) - 1;
              if (input._selIndex < 0) input._selIndex = items.length - 1;
              items.forEach((el, i) => el.classList.toggle('active', i === input._selIndex));
              items[input._selIndex]?.scrollIntoView({ block: 'nearest' });
            } else if (ev.key === 'Enter') {
              if (input._selIndex != null && input._selIndex >= 0 && input._selIndex < items.length) {
                ev.preventDefault();
                selectByIndex(input._selIndex);
              }
            } else if (ev.key === 'Escape') {
              sugg.classList.add('hidden');
            }
          });
          input.addEventListener('focus', () => {
            if (!window.signupGroups || window.signupGroups.length === 0) {
              // fetch, then render if user already typed something
              fetchPublicGroups().then(() => {
                if ((input.value || '').trim()) render();
              });
            }
          });
          input.addEventListener('blur', () => setTimeout(() => sugg.classList.add('hidden'), 120));
          sugg.addEventListener('mousedown', (e) => {
            const v = e.target && e.target.dataset && e.target.dataset.value;
            if (!v) return;
            input.value = v;
            sugg.classList.add('hidden');
          });
          input._wiredPredict = true;
        }
        // If the field is focused and has text when the groups finish loading, render immediately
        if (input === document.activeElement && (input.value || '').trim()) {
          const evt = new Event('input');
          input.dispatchEvent(evt);
        }
        // No custom dropdown; rely on native datalist with DB entries
      } catch {}
    }
    fetchPublicGroups();
    // Also refresh list on focus so the browser's native datalist shows DB-backed options
    document.getElementById('signupGroupInput')?.addEventListener('focus', () => {
      if (!window.signupGroups || window.signupGroups.length === 0) fetchPublicGroups();
    });
    document.getElementById('showSignupBtn').addEventListener('click', () => {
      const wrap = document.getElementById('signupWrap');
      wrap.classList.toggle('hidden');
      if (!window.signupGroups || window.signupGroups.length === 0) fetchPublicGroups();
    });

    document.getElementById('signupBtn').addEventListener('click', async () => {
      document.getElementById('signupError').textContent = '';
      try {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const phone = document.getElementById('signupPhone').value.trim();
        const orgInput = document.getElementById('signupGroupInput');
        let nameToId = window.signupGroupMap || {};
        const typed = (orgInput?.value || '').trim();
        let group_id = null;
        if (typed) {
          const key = typed.toLowerCase();
          if (nameToId && nameToId[key] != null) group_id = Number(nameToId[key]);
        }
        const response = await fetch(`${apiUrl}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, phone, group_id, group_name: typed })
        });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('signupError').textContent = data.message || 'Signup failed';
          return;
        }
        // Auto-login
        await bootstrapAfterAuth(data);
      } catch {
        document.getElementById('signupError').textContent = 'Error creating account';
      }
    });

    // LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
      token = null; role = null; groupId = null; userId = null;
      try { localStorage.removeItem('auth'); } catch {}
      // Hide app UI and show clean login/signup
      const tb = document.getElementById('toolbar'); if (tb) tb.classList.add('hidden');
      show('authSection');
    ['infoSection','superadminSection','adminSection','homeSection','createDutySection','clockSection','eventsSection']
        .forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); });
      // Clear login fields
      const le = document.getElementById('email'); if (le) le.value = '';
      const lp = document.getElementById('password'); if (lp) lp.value = '';
      // Reset signup UI
      const sw = document.getElementById('signupWrap'); if (sw) sw.classList.remove('hidden'); // keep visible state unchanged
      const sn = document.getElementById('signupName'); if (sn) sn.value = '';
      const se = document.getElementById('signupEmail'); if (se) se.value = '';
      const sp = document.getElementById('signupPassword'); if (sp) sp.value = '';
      const sg = document.getElementById('signupGroupInput'); if (sg) sg.value = '';
      const sphone = document.getElementById('signupPhone'); if (sphone) sphone.value = '';
      const sErr = document.getElementById('signupError'); if (sErr) sErr.textContent = '';
      const sOrgErr = document.getElementById('signupOrgError'); if (sOrgErr) sOrgErr.textContent = '';
      const sugg = document.getElementById('signupGroupSuggestions'); if (sugg) { sugg.classList.add('hidden'); sugg.innerHTML = ''; }
      clearDutyRestrictionUI();
      currentOrgBranding = null;
      applyBranding(null);
      setBrandingStatus('');
      const brandingWrap = document.getElementById('brandingSettings'); if (brandingWrap) brandingWrap.classList.add('hidden');
      try { window.signupGroups = window.signupGroups || []; } catch {}
      // Scroll to top
      try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch {}
      // Do a full reload to ensure a pristine login state
      try { setTimeout(() => { window.location.replace('/'); }, 0); } catch { try { window.location.reload(); } catch {} }
    });

    // GROUPS (front-end shows name; backend uses id)
    function populateCalendarGroupOptions(groups = []) {
      const sel = document.getElementById('calendarGroupFilter');
      if (!sel) return;
      const previous = sel.value;
      sel.innerHTML = '<option value="">All organizations</option>';
      groups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        sel.appendChild(opt);
      });
      if (previous && Array.from(sel.options).some(opt => opt.value === previous)) {
        sel.value = previous;
      }
    }

    async function fetchGroups() {
      try {
        const res = await authed('/groups');
        const groups = await res.json();

        // map id->name for display
        const nameById = {};
        groupTimeZoneById = {};
        groups.forEach(g => {
          nameById[g.id] = g.name;
          groupTimeZoneById[g.id] = g.time_zone || DEFAULT_TIME_ZONE;
        });
        groupNameById = Object.assign({}, nameById);
        if (groupId != null) {
          setActiveTimeZoneForGroup(groupId);
        }

        // show user-facing group name if we know their groupId
        const groupNameEl = document.getElementById('groupName');
        if (groupId != null && nameById[groupId]) {
          groupNameEl.textContent = nameById[groupId];
        } else {
          groupNameEl.textContent = '-';
        }
        refreshAccountTimeZoneDisplay();

        // superadmin/admin: populate org list and new-user/duty group selector(s)
        const tbody = document.getElementById('groupList');
        if (tbody) {
          tbody.innerHTML = '';
          groups.forEach(g => {
            const tr = document.createElement('tr');
            tr.innerHTML =
              `<td>${g.id}</td><td>${g.name}</td><td>${g.status ?? g.group_status ?? ''}</td><td>${g.time_zone || DEFAULT_TIME_ZONE}</td>
               <td>
                 <button onclick="archiveGroup(${g.id})">Archive</button>
                 <button onclick="deleteGroup(${g.id})" style="margin-left:6px;color:#b00020">Delete</button>
               </td>`;
            tbody.appendChild(tr);
          });
        }

        // Prepare signup organization predictive map only (do not prefill datalist to avoid full list popup)
        try {
          window.signupGroupMap = {};
          groups
            .sort((a,b) => String(a.name).localeCompare(String(b.name)))
            .forEach(g => {
              window.signupGroupMap[String(g.name).toLowerCase()] = g.id;
            });
          const list = document.getElementById('signupGroupList');
          if (list) list.innerHTML = ''; // keep empty until user types
        } catch { /* silent */ }

        // Populate superadmin org picker
        const orgPicker = document.getElementById('superadminOrgPicker');
        if (orgPicker) {
          const current = orgPicker.value;
          orgPicker.innerHTML = '<option value="">— Select organization —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            orgPicker.appendChild(opt);
          });
          if (current) orgPicker.value = current;
          // Update single-org info panel based on current selection
          const infoWrap = document.getElementById('superadminOrgInfo');
          const infoBody = document.getElementById('superadminOrgInfoBody');
          if (infoWrap && infoBody) {
            if (orgPicker.value) {
              const g = groups.find(x => String(x.id) === String(orgPicker.value));
              if (g) {
                const statusTxt = g.status ?? g.group_status ?? '';
                infoBody.innerHTML = `<tr><td>${g.id}</td><td>${g.name}</td><td>${statusTxt}</td></tr>`;
                infoWrap.classList.remove('hidden');
              } else {
                infoBody.innerHTML = '';
                infoWrap.classList.add('hidden');
              }
            } else {
              infoBody.innerHTML = '';
              infoWrap.classList.add('hidden');
            }
          }
        }

        const groupSelectors = [
          document.getElementById('newUserGroup'),
          document.getElementById('superGroup'),
          document.getElementById('adminGroup'),
          document.getElementById('volGroup'),
          document.getElementById('dutyGroup'),
          document.getElementById('superEventGroupFilter'),
          document.getElementById('superDutyGroupFilter'),
          document.getElementById('dutyTemplateGroup')
        ];
        groupSelectors.forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          const isSuperFilter = sel.id === 'superEventGroupFilter' || sel.id === 'superDutyGroupFilter';
          const wantsOrgPrompt = isSuperFilter || sel.id === 'dutyTemplateGroup';
          sel.innerHTML = wantsOrgPrompt ? '<option value="">— Select organization —</option>' : '<option value="">— None —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current;
          else if (isSuperFilter && groupId != null) sel.value = String(groupId);
          else if (sel.id === 'dutyTemplateGroup' && groupId != null && role !== 'superadmin') sel.value = String(groupId);
          // trigger refresh on filter change
          if (isSuperFilter && !sel._wiredChange) {
            sel.addEventListener('change', () => {
              if (sel.id === 'superEventGroupFilter') fetchEvents();
              if (sel.id === 'superDutyGroupFilter') {
                // Clear current duties immediately and hide any open editor
                const tbody = document.getElementById('dutyList');
                if (tbody) tbody.innerHTML = '';
                const editSel = document.getElementById('dutyEditSelect');
                if (editSel) editSel.innerHTML = '<option value="">— Select duty —</option>';
                const wrap = document.getElementById('dutyEditWrap');
                if (wrap) wrap.classList.add('hidden');
                // Keep Create Duty group selector in sync with chosen org
                const dutyGroupSel = document.getElementById('dutyGroup');
                if (dutyGroupSel) dutyGroupSel.value = sel.value || '';
                // Refresh events for that org first, then duties
                populateEventDropdownsForGroup(sel.value);
                const filterVal = sel.value ? Number(sel.value) : null;
                fetchDuties();
                loadDutyTemplates({ group_id: filterVal });
              }
            });
            sel._wiredChange = true;
          }
          // when admin changes target group for new duty, repopulate event dropdowns to that org
          if (sel.id === 'dutyGroup' && !sel._wiredDuty) {
            sel.addEventListener('change', () => {
              const gid = sel.value || (groupId != null ? String(groupId) : '');
              populateEventDropdownsForGroup(gid);
            });
            sel._wiredDuty = true;
          }
          if (sel.id === 'dutyTemplateGroup' && !sel._wiredTemplate) {
            sel.addEventListener('change', () => {
              const val = sel.value ? Number(sel.value) : null;
              loadDutyTemplates({ group_id: val });
            });
            sel._wiredTemplate = true;
          }
        });
        populateCalendarGroupOptions(groups);
      } catch (e) { /* silent */ }
    }

    async function deleteGroup(id) {
      try {
        if (!confirm('Delete this organization? This will permanently remove it. You can also Archive instead. Continue?')) return;
        const res = await authed(`/groups/${id}`, { method: 'DELETE' });
        if (res.ok) { fetchGroups(); showActionStatus('Organization deleted.'); }
        else {
          const data = await res.json().catch(()=>({}));
          showActionStatus(data.message || 'Failed to delete organization', true);
        }
      } catch (e) {
        showActionStatus('Error deleting organization', true);
      }
    }
    async function archiveGroup(id) {
      try {
        if (!confirm('Archive this organization? It will be marked inactive and hidden from selection, but not deleted. Continue?')) return;
        const res = await authed(`/groups/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'inactive' })
        });
        if (res.ok) { fetchGroups(); showActionStatus('Organization archived.'); }
        else {
          const data = await res.json().catch(()=>({}));
          showActionStatus(data.message || 'Failed to archive organization', true);
        }
      } catch (e) {
        showActionStatus('Error archiving organization', true);
      }
    }

    document.getElementById('createGroupBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('groupNameInput').value.trim();
      const status = document.getElementById('groupStatus').value;
      const time_zone = document.getElementById('groupTimeZone')?.value || DEFAULT_TIME_ZONE;
      try {
        const res = await authed('/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, status, time_zone })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createGroupError').textContent = data.message || 'Failed to create organization';
          showActionStatus(data.message || 'Failed to create organization', true);
          return;
        }
        document.getElementById('createGroupError').textContent = '';
        document.getElementById('groupNameInput').value = '';
        populateTimeZoneSelect(document.getElementById('groupTimeZone'), DEFAULT_TIME_ZONE);
        fetchGroups();
        showActionStatus('Organization created.');
      } catch {
        document.getElementById('createGroupError').textContent = 'Error creating organization';
        showActionStatus('Error creating organization', true);
      }
    });

    // EVENTS
    async function fetchEvents() {
      try {
        const tbody = document.getElementById('eventList');
        let path = '/events';
        if (role === 'superadmin') {
          const sel = document.getElementById('superEventGroupFilter');
          const filterWrap = document.getElementById('eventsSuperFilter');
          const note = document.getElementById('eventsSuperNote');
          const needsSelection = filterWrap && !filterWrap.classList.contains('hidden');
          if (needsSelection && (!sel || !sel.value)) {
            if (tbody) tbody.innerHTML = '';
            if (note) {
              note.classList.remove('error');
              note.classList.add('hint');
              note.textContent = 'Select an organization above to view events.';
            }
            return;
          }
          if (sel && sel.value) {
            path = `/events?group_id=${encodeURIComponent(sel.value)}`;
            if (note) note.textContent = '';
          }
        }
        const res = await authed(path);
        const events = await res.json();
        try {
          window.eventById = {};
          events.forEach(ev => {
            if (ev && ev.id != null) window.eventById[ev.id] = ev;
          });
        } catch { /* ignore */ }
        if (tbody) {
        tbody.innerHTML = '';
        events.forEach(e => {
          const tr = document.createElement('tr');
            let actions = '';
            if (role === 'admin' || role === 'superadmin') {
              actions = `<button data-eid="${e.id}" class="editEventPrefillBtn">Edit</button> <button data-eid="${e.id}" class="archiveEventBtn">Archive</button> <button data-eid="${e.id}" class="deleteEventBtn">Delete</button>`;
            }
          const dateTxt = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          const joinCell = (role === 'volunteer')
            ? `<td>${e.joined ? `<button data-eid="${e.id}" class="leaveBtn">Leave</button>` : `<button data-eid=\"${e.id}\" class=\"joinBtn\">Join</button>`}</td>`
            : '<td class="hidden"></td>';
          tr.innerHTML =
            `<td>${e.id}</td><td>${e.title}</td><td>${dateTxt}</td>
               ${joinCell}
               <td>${actions}</td>`;
          tbody.appendChild(tr);
        });
          // wire actions
          tbody.querySelectorAll('.editEventPrefillBtn').forEach(btn => btn.addEventListener('click', (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            const eventData = (window.eventById || {})[id] || {};
            document.getElementById('eventEditWrap').classList.remove('hidden');
            document.getElementById('editEventId').value = String(id);
            document.getElementById('editEventTitle').value = eventData.title || '';
            document.getElementById('editEventDesc').value = eventData.description || '';
            const editAddress = document.getElementById('editEventAddress');
            if (editAddress) editAddress.value = eventData.address || '';
            document.getElementById('editEventStart').value = eventData.start_date || eventData.event_date || '';
            document.getElementById('editEventEnd').value = eventData.end_date || eventData.start_date || eventData.event_date || '';
            document.getElementById('editEventStartTime').value = (eventData.start_time || '').slice(0, 5);
            document.getElementById('editEventEndTime').value = (eventData.end_time || '').slice(0, 5);
          }));
          tbody.querySelectorAll('.joinBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/join`, { method: 'POST' });
              if (res.ok) {
                await fetchEvents();
                await refreshCalendarIfVisible({ preserveSelectionId: id, skipReset: true });
              } else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to join'); }
            } catch { alert('Error joining'); }
          }));
          tbody.querySelectorAll('.leaveBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/leave`, { method: 'POST' });
              if (res.ok) {
                await fetchEvents();
                await refreshCalendarIfVisible({ preserveSelectionId: id, skipReset: true });
              } else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to leave'); }
            } catch { alert('Error leaving'); }
          }));
          tbody.querySelectorAll('.archiveEventBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/archive`, { method: 'POST' });
              if (res.ok) {
                await fetchEvents();
                await refreshCalendarIfVisible({ preserveSelectionId: id });
              } else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to archive'); }
            } catch { alert('Error archiving'); }
          }));
          tbody.querySelectorAll('.deleteEventBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            if (!confirm('Delete this event?')) return;
            try {
              const res = await authed(`/events/${id}`, { method: 'DELETE' });
              if (res.ok) {
                await fetchEvents();
                await refreshCalendarIfVisible();
              } else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to delete'); }
            } catch { alert('Error deleting'); }
          }));
        }

        // Populate optional event dropdowns for duty creation
        const eventSelects = [document.getElementById('dutyEvent'), document.getElementById('volDutyEvent')];
        eventSelects.forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          sel.innerHTML = '<option value="">— None —</option>';
        events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
          const t1 = (e.start_time || '').slice(0,5);
          const t2 = (e.end_time || '').slice(0,5);
          const d = e.start_date ? (e.end_date ? `${e.start_date} ${t1 || ''} – ${e.end_date} ${t2 || ''}` : `${e.start_date} ${t1 || ''}`) : (e.event_date || '');
          opt.textContent = `${e.title} ${d ? '— ' + d.trim() : ''}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current;
        });
        // Populate event group selectors
        const grpSels = [document.getElementById('eventGroup2')];
        for (const grpSel of grpSels) {
          if (!grpSel) continue;
          // ensure groups loaded
          const resG = await authed('/groups');
          const groups = await resG.json();
          const current = grpSel.value;
          grpSel.innerHTML = '<option value="">— Select group —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            grpSel.appendChild(opt);
          });
          if (current) grpSel.value = current; else if (groupId != null) grpSel.value = String(groupId);
        }
      } catch (e) { /* silent */ }
    }

    // Populate duty event dropdowns for a specific organization
    async function populateEventDropdownsForGroup(gid) {
      try {
        const dutySel = document.getElementById('dutyEvent');
        const volSel = document.getElementById('volDutyEvent');
        const clear = (sel) => { if (sel) sel.innerHTML = '<option value="">— Select event —</option>'; };
        if (!gid) { clear(dutySel); clear(volSel); return; }
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) { clear(dutySel); clear(volSel); return; }
        const events = await res.json();
        [dutySel, volSel].forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          sel.innerHTML = '<option value="">— Select event —</option>';
          events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            const t1 = (e.start_time || '').slice(0,5);
            const t2 = (e.end_time || '').slice(0,5);
            const d = e.start_date ? (e.end_date ? `${e.start_date} ${t1 || ''} – ${e.end_date} ${t2 || ''}` : `${e.start_date} ${t1 || ''}`) : (e.event_date || '');
            opt.textContent = `${e.title} ${d ? '— ' + d.trim() : ''}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current;
        });
      } catch { /* silent */ }
    }

    // Populate Clock events by organization (superadmin filter)
    async function populateClockEventsForGroup(gid) {
      try {
        const sel = document.getElementById('clockEventFilter');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select event —</option>';
        sel.disabled = !gid;
        if (!gid) return;
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) return;
        const events = await res.json();
        events.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          opt.textContent = `${e.title}${d ? ' — ' + d : ''}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Populate Clock duties by organization and optional event (superadmin filter)
    async function populateClockDutiesByOrgAndEvent(gid, eventId) {
      try {
        const sel = document.getElementById('clockDutyFilter');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select duty —</option>';
        sel.disabled = !gid ? true : false;
        if (!gid) return;
        let duties = [];
        try {
          const res = await authed(`/duties?group_id=${encodeURIComponent(gid)}`);
          if (res.ok) duties = await res.json();
        } catch { /* ignore */ }
        if (!duties || duties.length === 0) {
          try {
            const resAll = await authed('/duties');
            if (resAll.ok) duties = await resAll.json();
          } catch { /* silent */ }
        }
        const hasEventId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'event_id'));
        if (eventId && hasEventId) duties = duties.filter(d => (d.event_id == null) || (Number(d.event_id) === Number(eventId)));
        const hasGroupId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'group_id'));
        if (hasGroupId) duties = duties.filter(d => (d.group_id == null) || (String(d.group_id) === String(gid)));
        duties.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = `${d.id} — ${d.title}`;
          sel.appendChild(opt);
        });
        sel.disabled = false;
        if (current) sel.value = current;
      } catch { /* silent */ }
    }
    async function populateClockAdminOrgPicker() {
      try {
        const row = document.getElementById('clockAdminOrgRow');
        if (row) row.classList.remove('hidden');
        const sel = document.getElementById('clockAdminOrgPicker');
        if (!sel) return;
        const res = await authed('/groups');
        if (!res.ok) return;
        const groups = await res.json();
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select organization —</option>';
        groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
        sel.disabled = false;
        if (!sel._wired) {
          sel.addEventListener('change', async () => {
            await populateClockAdminVolunteersByOrg(sel.value || '');
          });
          sel._wired = true;
        }
        if (sel.value) {
          await populateClockAdminVolunteersByOrg(sel.value);
        } else {
          const volunteerSel = document.getElementById('clockAdminVolunteer');
          if (volunteerSel) {
            volunteerSel.innerHTML = '<option value="">— Select organization first —</option>';
            volunteerSel.disabled = true;
          }
          const tbody = document.getElementById('clockAdminTimeList');
          if (tbody) tbody.innerHTML = '';
          const empty = document.getElementById('clockAdminEmpty');
          if (empty) empty.textContent = 'Select an organization to manage volunteer time logs.';
        }
      } catch { /* silent */ }
    }
    async function populateClockAdminVolunteersByOrg(orgId) {
      try {
        const sel = document.getElementById('clockAdminVolunteer');
        const tbody = document.getElementById('clockAdminTimeList');
        const empty = document.getElementById('clockAdminEmpty');
        if (!sel || !tbody) return;
        if (role === 'superadmin' && !orgId) {
          sel.innerHTML = '<option value="">— Select organization first —</option>';
          sel.disabled = true;
          tbody.innerHTML = '';
          if (empty) empty.textContent = 'Select an organization to manage volunteer time logs.';
          return;
        }
        const volunteers = await fetchVolunteers(orgId || (groupId != null ? String(groupId) : ''));
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select volunteer —</option>';
        sel._vols = volunteers || [];
        sel._vols.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name ? `${v.name}` : v.email;
          sel.appendChild(opt);
        });
        sel.disabled = false;
        if (current) sel.value = current;
        if (!sel._wired) {
          sel.addEventListener('change', () => {
            const vid = Number(sel.value);
            const vol = (sel._vols || []).find(x => Number(x.id) === vid);
            if (vol) setActiveTimeZoneForGroup(vol.group_id);
            refreshClockAdminTimes();
          });
          sel._wired = true;
        }
        if (sel.value) {
          const vol = (sel._vols || []).find(x => String(x.id) === String(sel.value));
          if (vol) setActiveTimeZoneForGroup(vol.group_id);
          await refreshClockAdminTimes();
        } else {
          tbody.innerHTML = '';
          if (empty) empty.textContent = 'Select a volunteer to view or adjust time entries.';
        }
      } catch { /* silent */ }
    }
    async function refreshClockAdminTimes() {
      try {
        const sel = document.getElementById('clockAdminVolunteer');
        const tbody = document.getElementById('clockAdminTimeList');
        const empty = document.getElementById('clockAdminEmpty');
        if (!sel || !tbody) return;
        if (!sel.value) {
          tbody.innerHTML = '';
          if (empty) empty.textContent = 'Select a volunteer to view or adjust time entries.';
          return;
        }
        const volunteerId = Number(sel.value);
        const tz = getVolunteerTimeZone(volunteerId);
        activeTimeZone = tz;
        const res = await authed(`/time-tracking?volunteer_id=${encodeURIComponent(sel.value)}`);
        if (!res.ok) {
          tbody.innerHTML = '';
          if (empty) empty.textContent = 'Failed to load time entries.';
          return;
        }
        const rows = await res.json();
        tbody.innerHTML = '';
        if (!rows.length) {
          if (empty) empty.textContent = 'No time entries found for this volunteer.';
          return;
        }
        if (empty) empty.textContent = '';
        timeEntryTimeZoneById = {};
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          timeEntryTimeZoneById[r.id] = tz;
          const assignment = describeAssignment(r);
          const statusLabel = r.approved ? 'Approved' : 'Pending';
          const approveCell = r.approved
            ? '<span>Approved</span>'
            : `<button data-tid="${r.id}" class="clockApproveBtn">Approve</button>`;
          tr.innerHTML =
            `<td data-label="ID">${r.id}</td>
             <td data-label="Event">${assignment.eventLabel || '-'}</td>
             <td data-label="Duty">${assignment.dutyLabel || '-'}</td>
             <td data-label="Start"><input type="datetime-local" id="clock-start-${r.id}" value="${formatDateTimeLocal(r.start_time, tz)}"></td>
             <td data-label="End"><input type="datetime-local" id="clock-end-${r.id}" value="${formatDateTimeLocal(r.end_time, tz)}"></td>
             <td data-label="Hours">${hours}</td>
             <td data-label="Date"><input type="date" id="clock-date-${r.id}" value="${formatDateLocal(r.duty_date)}"></td>
             <td data-label="Status">${statusLabel}</td>
             <td data-label="Approve">${approveCell}</td>
             <td data-label="Save"><button data-tid="${r.id}" class="clockSaveBtn">Save</button></td>
             <td data-label="Delete"><button data-tid="${r.id}" class="clockDeleteBtn" style="color:#b00020">Delete</button></td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('.clockSaveBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-tid'));
            if (Number.isFinite(id)) await saveClockAdjustTime(id);
          });
        });
        tbody.querySelectorAll('.clockDeleteBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-tid'));
            if (Number.isFinite(id)) await deleteClockAdjustTime(id);
          });
        });
        tbody.querySelectorAll('.clockApproveBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-tid'));
            if (Number.isFinite(id)) await approve(id);
          });
        });
      } catch { /* silent */ }
    }
    // Populate VM Event select strictly by organization
    async function populateVmEventsByOrg(gid) {
      try {
        const sel = document.getElementById('vmEvent');
        if (!sel) return;
        sel.disabled = !gid;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select event —</option>';
        if (!gid) return;
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) return;
        const events = await res.json();
        events.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          opt.textContent = `${e.title}${d ? ' — ' + d : ''}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Populate VM Duty select by organization and optional event filter
    async function populateVmDutiesByOrgAndEvent(gid, eventId) {
      try {
        const sel = document.getElementById('vmDuty');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select duty —</option>';
        // Enforce: an event MUST be chosen before duties can be selected
        if (!gid || !eventId) {
          sel.disabled = true;
          sel.innerHTML = '<option value="">— Select event first —</option>';
          return;
        }
        sel.disabled = false;
        // Try org-scoped fetch first; if none returned, fall back to all duties
        let duties = [];
        try {
          const res = await authed(`/duties?group_id=${encodeURIComponent(gid)}`);
          if (res.ok) duties = await res.json();
        } catch { /* ignore, try fallback */ }
        if (!duties || duties.length === 0) {
          try {
            const resAll = await authed('/duties');
            if (resAll.ok) duties = await resAll.json();
          } catch { /* silent */ }
        }
        // Strictly require event match; duties without event_id are excluded
        duties = duties.filter(d => Number(d.event_id) === Number(eventId));
        // Prefer matching org when group_id exists
        const hasGroupId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'group_id'));
        if (hasGroupId) duties = duties.filter(d => String(d.group_id) === String(gid));
        duties.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = `${d.id} — ${d.title}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Removed duplicate Admin Tools create-event handler; use Events page create form instead

    // Create Event (from Events page admin-only form)
    document.getElementById('createEventBtn2')?.addEventListener('click', async () => {
      const title = document.getElementById('eventTitle2').value.trim();
      const description = document.getElementById('eventDesc2').value.trim();
      const grpSel2 = document.getElementById('eventGroup2');
      const gid2 = grpSel2 && grpSel2.value ? Number(grpSel2.value) : (groupId ?? null);
      const start_date = document.getElementById('eventStart2').value;
      const end_date = document.getElementById('eventEnd2').value;
      const start_time = document.getElementById('eventStartTime2').value;
      const end_time = document.getElementById('eventEndTime2').value;
      const addressWrap = document.getElementById('eventAddressField');
      const address = addressWrap && !addressWrap.classList.contains('hidden')
        ? document.getElementById('eventAddress').value.trim()
        : '';
      try {
        const res = await authed('/events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, start_date, end_date, start_time, end_time, group_id: gid2, address: address || null })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createEventError2').textContent = data.message || 'Failed to create event';
          return;
        }
        document.getElementById('createEventError2').textContent = '';
        document.getElementById('eventTitle2').value = '';
        document.getElementById('eventDesc2').value = '';
        document.getElementById('eventStart2').value = '';
        document.getElementById('eventEnd2').value = '';
        document.getElementById('eventStartTime2').value = '';
        document.getElementById('eventEndTime2').value = '';
        optionalFieldControls.eventAddress?.hide();
        if (grpSel2) grpSel2.value = groupId != null ? String(groupId) : '';
        await fetchEvents();
        await refreshCalendarIfVisible();
      } catch {
        document.getElementById('createEventError2').textContent = 'Error creating event';
      }
    });

    // Save event edits
    document.getElementById('saveEventBtn')?.addEventListener('click', async () => {
      const id = Number(document.getElementById('editEventId').value);
      const title = document.getElementById('editEventTitle').value.trim();
      const description = document.getElementById('editEventDesc').value.trim();
      const start_date = document.getElementById('editEventStart').value;
      const end_date = document.getElementById('editEventEnd').value;
      const start_time = document.getElementById('editEventStartTime').value;
      const end_time = document.getElementById('editEventEndTime').value;
      const address = document.getElementById('editEventAddress').value.trim();
      try {
        const res = await authed(`/events/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, start_date, end_date, start_time, end_time, address: address || null })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { document.getElementById('editEventError').textContent = data.message || 'Failed to save event'; return; }
        document.getElementById('editEventError').textContent = '';
        document.getElementById('eventEditWrap').classList.add('hidden');
        await fetchEvents();
        await refreshCalendarIfVisible({ preserveSelectionId: id, skipReset: true });
      } catch { document.getElementById('editEventError').textContent = 'Error saving event'; }
    });

    // DUTIES (admin-managed; volunteer sees assigned duties)
    async function fetchDuties() {
      try {
        let path = '/duties';
        if (role === 'superadmin') {
          const sel = document.getElementById('superDutyGroupFilter');
          if (sel && sel.value) path = `/duties?group_id=${encodeURIComponent(sel.value)}`;
          // Superadmin should not see the "My Duties" table
          const dutiesWrap = document.getElementById('clockDutiesWrap');
          if (dutiesWrap) dutiesWrap.classList.add('hidden');
        }
        const res = await authed(path); // backend should return duties user can see
        const duties = await res.json();
        // Build a duty map for later event-based filtering in time-tracking
        try {
          window.dutyById = {};
          (duties || []).forEach(d => { if (d && d.id != null) window.dutyById[d.id] = d; });
        } catch { /* ignore */ }
        const tbody = document.getElementById('dutyList');
        if (role === 'superadmin') {
          const filterSel = document.getElementById('superDutyGroupFilter');
          const filterWrap = document.getElementById('dutiesSuperFilter');
          const note = document.getElementById('dutiesSuperNote');
          const enforcing = filterWrap && !filterWrap.classList.contains('hidden');
          if (enforcing && filterSel && (!filterSel.value || filterSel.value === '')) {
            if (tbody) tbody.innerHTML = '';
            // Disable dependent duty selects until org is chosen
            const editSel = document.getElementById('dutyEditSelect');
            if (editSel) { editSel.innerHTML = '<option value="">— Select organization first —</option>'; editSel.disabled = true; }
            const vmDutySel = document.getElementById('vmDuty');
            if (vmDutySel) { vmDutySel.innerHTML = '<option value="">— Select organization first —</option>'; vmDutySel.disabled = true; }
            if (note) { note.classList.remove('error'); note.classList.add('hint'); note.textContent = 'Select an organization above to view duties.'; }
            return;
          }
          if (note) note.textContent = '';
        }
        if (!tbody) return;
        tbody.innerHTML = '';
        // populate duty table rows and selects
        const editSelect = document.getElementById('dutyEditSelect');
        if (editSelect) { editSelect.innerHTML = '<option value="">— Select duty —</option>'; editSelect.disabled = false; }
        const vmDutySelEnabled = document.getElementById('vmDuty');
        if (vmDutySelEnabled) vmDutySelEnabled.disabled = false;
        duties.forEach(d => {
          const tr = document.createElement('tr');
          let adminActions = '';
          if (role === 'admin' || role === 'superadmin') {
            adminActions = `<button data-did="${d.id}" data-max="${d.max_volunteers ?? ''}" class="prefillDutyEditBtn">Edit</button>` +
                           ` <button data-did="${d.id}" class="deleteDutyBtn" style="margin-left:6px;color:#b00020">Delete</button>`;
          }
          const capacityLabel = (d.max_volunteers != null && d.max_volunteers !== '') ? d.max_volunteers : '—';
          const activeLabel = d.active_assignments != null ? d.active_assignments : 0;
          const isFull = d.max_volunteers != null && d.max_volunteers !== '' && Number(d.max_volunteers) > 0 && Number(activeLabel) >= Number(d.max_volunteers);
          const clockInDisabled = isFull ? 'disabled title="Duty has reached its volunteer limit"' : '';
          const dutyColor = getDutyColor(d.id);
          const dutyDot = dutyColor ? `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${dutyColor};margin-right:6px;"></span>` : '';
          tr.innerHTML =
            `<td>${d.id}</td><td>${dutyDot}${d.title}</td><td>${d.description || ''}</td><td>${d.status}</td>
             <td>${capacityLabel}</td><td>${activeLabel}</td>
             <td>
               <input type="date" id="dutyDate-${d.id}" required>
               <button onclick="startTime(${d.id})" ${clockInDisabled}>Clock In</button>
               <button onclick="stopTime(${d.id})">Clock Out</button>
               ${isFull ? '<div class="hint" style="margin-top:4px">Duty is full</div>' : ''}
               ${adminActions}
             </td>`;
          tbody.appendChild(tr);
          if (editSelect) {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.id} — ${d.title}`;
            editSelect.appendChild(opt);
          }
        });
        if (editSelect) {
          ensureDutyColorPreview('dutyEditSelect', 'dutyEditColorPreview');
          if (editSelect.value) renderDutyColorPreview('dutyEditColorPreview', (window.dutyById && window.dutyById[Number(editSelect.value)])?.color_hex || editSelect.value);
        }
        // wire prefill duty edit
        tbody.querySelectorAll('.prefillDutyEditBtn').forEach(btn => btn.addEventListener('click', (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-did'));
          const row = ev.currentTarget.closest('tr').children;
          const wrap = document.getElementById('dutyEditWrap');
          if (wrap) wrap.classList.remove('hidden');
          document.getElementById('editDutyId').value = String(id);
          document.getElementById('editDutyTitle').value = row[1].textContent || '';
          document.getElementById('editDutyDesc').value = row[2].textContent || '';
          document.getElementById('editDutyStatus').value = (row[3].textContent || 'pending');
          const capInput = document.getElementById('editDutyCapacity');
          const stored = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].max_volunteers : null;
          if (capInput) capInput.value = stored != null ? stored : '';
          const storedLocation = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].location : '';
          const storedColor = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].color_hex : '';
          const editColorInput = document.getElementById('editDutyColor');
          if (editColorInput) editColorInput.value = normalizeHexColor(storedColor) || '#2563eb';
          if (optionalFieldControls.editDutyLocation) {
            if (storedLocation) {
              optionalFieldControls.editDutyLocation.show();
              const locInput = document.getElementById('editDutyLocation');
              if (locInput) locInput.value = storedLocation;
            } else {
              optionalFieldControls.editDutyLocation.hide();
            }
          } else {
            const locInput = document.getElementById('editDutyLocation');
            if (locInput) locInput.value = storedLocation || '';
          }
          prepareDutyRestrictionUI(id);
        }));
        // wire delete duty
        tbody.querySelectorAll('.deleteDutyBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-did'));
          if (!confirm('Delete this duty?')) return;
          try {
            const res = await authed(`/duties/${id}`, { method: 'DELETE' });
            if (res.ok) { await fetchDuties(); }
          } catch { /* silent */ }
        }));
      } catch (e) { /* silent */ }
    }

    function updateDutyTemplateModeUI() {
      const modeSel = document.getElementById('dutyTemplateMode');
      const mode = modeSel ? (modeSel.value || 'use') : 'use';
      const useWrap = document.getElementById('dutyTemplateUseWrap');
      const addWrap = document.getElementById('dutyTemplateAddWrap');
      if (useWrap) useWrap.classList.toggle('hidden', mode !== 'use');
      if (addWrap) addWrap.classList.toggle('hidden', mode !== 'add');
    }

    function setDutyTemplateStatus(message = '', isError = false) {
      const el = document.getElementById('dutyTemplateStatus');
      if (!el) return;
      el.textContent = message || '';
      el.classList.toggle('hidden', !message);
      el.classList.toggle('error', Boolean(message) && isError);
      el.classList.toggle('hint', !isError);
    }

    function populateDutyTemplateSelect() {
      const sel = document.getElementById('dutyTemplateSelect');
      if (!sel) return;
      const templates = Array.isArray(window.dutyTemplates) ? window.dutyTemplates : [];
      sel.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = templates.length ? '— Select saved duty —' : '— No saved duties —';
      sel.appendChild(placeholder);
      templates.forEach(t => {
        if (!t || t.id == null) return;
        const opt = document.createElement('option');
        opt.value = t.id;
        const prefix = (role === 'superadmin' && t.group_name) ? `${t.group_name} — ` : '';
        opt.textContent = `${prefix}${t.title}`;
        sel.appendChild(opt);
      });
      sel.disabled = templates.length === 0;
    }

    async function loadDutyTemplates(options = {}) {
      if (!(role === 'admin' || role === 'superadmin')) return;
      const select = document.getElementById('dutyTemplateSelect');
      if (!select) return;
      // clear cache before fetch to avoid stale cross-org entries
      window.dutyTemplates = [];
      window.dutyTemplateById = {};
      populateDutyTemplateSelect();
      try {
        let path = '/duty-templates';
        if (role === 'admin') {
          const gid = groupId != null ? Number(groupId) : NaN;
          if (!Number.isFinite(gid)) {
            setDutyTemplateStatus('Select an organization to use duty templates.', true);
            window.dutyTemplates = [];
            window.dutyTemplateById = {};
            populateDutyTemplateSelect();
            return;
          }
          path = `/duty-templates?group_id=${encodeURIComponent(gid)}`;
        } else if (role === 'superadmin') {
          let groupFilter = options.group_id;
          if (groupFilter != null && !Number.isFinite(groupFilter)) groupFilter = Number(groupFilter);
          if (groupFilter == null) {
            const superFilter = document.getElementById('superDutyGroupFilter');
            if (superFilter && superFilter.value) groupFilter = Number(superFilter.value);
          }
          if (groupFilter == null) {
            const templateGroupSel = document.getElementById('dutyTemplateGroup');
            if (templateGroupSel && templateGroupSel.value) groupFilter = Number(templateGroupSel.value);
          }
          if (groupFilter == null) {
            const dutyGroupSel = document.getElementById('dutyGroup');
            if (dutyGroupSel && dutyGroupSel.value) groupFilter = Number(dutyGroupSel.value);
          }
          if (Number.isFinite(groupFilter)) {
            path += `?group_id=${encodeURIComponent(groupFilter)}`;
          }
        }
        const res = await authed(path);
        if (!res.ok) throw new Error('Failed to load duty templates');
        const data = await res.json();
        window.dutyTemplates = Array.isArray(data) ? data : [];
        // Client-side safety: for admins, hard-filter to their org only
        if (role === 'admin') {
          const gid = groupId != null ? Number(groupId) : NaN;
          window.dutyTemplates = window.dutyTemplates.filter(t => Number(t?.group_id) === gid);
        }
        window.dutyTemplateById = {};
        window.dutyTemplates.forEach(t => {
          if (t && t.id != null) window.dutyTemplateById[t.id] = t;
        });
        setDutyTemplateStatus(window.dutyTemplates.length ? '' : 'No saved duties for this organization.', false);
        populateDutyTemplateSelect();
        ensureDutyColorPreview('dutyTemplateSelect', 'dutyTemplateColorPreview');
        const templateSel = document.getElementById('dutyTemplateSelect');
        if (templateSel && templateSel.value) {
          { const tpl = (window.dutyTemplateById || {})[Number(templateSel.value)]; renderDutyColorPreview('dutyTemplateColorPreview', tpl?.color_hex || templateSel.value); }
        } else {
          renderDutyColorPreview('dutyTemplateColorPreview', null);
        }
      } catch {
        window.dutyTemplates = [];
        window.dutyTemplateById = {};
        setDutyTemplateStatus('Failed to load duty templates', true);
        populateDutyTemplateSelect();
      }
    }

    function mapTemplateStatusToCreateOption(stored) {
      if (!stored) return 'open';
      const map = { pending: 'open', in_progress: 'open', completed: 'closed' };
      return map[String(stored).toLowerCase()] || 'open';
    }

    function applyDutyTemplateToForm(template) {
      if (!template) return;
      ensureDutyColorPreview('dutyTemplateSelect', 'dutyTemplateColorPreview');
      renderDutyColorPreview('dutyTemplateColorPreview', template.color_hex || template.id);
      const dutyColorInput = document.getElementById('dutyColor');
      if (dutyColorInput) dutyColorInput.value = normalizeHexColor(template.color_hex) || dutyColorInput.value || '#2563eb';
      const titleInput = document.getElementById('dutyTitle');
      const descInput = document.getElementById('dutyDesc');
      const statusSel = document.getElementById('dutyStatus');
      const capacityInput = document.getElementById('dutyCapacity');
      if (titleInput) titleInput.value = template.title || '';
      if (descInput) descInput.value = template.description || '';
      if (statusSel) statusSel.value = mapTemplateStatusToCreateOption(template.status);
      if (capacityInput) capacityInput.value = template.max_volunteers != null ? template.max_volunteers : '';
      if (template.group_id != null) {
        const dutyGroupSel = document.getElementById('dutyGroup');
        if (role === 'superadmin') {
          const templateGroupSel = document.getElementById('dutyTemplateGroup');
          if (templateGroupSel) templateGroupSel.value = String(template.group_id);
        }
        if (dutyGroupSel && dutyGroupSel.value !== String(template.group_id)) {
          dutyGroupSel.value = String(template.group_id);
          populateEventDropdownsForGroup(template.group_id);
        }
      }
      setDutyTemplateStatus('Template applied.');
    }

    // Wire selecting a duty to prefill edit form
    document.getElementById('dutyEditSelect')?.addEventListener('change', () => {
      const sel = document.getElementById('dutyEditSelect');
      if (!sel) return;
      ensureDutyColorPreview('dutyEditSelect', 'dutyEditColorPreview');
      if (!sel.value) { renderDutyColorPreview('dutyEditColorPreview', null); return; }
      const id = Number(sel.value);
      renderDutyColorPreview('dutyEditColorPreview', (window.dutyById && window.dutyById[id])?.color_hex || id);
      const row = Array.from(document.querySelectorAll('#dutyList tr')).find(tr => tr.firstChild?.textContent == String(id));
      if (!row) {
        document.getElementById('dutyEditWrap').classList.remove('hidden');
        document.getElementById('editDutyId').value = String(id);
        const capInput = document.getElementById('editDutyCapacity');
        const stored = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].max_volunteers : null;
        if (capInput) capInput.value = stored != null ? stored : '';
        const storedLocation = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].location : '';
        if (optionalFieldControls.editDutyLocation) {
          if (storedLocation) {
            optionalFieldControls.editDutyLocation.show();
            const locInput = document.getElementById('editDutyLocation');
            if (locInput) locInput.value = storedLocation;
          } else {
            optionalFieldControls.editDutyLocation.hide();
          }
        } else {
          const locInput = document.getElementById('editDutyLocation');
          if (locInput) locInput.value = storedLocation || '';
        }
        prepareDutyRestrictionUI(id);
        return;
      }
      const cells = row.children;
      document.getElementById('dutyEditWrap').classList.remove('hidden');
      document.getElementById('editDutyId').value = String(id);
      document.getElementById('editDutyTitle').value = cells[1].textContent || '';
      document.getElementById('editDutyDesc').value = cells[2].textContent || '';
      document.getElementById('editDutyStatus').value = (cells[3].textContent || 'pending');
      const capInput = document.getElementById('editDutyCapacity');
      const stored = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].max_volunteers : null;
      if (capInput) capInput.value = stored != null ? stored : '';
      const storedLocation = (window.dutyById && window.dutyById[id]) ? window.dutyById[id].location : '';
      if (optionalFieldControls.editDutyLocation) {
        if (storedLocation) {
          optionalFieldControls.editDutyLocation.show();
          const locInput = document.getElementById('editDutyLocation');
          if (locInput) locInput.value = storedLocation;
        } else {
          optionalFieldControls.editDutyLocation.hide();
        }
      } else {
        const locInput = document.getElementById('editDutyLocation');
        if (locInput) locInput.value = storedLocation || '';
      }
      prepareDutyRestrictionUI(id);
    });

    document.getElementById('dutyTemplateMode')?.addEventListener('change', () => updateDutyTemplateModeUI());
    updateDutyTemplateModeUI();

    const dutyTemplateSelect = document.getElementById('dutyTemplateSelect');
    if (dutyTemplateSelect && !dutyTemplateSelect._colorWired) {
      ensureDutyColorPreview('dutyTemplateSelect', 'dutyTemplateColorPreview');
      dutyTemplateSelect.addEventListener('change', () => {
        const templateId = Number(dutyTemplateSelect.value);
        const tpl = (window.dutyTemplateById || {})[templateId];
        renderDutyColorPreview('dutyTemplateColorPreview', tpl?.color_hex || (Number.isFinite(templateId) ? templateId : null));
      });
      dutyTemplateSelect._colorWired = true;
    }

    document.getElementById('applyDutyTemplateBtn')?.addEventListener('click', () => {
      const sel = document.getElementById('dutyTemplateSelect');
      if (!sel || !sel.value) {
        setDutyTemplateStatus('Select a saved duty first.', true);
        return;
      }
      const templateId = Number(sel.value);
      if (!Number.isFinite(templateId)) {
        setDutyTemplateStatus('Invalid saved duty.', true);
        return;
      }
      const template = (window.dutyTemplateById || {})[templateId];
      if (!template) {
        setDutyTemplateStatus('Saved duty not found.', true);
        return;
      }
      renderDutyColorPreview('dutyTemplateColorPreview', template.color_hex || templateId);
      applyDutyTemplateToForm(template);
    });
    document.getElementById('saveDutyTemplateBtn')?.addEventListener('click', async () => {
      if (!(role === 'admin' || role === 'superadmin')) return;
      const titleInput = document.getElementById('templateTitle');
      const descInput = document.getElementById('templateDesc');
      const statusSel = document.getElementById('templateStatus');
      const capacityInput = document.getElementById('templateCapacity');
      const title = titleInput?.value.trim();
      const description = descInput?.value.trim();
      const status = statusSel?.value || 'open';
      const color_hex = normalizeHexColor(document.getElementById('templateColor')?.value) || null;
      const rawCap = capacityInput?.value?.trim();
      let max_volunteers = null;
      if (rawCap) {
        const parsed = Number(rawCap);
        if (!Number.isFinite(parsed) || parsed < 1) {
          setDutyTemplateStatus('Max volunteers must be a positive number', true);
          return;
        }
        max_volunteers = Math.floor(parsed);
      }
      let targetGroupId = groupId ?? null;
      if (targetGroupId != null) targetGroupId = Number(targetGroupId);
      if (role === 'superadmin') {
        targetGroupId = null;
        const groupSel = document.getElementById('dutyTemplateGroup');
        if (groupSel && groupSel.value) targetGroupId = Number(groupSel.value);
        if (!targetGroupId) {
          const superFilter = document.getElementById('superDutyGroupFilter');
          if (superFilter && superFilter.value) targetGroupId = Number(superFilter.value);
        }
        if (!targetGroupId) {
          const dutyGroupSel = document.getElementById('dutyGroup');
          if (dutyGroupSel && dutyGroupSel.value) targetGroupId = Number(dutyGroupSel.value);
        }
      }
      if (!title) {
        setDutyTemplateStatus('Title is required', true);
        return;
      }
      if (!targetGroupId) {
        setDutyTemplateStatus('Select an organization for this template.', true);
        return;
      }
      try {
        setDutyTemplateStatus('Saving template…');
        const res = await authed('/duty-templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, status, max_volunteers, group_id: targetGroupId, color_hex })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setDutyTemplateStatus(data.message || 'Failed to save template', true);
          return;
        }
        if (titleInput) titleInput.value = '';
        if (descInput) descInput.value = '';
        if (capacityInput) capacityInput.value = '';
        if (role === 'superadmin') {
          const groupSel = document.getElementById('dutyTemplateGroup');
          if (groupSel) groupSel.value = String(targetGroupId);
        }
        await loadDutyTemplates({ group_id: targetGroupId });
        setDutyTemplateStatus('Template saved to pool.');
        const modeSel = document.getElementById('dutyTemplateMode');
        if (modeSel) {
          modeSel.value = 'use';
          updateDutyTemplateModeUI();
        }
      } catch {
        setDutyTemplateStatus('Error saving template', true);
      }
    });

    // Create Duty (admin)
    document.getElementById('createDutyBtn')?.addEventListener('click', async () => {
      const title = document.getElementById('dutyTitle').value.trim();
      const description = document.getElementById('dutyDesc').value.trim();
      const groupSel = document.getElementById('dutyGroup');
      const group_id = groupSel && groupSel.value ? Number(groupSel.value) : (groupId ?? null);
        const eventSel = document.getElementById('dutyEvent');
        const event_id = eventSel && eventSel.value ? Number(eventSel.value) : null;
      const status = document.getElementById('dutyStatus').value;
      const capacityInput = document.getElementById('dutyCapacity');
      const rawCapacity = capacityInput?.value?.trim();
      const dutyLocationWrap = document.getElementById('dutyLocationField');
      const dutyLocationValue = dutyLocationWrap && !dutyLocationWrap.classList.contains('hidden')
        ? document.getElementById('dutyLocation').value.trim()
        : '';
      let max_volunteers = null;
      if (rawCapacity) {
        max_volunteers = Number(rawCapacity);
        if (!Number.isFinite(max_volunteers) || max_volunteers < 1) {
          document.getElementById('createDutyError').textContent = 'Max volunteers must be a positive number';
          return;
        }
        max_volunteers = Math.floor(max_volunteers);
      }
      try {
        if (!event_id) { document.getElementById('createDutyError').textContent = 'Event is required'; return; }
        const res = await authed('/duties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, status, group_id, event_id, max_volunteers, location: dutyLocationValue || null, color_hex: normalizeHexColor(document.getElementById('dutyColor')?.value) || null })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createDutyError').textContent = data.message || 'Failed to create duty';
          return;
        }
        document.getElementById('createDutyError').textContent = '';
        document.getElementById('dutyTitle').value = '';
        document.getElementById('dutyDesc').value = '';
        if (capacityInput) capacityInput.value = '';
        if (eventSel) eventSel.value = '';
        const dutyColorInput = document.getElementById('dutyColor');
        if (dutyColorInput) dutyColorInput.value = dutyColorInput.defaultValue || '#2563eb';
        optionalFieldControls.dutyLocation?.hide();
        // If superadmin, sync the top org filter to the group used so list shows immediately
        if (role === 'superadmin') {
          const topFilter = document.getElementById('superDutyGroupFilter');
          if (topFilter && group_id != null) topFilter.value = String(group_id);
        }
        await fetchDuties();
        // Select the newly created duty in the edit dropdown
        const editSel = document.getElementById('dutyEditSelect');
        if (editSel && group_id != null) {
          // Pick the last option (newest) if present
          if (editSel.options.length > 1) editSel.selectedIndex = editSel.options.length - 1;
          const evt = new Event('change');
          editSel.dispatchEvent(evt);
        }
      } catch {
        document.getElementById('createDutyError').textContent = 'Error creating duty';
      }
    });

    // Save duty edits
    document.getElementById('saveDutyBtn')?.addEventListener('click', async () => {
      const id = Number(document.getElementById('editDutyId').value);
      const title = document.getElementById('editDutyTitle').value.trim();
      const description = document.getElementById('editDutyDesc').value.trim();
      const status = document.getElementById('editDutyStatus').value;
      const capacityInput = document.getElementById('editDutyCapacity');
      const rawCapacity = capacityInput?.value?.trim();
      const editLocationInput = document.getElementById('editDutyLocation');
      const location = editLocationInput ? editLocationInput.value.trim() : '';
      let max_volunteers = null;
      if (rawCapacity !== undefined) {
        if (rawCapacity === '') {
          max_volunteers = null;
        } else {
          max_volunteers = Number(rawCapacity);
          if (!Number.isFinite(max_volunteers) || max_volunteers < 1) {
            document.getElementById('editDutyError').textContent = 'Max volunteers must be a positive number';
            return;
          }
          max_volunteers = Math.floor(max_volunteers);
        }
      }
      try {
        const res = await authed(`/duties/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, status, max_volunteers, location: location || null, color_hex: normalizeHexColor(document.getElementById('editDutyColor')?.value) || null })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { document.getElementById('editDutyError').textContent = data.message || 'Failed to save duty'; return; }
        document.getElementById('editDutyError').textContent = '';
        document.getElementById('dutyEditWrap').classList.add('hidden');
        clearDutyRestrictionUI();
        await fetchDuties();
      } catch { document.getElementById('editDutyError').textContent = 'Error saving duty'; }
    });
    document.getElementById('addDutyRestrictionBtn')?.addEventListener('click', async () => {
      if (role !== 'admin' && role !== 'superadmin') return;
      const dutyId = Number(document.getElementById('editDutyId').value);
      const volunteerId = Number(document.getElementById('dutyRestrictionVolunteer')?.value || '');
      if (!dutyId) { setDutyRestrictionStatus('Select a duty first.', true); return; }
      if (!volunteerId) { setDutyRestrictionStatus('Select a volunteer to restrict.', true); return; }
      setDutyRestrictionStatus('');
      try {
        const res = await authed(`/duties/${dutyId}/restrictions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ volunteer_id: volunteerId })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setDutyRestrictionStatus(data.message || 'Failed to restrict volunteer', true);
          return;
        }
        await loadDutyRestrictions(dutyId);
        setDutyRestrictionStatus('Volunteer restricted.');
      } catch {
        setDutyRestrictionStatus('Error restricting volunteer', true);
      }
    });

    // Create Duty (volunteer)
    document.getElementById('volCreateDutyBtn')?.addEventListener('click', async () => {
      const title = document.getElementById('volDutyTitle').value.trim();
      const description = document.getElementById('volDutyDesc').value.trim();
      const eventSel = document.getElementById('volDutyEvent');
      const event_id = eventSel && eventSel.value ? Number(eventSel.value) : null;
      const volLocationWrap = document.getElementById('volDutyLocationField');
      const volDutyLocationValue = volLocationWrap && !volLocationWrap.classList.contains('hidden')
        ? document.getElementById('volDutyLocation').value.trim()
        : '';
      try {
        const res = await authed('/duties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, event_id, location: volDutyLocationValue || null })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('volCreateDutyError').textContent = data.message || 'Failed to create duty';
          return;
        }
        document.getElementById('volCreateDutyError').textContent = '';
        document.getElementById('volDutyTitle').value = '';
        document.getElementById('volDutyDesc').value = '';
        if (eventSel) eventSel.value = '';
        optionalFieldControls.volDutyLocation?.hide();
        fetchDuties();
      } catch {
        document.getElementById('volCreateDutyError').textContent = 'Error creating duty';
      }
    });

    async function startTime(dutyId) {
      try {
        const dutyDate = document.getElementById(`dutyDate-${dutyId}`).value;
        const res = await authed(`/duties/${dutyId}/time/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duty_date: dutyDate })
        });
        if (res.ok) {
          updateStatusMessage('clockActionMsg', 'Clocked in.');
          fetchTimeTracking();
          if (dutyDate) {
            invalidateCalendarSchedule(dutyDate, { refresh: true });
          } else {
            invalidateCalendarSchedule(null);
          }
        } else {
          const data = await res.json().catch(() => ({}));
          updateStatusMessage('clockActionMsg', data.message || 'Failed to clock in', true);
          alert(data.message || 'Failed to clock in');
        }
      } catch {
        updateStatusMessage('clockActionMsg', 'Error clocking in', true);
        alert('Error clocking in');
      }
    }

    async function stopTime(dutyId) {
      try {
        const res = await authed(`/duties/${dutyId}/time/end`, { method: 'POST' });
        if (res.ok) {
          updateStatusMessage('clockActionMsg', 'Clocked out.');
          fetchTimeTracking();
          invalidateCalendarSchedule(calendarState.activeDateKey, { refresh: true });
        } else {
          const data = await res.json().catch(() => ({}));
          updateStatusMessage('clockActionMsg', data.message || 'Failed to clock out', true);
          alert(data.message || 'Failed to clock out');
        }
      } catch {
        updateStatusMessage('clockActionMsg', 'Error clocking out', true);
        alert('Error clocking out');
      }
    }

    // TIMESHEET
    async function fetchTimeTracking() {
      try {
        const tbody = document.getElementById('timeList');
        if (!tbody) return;
        if (role === 'admin' || role === 'superadmin') {
            tbody.innerHTML = '';
            return;
          }
        let rows = [];
          const params = new URLSearchParams();
          const res = await authed(`/time-tracking${params.toString() ? `?${params.toString()}` : ''}`);
          if (!res.ok) { tbody.innerHTML=''; return; }
          rows = await res.json();
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          const tz = getVolunteerTimeZone(r.volunteer_id || userId);
          const startDisplay = formatDisplayDateTime(r.start_time, tz);
          const endDisplay = formatDisplayDateTime(r.end_time, tz);
          const assignment = describeAssignment(r);
          tr.innerHTML =
            `<td data-label="ID">${r.id}</td>
             <td data-label="Event">${assignment.eventLabel || '-'}</td>
             <td data-label="Duty">${assignment.dutyLabel || '-'}</td>
             <td data-label="Start" class="nowrap">${startDisplay}</td>
             <td data-label="End" class="nowrap">${endDisplay}</td>
             <td data-label="Hours">${hours}</td>
             <td data-label="Date">${r.duty_date || ''}</td>`;
          tbody.appendChild(tr);
        });
        if (role === 'superadmin' && groups.length > 0) {
          const defaultGroupId = groups[0]?.id;
          if (defaultGroupId != null) {
            autoSelectGroupDropdown('superadminOrgPicker', defaultGroupId);
            autoSelectGroupDropdown('superDutyGroupFilter', defaultGroupId);
            autoSelectGroupDropdown('superEventGroupFilter', defaultGroupId);
            autoSelectGroupDropdown('vmOrgPicker', defaultGroupId);
          }
        }
      } catch (e) { /* silent */ }
    }

    // Volunteer Management helpers
    async function fetchVolunteers(groupIdForFilter) {
      try {
        const params = new URLSearchParams();
        if (groupIdForFilter) params.set('group_id', String(groupIdForFilter));
        // Use dedicated endpoint to list volunteers from DB
        const res = await authed(`/volunteers${params.toString() ? `?${params.toString()}` : ''}`);
        if (!res.ok) return [];
        const list = await res.json();
        if (Array.isArray(list)) {
          list.forEach(v => {
            if (v && v.id != null) volunteerTimeZoneById[v.id] = getGroupTimeZone(v.group_id);
          });
        }
        return list;
      } catch { return []; }
    }

    // Explicitly populate the top Volunteer dropdown for admins using the same API as the edit list
    async function populateTopVolunteerForAdmin() {
      try {
        if (role !== 'admin') return;
        const volSel = document.getElementById('vmVolunteer');
        if (!volSel) return;
        const res = await authed('/users?role=volunteer');
        if (!res.ok) return;
        const list = await res.json();
        (list || []).forEach(v => {
          if (v && v.id != null) volunteerTimeZoneById[v.id] = getGroupTimeZone(v.group_id);
        });
        const cur = volSel.value;
        volSel.innerHTML = '<option value="">— Select volunteer —</option>';
        list.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name ? `${v.name}` : v.email;
          volSel.appendChild(opt);
        });
        volSel.disabled = false;
        if (cur) volSel.value = cur;
        // cache for focus repopulation
        volSel._all = list;
      } catch { /* silent */ }
    }
    async function fetchUsersForSuperadmin() {
      try {
        const orgSel = document.getElementById('superadminOrgPicker');
        const roleSel = document.getElementById('saUserRole');
        const chosenRole = (roleSel && roleSel.value) ? roleSel.value : 'admin';
        const params = new URLSearchParams();
        if (chosenRole && chosenRole !== 'all') params.set('role', chosenRole);
        // Only apply org filter for admin/volunteer; superadmins are global
        const applyOrg = (chosenRole === 'admin' || chosenRole === 'volunteer');
        if (applyOrg && orgSel && orgSel.value) params.set('group_id', orgSel.value);
        const res = await authed(`/users?${params.toString()}`);
        if (!res.ok) return [];
        return await res.json();
      } catch { return []; }
    }
    async function populateSuperadminUsers() {
      try {
        const users = await fetchUsersForSuperadmin();
        const sel = document.getElementById('saAdminSelect');
        const selRow = document.getElementById('saAdminRow');
        if (selRow) {
          const roleSel = document.getElementById('saUserRole');
          const chosenRole = (roleSel && roleSel.value) ? roleSel.value : 'admin';
          const orgPicker = document.getElementById('superadminOrgPicker');
          const requireOrg = (chosenRole === 'admin' || chosenRole === 'volunteer');
          selRow.classList.toggle('hidden', requireOrg ? !orgPicker?.value : false);
        }
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select user —</option>';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          const label = u.name ? `${u.name} — ${u.email}` : u.email;
          opt.textContent = label;
          sel.appendChild(opt);
        });
        sel._users = users;
        if (current) sel.value = current;
        // Hide edit panel if selection cleared or missing user
        const panel = document.getElementById('saAdminEditPanel');
        if (panel && (!sel.value || !users.find(a => String(a.id) === sel.value))) panel.classList.add('hidden');
      } catch { /* silent */ }
    }
    async function populateVolunteerMgmt() {
      try {
        const orgVal = (role === 'superadmin') ? (document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || '') : (groupId != null ? String(groupId) : '');
        if (orgVal) setActiveTimeZoneForGroup(orgVal);
        else if (groupId != null) setActiveTimeZoneForGroup(groupId);
        // Admins don't pick org: ensure key rows are visible
        if (role !== 'superadmin') {
          const vRow0 = document.getElementById('vmVolunteerRow'); if (vRow0) vRow0.classList.remove('hidden');
          const eRow0 = document.getElementById('vmEditSelectRow'); if (eRow0) eRow0.classList.remove('hidden');
        }
        // Gate volunteer controls until org is selected for superadmin
        if (role === 'superadmin' && !orgVal) {
          const vSel = document.getElementById('vmVolunteer');
          if (vSel) { vSel.innerHTML = '<option value="">— Select organization first —</option>'; vSel.disabled = true; }
          const eSel = document.getElementById('vmEditSelect');
          if (eSel) { eSel.innerHTML = '<option value="">— Select organization first —</option>'; eSel.disabled = true; }
          const logBody = document.getElementById('vmLogList');
          if (logBody) logBody.innerHTML = '';
          // Also set Create Volunteer group to selected org when user picks it later
          const gSelInit = document.getElementById('vmVolGroup');
          if (gSelInit) gSelInit.value = '';
          return;
        }
        const volunteers = await fetchVolunteers(orgVal);
        const volSel = document.getElementById('vmVolunteer');
        if (volSel) {
          const current = volSel.value;
          // Always show volunteer placeholder (org gating handled earlier)
          volSel.innerHTML = '<option value="">— Select volunteer —</option>';
          // cache list and apply search filter
          volSel._all = volunteers;
          const search = document.getElementById('vmVolunteerSearch');
          const applyFilter = () => {
            const q = (search?.value || '').trim().toLowerCase();
            const list = volSel._all || [];
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            list.filter(v => !q || (v.name && v.name.toLowerCase().includes(q)) || (v.email && v.email.toLowerCase().includes(q)))
                .forEach(v => {
                  const opt = document.createElement('option');
                  opt.value = v.id;
                  opt.textContent = v.name ? `${v.name}` : v.email;
                  volSel.appendChild(opt);
                });
            if (current) volSel.value = current;
          };
          applyFilter();
          if (search && !search._wired) { search.addEventListener('input', applyFilter); search._wired = true; }
          // Always allow volunteer selection; the list is scoped by org when provided
          volSel.disabled = false;
          if (current) volSel.value = current;
          // Fallback: if nothing rendered, append all volunteers explicitly
          if (volSel.options.length <= 1 && (volSel._all && volSel._all.length)) {
            const cur2 = volSel.value;
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            (volSel._all || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volSel.appendChild(opt);
            });
            if (cur2) volSel.value = cur2;
          }
          // If still empty, surface an explicit empty-state so selection isn't silently blocked
          if (volSel.options.length <= 1) {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = '— No volunteers found —';
            volSel.appendChild(emptyOpt);
          }
          // Ensure we react when the user selects a volunteer
          if (!volSel._wiredChange) {
            volSel.addEventListener('change', () => {
              const selId = Number(volSel.value || 0);
              // Mirror into edit dropdown if present
              const editSel = document.getElementById('vmEditSelect');
              if (editSel) {
                // If the selected id is not in edit list yet, inject a temporary option so value sets
                if (selId && !Array.from(editSel.options).some(o => Number(o.value) === selId)) {
                  const v = (volSel._all || []).find(x => Number(x.id) === selId);
                  const opt = document.createElement('option');
                  opt.value = String(selId);
                  opt.text = v ? (v.name || v.email || String(selId)) : String(selId);
                  editSel.appendChild(opt);
                }
                editSel.value = selId ? String(selId) : '';
              }
            if (selId) {
              activeTimeZone = getVolunteerTimeZone(selId);
            }
              // Show edit row/panel if we have a selection
              const vmEditRow = document.getElementById('vmEditSelectRow');
              if (vmEditRow) vmEditRow.classList.toggle('hidden', !selId);
              const vmPanel = document.getElementById('vmEditPanel');
              if (vmPanel && selId) vmPanel.classList.remove('hidden');
              // Refresh logs for visibility
              refreshVolunteerLogs();
            });
            volSel._wiredChange = true;
          }
        }
        // Populate volunteer edit dropdown
        const editSel = document.getElementById('vmEditSelect');
        if (editSel) {
          const current = editSel.value;
          editSel.innerHTML = '<option value="">— Select volunteer —</option>';
          volunteers.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = `${v.id} — ${v.name || v.email}`;
            editSel.appendChild(opt);
          });
          if (current) editSel.value = current;
          if (!editSel._wired) {
            editSel.addEventListener('change', () => {
              const id = Number(editSel.value);
              const v = volunteers.find(x => x.id === id);
          if (!v) return;
              const panel = document.getElementById('vmEditPanel');
              if (panel) panel.classList.remove('hidden');
              document.getElementById('vmEditId').value = String(v.id);
              document.getElementById('vmEditName').value = v.name || '';
              document.getElementById('vmEditEmail').value = v.email || '';
              const pw = document.getElementById('vmEditPassword'); if (pw) pw.value = '';
              document.getElementById('vmEditPhone').value = v.phone || '';
              document.getElementById('vmEditAddress').value = v.address || '';
              // Mirror the edit selection into the top Volunteer dropdown so it always has options and selection
              try {
                const volTop = document.getElementById('vmVolunteer');
                if (volTop) {
                  volTop.innerHTML = '<option value="">— Select volunteer —</option>';
                  (volunteers || []).forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = u.name ? `${u.name}` : u.email;
                    volTop.appendChild(opt);
                  });
                  volTop.value = String(id);
                  volTop.disabled = false;
                }
              } catch { /* silent */ }
            });
            editSel._wired = true;
          }
          editSel.disabled = false;
          // Also seed the top Volunteer dropdown if it only has the placeholder
          const volTop = document.getElementById('vmVolunteer');
          if (volTop && volTop.options.length <= 1) {
            const cur = volTop.value;
            volTop.innerHTML = '<option value="">— Select volunteer —</option>';
            volunteers.forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volTop.appendChild(opt);
            });
            if (cur) volTop.value = cur;
          }
          // Show volunteer edit selector: superadmin only after org selected; admins always
          const vmEditRow = document.getElementById('vmEditSelectRow');
          if (vmEditRow) vmEditRow.classList.toggle('hidden', role === 'superadmin' ? !orgVal : false);
          // Ensure top Volunteer is always fully synced to the same list as the edit dropdown
          try {
            const volTop2 = document.getElementById('vmVolunteer');
            if (volTop2) {
              const keep2 = volTop2.value;
              // Copy the exact options from the edit dropdown so both show identical data
              volTop2.innerHTML = editSel.innerHTML;
              if (keep2) volTop2.value = keep2;
              volTop2.disabled = (role === 'superadmin') ? !orgVal : false;
            }
          } catch { /* silent */ }
        }
        // Groups for Create Volunteer
        const resG = await authed('/groups');
        const groups = await resG.json();
        const gSel = document.getElementById('vmVolGroup');
        if (gSel) {
          const current = gSel.value;
          gSel.innerHTML = '<option value="">— None —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            gSel.appendChild(opt);
          });
          if (current) gSel.value = current; else if (role === 'superadmin' && orgVal) gSel.value = String(orgVal); else if (groupId != null) gSel.value = String(groupId);
        }
        // Events list (current org) for cascade
        const vmEventRow = document.getElementById('vmEventRow');
        const vmEventSel = document.getElementById('vmEvent');
        if (role === 'superadmin') {
          if (vmEventRow) vmEventRow.classList.toggle('hidden', !orgVal);
          // Gate Duty/Volunteer placeholders firmly based on current cascade state
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          const hasOrgSelection = Boolean(orgVal);
          if (dutySel) {
            dutySel.disabled = !hasOrgSelection;
            dutySel.innerHTML = hasOrgSelection ? '<option value="">— Select duty —</option>' : '<option value="">— Select organization first —</option>';
          }
          if (volSel) {
            // Only disable/enable; don't wipe options that were already populated
            volSel.disabled = !hasOrgSelection;
            if (!hasOrgSelection && volSel.options.length <= 1) {
              volSel.innerHTML = '<option value="">— Select organization first —</option>';
            }
          }
        } else {
          // Admins: event row should be visible since org is implied; keep volunteers enabled
          if (vmEventRow) vmEventRow.classList.remove('hidden');
          const volSel = document.getElementById('vmVolunteer');
          if (volSel) { volSel.disabled = false; /* keep existing options */ }
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.remove('hidden');
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.remove('hidden');
          const logsRow = document.getElementById('vmLogsRow'); if (logsRow) logsRow.classList.remove('hidden');
        }
        let events = [];
        if (orgVal) {
          const resE = await authed(`/events?group_id=${encodeURIComponent(orgVal)}`);
          events = await resE.json();
        }
        if (vmEventSel) {
          const currentEvt = vmEventSel.value;
          vmEventSel.innerHTML = '<option value="">— Select event —</option>';
          events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.title || `Event #${e.id}`;
            vmEventSel.appendChild(opt);
          });
          if (currentEvt) vmEventSel.value = currentEvt;
          vmEventSel.disabled = !orgVal;
        }
        // Duties list (current org, optionally filter by selected event)
        let duties = [];
        if (orgVal) {
          const res = await authed(`/duties?group_id=${encodeURIComponent(orgVal)}`);
          duties = await res.json();
        }
        const eventFilterId = Number(document.getElementById('vmEvent')?.value || '') || null;
        // Only filter by event when duties actually carry event_id; include duties with no event_id linkage
        if (eventFilterId && duties.some(d => Object.prototype.hasOwnProperty.call(d, 'event_id')))
          duties = duties.filter(d => (d.event_id == null) || (Number(d.event_id) === eventFilterId));
        const dutySel = document.getElementById('vmDuty');
        if (dutySel) {
          const current = dutySel.value;
          dutySel.innerHTML = '<option value="">— Select duty —</option>';
          duties.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.id} — ${d.title}`;
            dutySel.appendChild(opt);
          });
          dutySel.disabled = !orgVal ? true : false;
          if (current) dutySel.value = current;
        }
        // Final safeguard: ensure the top Volunteer dropdown is fully populated for admins just like the edit list
        try {
          const volTopFinal = document.getElementById('vmVolunteer');
          if (volTopFinal) {
            const keep = volTopFinal.value;
            volTopFinal.disabled = (role === 'superadmin') ? !orgVal : false;
            volTopFinal.innerHTML = '<option value="">— Select volunteer —</option>';
            (volunteers || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volTopFinal.appendChild(opt);
            });
            if (keep) volTopFinal.value = keep;
          }
        } catch { /* silent */ }
      } catch { /* silent */ }
    }
    async function fetchVolunteerLogs(volunteerId) {
      try {
        const res = await authed(`/time-tracking?volunteer_id=${encodeURIComponent(volunteerId)}`);
        if (!res.ok) return [];
        return await res.json();
      } catch { return []; }
    }
    async function refreshVolunteerLogs() {
      const sel = document.getElementById('vmVolunteer');
      const tbody = document.getElementById('vmLogList');
      if (!sel || !tbody || !sel.value) { if (tbody) tbody.innerHTML=''; return; }
      const logs = await fetchVolunteerLogs(sel.value);
      tbody.innerHTML = '';
      const tz = getVolunteerTimeZone(Number(sel.value));
      logs.forEach(r => {
        const tr = document.createElement('tr');
        const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
        const statusLabel = r.approved ? 'Approved' : 'Pending';
        const approveCell = r.approved
          ? '<span>Approved</span>'
          : `<button type="button" class="vmApproveBtn" onclick="approve(${r.id})">Approve</button>`;
        tr.innerHTML =
          `<td data-label="ID">${r.id}</td>
           <td data-label="Duty">${formatDutyLabel(r.duty_id)}</td>
           <td data-label="Start">${formatDisplayDateTime(r.start_time, tz)}</td>
           <td data-label="End">${formatDisplayDateTime(r.end_time, tz)}</td>
           <td data-label="Hours">${hours}</td>
           <td data-label="Date">${r.duty_date || ''}</td>
           <td data-label="Status">${statusLabel}</td>
           <td data-label="Approve">${approveCell}</td>`;
        tbody.appendChild(tr);
      });
    }

    // APPROVAL QUEUE (admin)
    async function fetchApprovals() {
      if (role !== 'admin' && role !== 'superadmin') return;
      try {
        const res = await authed('/time-tracking');
        const rows = await res.json();
        const tbody = document.getElementById('approvalList');
        if (!tbody) return;
        tbody.innerHTML = '';
        rows.filter(r => !r.approved).forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          const volunteerLabel = formatVolunteerLabel(r);
          tr.innerHTML =
            `<td>${r.id}</td><td>${volunteerLabel}</td><td>${hours}</td><td>${r.duty_date || ''}</td>
             <td><button onclick="approve(${r.id})">Approve</button></td>
             <td><button onclick="rejectApproval(${r.id})">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      } catch (e) { /* silent */ }
    }
    async function approve(id) {
      try {
        const res = await authed(`/time-tracking/${id}/approve`, { method: 'POST' });
        if (res.ok) {
          await fetchApprovals();
          await fetchAdminTimes();
          await refreshClockAdminTimes();
          await refreshVolunteerLogs();
          await fetchTimeTracking();
          showActionStatus('Time entry approved.');
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to approve time entry');
          showActionStatus(data.message || 'Failed to approve time entry', true);
        }
      } catch (e) {
        alert('Error approving time entry');
        showActionStatus('Error approving time entry', true);
      }
    }
    async function rejectApproval(id) {
      if (!confirm('Delete this pending time log?')) return;
      try {
        const res = await authed(`/time-tracking/${id}`, { method: 'DELETE' });
        if (res.ok) {
          await fetchApprovals();
          await fetchAdminTimes();
          showActionStatus('Time entry deleted.');
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to delete time entry');
          showActionStatus(data.message || 'Failed to delete time entry', true);
        }
      } catch {
        alert('Error deleting time entry');
        showActionStatus('Error deleting time entry', true);
      }
    }

    // ADMIN TIMES TABLE
    async function fetchAdminTimes() {
      if (role !== 'admin' && role !== 'superadmin') return;
      const isSuperadmin = role === 'superadmin';
      const tbody = isSuperadmin
        ? document.getElementById('superAdminTimeList')
        : document.getElementById('adminTimeList');
      const hint = isSuperadmin
        ? document.getElementById('superTimeVolunteerHint')
        : document.getElementById('adminTimeVolunteerHint');
      if (!tbody) return;
      const showTableHint = (message) => {
        const columns = 12;
        tbody.innerHTML = message ? `<tr><td colspan="${columns}" class="hint">${message}</td></tr>` : '';
      };
      if (isSuperadmin) {
        const orgPicker = document.getElementById('superadminOrgPicker');
        if (!orgPicker?.value) {
          showTableHint('Select an organization to view time logs.');
          if (hint) hint.textContent = 'Select an organization to load volunteers.';
          return;
        }
      }
      const selectedIds = isSuperadmin ? getSelectedSuperVolunteerIds() : getSelectedAdminVolunteerIds();
      if (selectedIds.length === 0) {
        showTableHint('Select one or more volunteers to view time logs.');
        if (hint) hint.textContent = 'Select one or more volunteers to view logs.';
        return;
      }
      if (hint) hint.textContent = '';
      showTableHint('Loading time logs…');
      timeEntryTimeZoneById = {};
      const rows = [];
      for (const volunteerId of selectedIds) {
        try {
          const res = await authed(`/time-tracking?volunteer_id=${encodeURIComponent(volunteerId)}`);
          if (!res.ok) continue;
          const data = await res.json();
          rows.push(...data);
        } catch { /* ignore */ }
      }
      rows.sort((a, b) => {
        const aTime = a.start_time ? Date.parse(a.start_time) : 0;
        const bTime = b.start_time ? Date.parse(b.start_time) : 0;
        return bTime - aTime;
      });
      tbody.innerHTML = '';
      if (!rows.length) {
        showTableHint('No time logs found for the selected volunteers.');
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
        const tz = getVolunteerTimeZone(r.volunteer_id);
        timeEntryTimeZoneById[r.id] = tz;
        const volunteerLabel = formatVolunteerLabel(r);
        const assignment = describeAssignment(r);
        const statusLabel = r.approved ? 'Approved' : 'Pending';
        const approveCell = r.approved
          ? '<span>Approved</span>'
          : `<button type="button" class="approve-btn" onclick="approve(${r.id})">Approve</button>`;
        tr.innerHTML =
          `<td>${r.id}</td>
           <td>${volunteerLabel}</td>
           <td>${assignment.eventLabel || '-'}</td>
           <td>${assignment.dutyLabel || '-'}</td>
           <td><input type="datetime-local" id="start-${r.id}" value="${formatDateTimeLocal(r.start_time, tz)}"></td>
           <td><input type="datetime-local" id="end-${r.id}" value="${formatDateTimeLocal(r.end_time, tz)}"></td>
           <td>${hours}</td>
           <td><input type="date" id="date-${r.id}" value="${formatDateLocal(r.duty_date)}"></td>
           <td>${statusLabel}</td>
           <td>${approveCell}</td>
           <td><button onclick="saveTime(${r.id})">Save</button></td>
           <td><button onclick="deleteTime(${r.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function formatDateTimeLocal(iso, tz) {
      return convertUtcToLocalInput(iso, tz || activeTimeZone);
    }
    function formatDateLocal(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    async function saveTime(id) {
      try {
        const tz = timeEntryTimeZoneById[id] || activeTimeZone;
        const startLocal = document.getElementById(`start-${id}`).value || null;
        const endLocal = document.getElementById(`end-${id}`).value || null;
        const payload = {
          start_time: startLocal ? convertLocalInputToUtc(startLocal, tz) : null,
          end_time: endLocal ? convertLocalInputToUtc(endLocal, tz) : null,
          duty_date: document.getElementById(`date-${id}`).value || null,
        };
        const res = await authed(`/time-tracking/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          fetchAdminTimes();
          fetchTimeTracking();
          fetchApprovals();
          showActionStatus('Time entry saved.');
          invalidateCalendarSchedule(calendarState.activeDateKey, { refresh: true });
        }
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to save');
          showActionStatus(data.message || 'Failed to save time entry', true);
        }
      } catch { alert('Error saving'); showActionStatus('Error saving time entry', true); }
    }
    async function deleteTime(id) {
      if (!confirm('Delete this time log?')) return;
      try {
        const res = await authed(`/time-tracking/${id}`, { method: 'DELETE' });
        if (res.ok) {
          fetchAdminTimes();
          fetchTimeTracking();
          fetchApprovals();
          showActionStatus('Time entry deleted.');
          invalidateCalendarSchedule(calendarState.activeDateKey, { refresh: true });
        }
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to delete');
          showActionStatus(data.message || 'Failed to delete time entry', true);
        }
      } catch { alert('Error deleting'); showActionStatus('Error deleting time entry', true); }
    }
    async function saveClockAdjustTime(id) {
      try {
        const tz = timeEntryTimeZoneById[id] || activeTimeZone;
        const startLocal = document.getElementById(`clock-start-${id}`)?.value || null;
        const endLocal = document.getElementById(`clock-end-${id}`)?.value || null;
        const payload = {
          start_time: startLocal ? convertLocalInputToUtc(startLocal, tz) : null,
          end_time: endLocal ? convertLocalInputToUtc(endLocal, tz) : null,
          duty_date: document.getElementById(`clock-date-${id}`)?.value || null,
        };
        const res = await authed(`/time-tracking/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          await refreshClockAdminTimes();
          await fetchApprovals();
          showActionStatus('Volunteer time saved.');
          invalidateCalendarSchedule(calendarState.activeDateKey, { refresh: true });
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to save');
          showActionStatus(data.message || 'Failed to save volunteer time', true);
        }
      } catch { alert('Error saving'); showActionStatus('Error saving volunteer time', true); }
    }
    async function deleteClockAdjustTime(id) {
      if (!confirm('Delete this time log?')) return;
      try {
        const res = await authed(`/time-tracking/${id}`, { method: 'DELETE' });
        if (res.ok) {
          await refreshClockAdminTimes();
          await fetchApprovals();
          showActionStatus('Volunteer time deleted.');
          invalidateCalendarSchedule(calendarState.activeDateKey, { refresh: true });
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to delete');
          showActionStatus(data.message || 'Failed to delete volunteer time', true);
        }
      } catch { alert('Error deleting'); showActionStatus('Error deleting volunteer time', true); }
    }
    

    // Profile
    async function loadMe() {
      try {
        const res = await authed('/me');
        if (!res.ok) return;
        const me = await res.json();
        document.getElementById('acctName').value = me.name || '';
        document.getElementById('acctEmail').value = me.email || '';
        document.getElementById('acctPhone').value = me.phone || '';
        document.getElementById('acctAddress').value = me.address || '';
      } catch { /* silent */ }
    }

    document.getElementById('saveAccountInfo')?.addEventListener('click', async () => {
      document.getElementById('accountInfoError').textContent = '';
      try {
        const res = await authed('/account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: document.getElementById('acctName').value.trim(),
            email: document.getElementById('acctEmail').value.trim(),
            phone: document.getElementById('acctPhone').value.trim(),
            address: document.getElementById('acctAddress').value.trim(),
          })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('accountInfoError').textContent = data.message || 'Failed to save profile';
          return;
        }
        document.getElementById('accountInfoError').textContent = '';
      } catch {
        document.getElementById('accountInfoError').textContent = 'Error saving profile';
      }
    });
    document.getElementById('saveBrandingBtn')?.addEventListener('click', async () => {
      if (role !== 'admin') return;
      setBrandingStatus('');
      try {
        const payload = collectBrandingFormValues();
        const res = await authed('/branding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setBrandingStatus(data.message || 'Failed to save branding', true);
          return;
        }
        await loadBrandingForCurrentGroup({ populateForm: true });
        setBrandingStatus('Branding saved.');
        showActionStatus('Branding updated.');
      } catch {
        setBrandingStatus('Error saving branding', true);
      }
    });
    document.getElementById('resetBrandingBtn')?.addEventListener('click', async () => {
      if (role !== 'admin') return;
      if (!confirm('Reset your branding back to the default theme?')) return;
      setBrandingStatus('');
      try {
        const res = await authed('/branding', { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setBrandingStatus(data.message || 'Failed to reset branding', true);
          return;
        }
        await loadBrandingForCurrentGroup({ populateForm: true });
        setBrandingStatus('Branding reset to default.');
        showActionStatus('Branding reset.');
      } catch {
        setBrandingStatus('Error resetting branding', true);
      }
    });
    wireBrandingFileInputs();
    const brandingToggleBtn = document.getElementById('brandingToggleBtn');
    const brandingSettings = document.getElementById('brandingSettings');
    const brandingToggleRow = document.getElementById('brandingToggleRow');
    if (brandingToggleBtn && brandingSettings) {
      brandingToggleBtn.addEventListener('click', () => {
        brandingSettings.classList.toggle('hidden');
        if (brandingToggleRow) brandingToggleRow.classList.remove('hidden');
        brandingToggleBtn.textContent = brandingSettings.classList.contains('hidden')
          ? 'Show Organization Branding'
          : 'Hide Organization Branding';
      });
    }

    optionalFieldControls.eventAddress = setupOptionalFieldToggle({
      buttonId: 'eventAddressToggle',
      fieldId: 'eventAddressField',
      inputId: 'eventAddress',
      showLabel: 'Add Event Address',
      hideLabel: 'Remove Event Address',
    });
    optionalFieldControls.dutyLocation = setupOptionalFieldToggle({
      buttonId: 'dutyLocationToggle',
      fieldId: 'dutyLocationField',
      inputId: 'dutyLocation',
      showLabel: 'Add Duty Location',
      hideLabel: 'Remove Duty Location',
    });
    optionalFieldControls.volDutyLocation = setupOptionalFieldToggle({
      buttonId: 'volDutyLocationToggle',
      fieldId: 'volDutyLocationField',
      inputId: 'volDutyLocation',
      showLabel: 'Add Duty Location',
      hideLabel: 'Remove Duty Location',
    });
    optionalFieldControls.editDutyLocation = setupOptionalFieldToggle({
      buttonId: 'editDutyLocationToggle',
      fieldId: 'editDutyLocationField',
      inputId: 'editDutyLocation',
      showLabel: 'Add Duty Location',
      hideLabel: 'Remove Duty Location',
    });

    // (Per-user theming removed)

    // NAVIGATION / TOOLBAR
    function hideMainSections() {
      ['infoSection','superadminSection','homeSection','createDutySection','clockSection','eventsSection','calendarSection','adminSection','volMgmtSection'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }
    function navigateTo(sectionId) {
      hideMainSections();
      show(sectionId);
    }
    function setupToolbar(currentRole) {
      async function showEditableOrgInfoPanel(selectedId) {
        const infoWrap = document.getElementById('superadminOrgInfo');
        const infoBody = document.getElementById('superadminOrgInfoBody');
        if (!infoWrap || !infoBody) return;
        if (!selectedId) { infoBody.innerHTML=''; infoWrap.classList.add('hidden'); return; }
        // Ensure header has Save/Archive/Delete cols
        const table = infoWrap.querySelector('table thead tr');
        if (table) {
          const headers = Array.from(table.children).map(th => th.textContent?.toLowerCase?.() || '');
          if (!headers.includes('save')) { const th = document.createElement('th'); th.textContent = 'Save'; table.appendChild(th); }
          if (!headers.includes('archive')) { const thA = document.createElement('th'); thA.textContent = 'Archive'; table.appendChild(thA); }
          if (!headers.includes('delete')) { const thD = document.createElement('th'); thD.textContent = 'Delete'; table.appendChild(thD); }
        }
        // Load groups to get status
        let group = null;
        try {
          const res = await authed('/groups');
          if (res.ok) {
            const groups = await res.json();
            group = groups.find(g => String(g.id) === String(selectedId));
          }
        } catch {}
        const name = group?.name || (document.getElementById('superadminOrgPicker')?.options[document.getElementById('superadminOrgPicker')?.selectedIndex || 0]?.textContent || '');
        const status = (group?.status ?? group?.group_status ?? 'active').toString().toLowerCase();
        infoBody.innerHTML = `<tr>
            <td>${selectedId}</td>
            <td><input id="saOrgName" type="text" value="${name.replace(/"/g,'&quot;')}"></td>
            <td>
              <select id="saOrgStatus">
                <option value="active" ${status==='active'?'selected':''}>active</option>
                <option value="inactive" ${status==='inactive'?'selected':''}>inactive</option>
              </select>
            </td>
            <td><select id="saOrgTimeZone"></select></td>
            <td><button id="saOrgSaveBtn">Save</button></td>
            <td><button id="saOrgArchiveBtn">Archive</button></td>
            <td><button id="saOrgDeleteBtn" style="color:#b00020">Delete</button></td>
          </tr>`;
        infoWrap.classList.remove('hidden');
        const errEl = document.getElementById('superadminOrgInfoErr'); if (errEl) errEl.textContent='';
        populateTimeZoneSelect(document.getElementById('saOrgTimeZone'), group?.time_zone || DEFAULT_TIME_ZONE);
        const save = document.getElementById('saOrgSaveBtn');
        if (save) {
          save.onclick = async () => {
            const nameVal = document.getElementById('saOrgName')?.value.trim();
            const statusVal = document.getElementById('saOrgStatus')?.value;
            const tzVal = document.getElementById('saOrgTimeZone')?.value || DEFAULT_TIME_ZONE;
            if (errEl) errEl.textContent='';
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: nameVal, status: statusVal, time_zone: tzVal }) });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (errEl) errEl.textContent = data.message || 'Failed to save'; showActionStatus(data.message || 'Failed to save organization', true); return; }
              // Reflect updated values in picker
              const picker = document.getElementById('superadminOrgPicker');
              if (picker && nameVal) {
                const opt = Array.from(picker.options).find(o => o.value === String(selectedId));
                if (opt) opt.textContent = nameVal;
              }
              showActionStatus('Organization saved.');
            } catch { if (errEl) errEl.textContent = 'Error saving'; showActionStatus('Error saving organization', true); }
          };
        }
        const archiveBtn = document.getElementById('saOrgArchiveBtn');
        if (archiveBtn) {
          archiveBtn.onclick = async () => {
            if (!confirm('Archive this organization? It will be marked inactive and hidden from selection. Continue?')) return;
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'inactive' }) });
              if (!res.ok) { const d = await res.json().catch(()=>({})); if (errEl) errEl.textContent = d.message || 'Failed to archive'; return; }
              if (errEl) errEl.textContent = '';
              fetchGroups();
            } catch { if (errEl) errEl.textContent = 'Error archiving'; }
          };
        }
        const deleteBtn = document.getElementById('saOrgDeleteBtn');
        if (deleteBtn) {
          deleteBtn.onclick = async () => {
            if (!confirm('Delete this organization? This permanently removes it. You can archive instead. Continue to delete?')) return;
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'DELETE' });
              if (!res.ok) { const d = await res.json().catch(()=>({})); if (errEl) errEl.textContent = d.message || 'Failed to delete'; return; }
              if (errEl) errEl.textContent = '';
              // Clear picker after delete
              const picker = document.getElementById('superadminOrgPicker'); if (picker) picker.value = '';
              fetchGroups();
            } catch { if (errEl) errEl.textContent = 'Error deleting'; }
          };
        }
      }
      const tb = document.getElementById('toolbar');
      if (!tb) return;
      // Toolbar ready; rely on DOM order
      tb.classList.remove('hidden');
      const isVolunteer = currentRole === 'volunteer';
      const isAdminish = currentRole === 'admin' || currentRole === 'superadmin';
      const brandingWrap = document.getElementById('brandingSettings');
      const brandingToggleRow = document.getElementById('brandingToggleRow');
      const brandingToggleBtn = document.getElementById('brandingToggleBtn');
      if (brandingWrap) {
        const shouldShow = currentRole === 'admin';
        if (shouldShow) {
          brandingWrap.classList.add('hidden');
          if (brandingToggleRow) brandingToggleRow.classList.remove('hidden');
          if (brandingToggleBtn) brandingToggleBtn.textContent = 'Show Organization Branding';
        } else {
          brandingWrap.classList.add('hidden');
          if (brandingToggleRow) brandingToggleRow.classList.add('hidden');
        }
      }
      const templatePanel = document.getElementById('dutyTemplatePanel');
      if (templatePanel) templatePanel.classList.toggle('hidden', !isAdminish);
      const templateGroupRow = document.getElementById('dutyTemplateGroupRow');
      const templateGroupSel = document.getElementById('dutyTemplateGroup');
      if (templateGroupRow) templateGroupRow.classList.toggle('hidden', currentRole !== 'superadmin');
      if (templateGroupSel) {
        templateGroupSel.disabled = currentRole !== 'superadmin';
        if (currentRole !== 'superadmin' && groupId != null) {
          templateGroupSel.value = String(groupId);
        }
      }
      // Hard reset of cross-page dropdown selections
      function resetGlobalFilters() {
        // Superadmin global pickers
        const sap = document.getElementById('superadminOrgPicker'); if (sap) sap.value = '';
        const sdf = document.getElementById('superDutyGroupFilter'); if (sdf) sdf.value = '';
        const sef = document.getElementById('superEventGroupFilter'); if (sef) sef.value = '';
        const evf = document.getElementById('eventsSuperFilter'); if (evf) evf.value = '';
        // Create Duty/Edit Duty dependent selects
        const deSel = document.getElementById('dutyEditSelect'); if (deSel) { deSel.innerHTML = '<option value="">— Select duty —</option>'; deSel.disabled = true; }
        // Volunteer Mgmt selections/rows
        const vmOrg = document.getElementById('vmOrgPicker'); if (vmOrg) vmOrg.value = '';
        const vmEvt = document.getElementById('vmEvent'); if (vmEvt) vmEvt.innerHTML = '<option value="">— Select event —</option>';
        const vmDuty = document.getElementById('vmDuty'); if (vmDuty) { vmDuty.innerHTML = '<option value="">— Select organization first —</option>'; vmDuty.disabled = true; }
        const vmVol = document.getElementById('vmVolunteer'); if (vmVol) { vmVol.innerHTML = '<option value="">— Select volunteer —</option>'; vmVol.disabled = false; }
        const vmEditSel = document.getElementById('vmEditSelect'); if (vmEditSel) vmEditSel.innerHTML = '<option value="">— Select volunteer —</option>';
        const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', currentRole === 'superadmin');
        const eRow = document.getElementById('vmEventRow'); if (eRow) eRow.classList.toggle('hidden', currentRole === 'superadmin');
        const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
        const vmPanel = document.getElementById('vmEditPanel'); if (vmPanel) vmPanel.classList.add('hidden');
        const templateModeSel = document.getElementById('dutyTemplateMode');
        if (templateModeSel) {
          templateModeSel.value = 'use';
          updateDutyTemplateModeUI();
        }
        const templateSelect = document.getElementById('dutyTemplateSelect'); if (templateSelect) templateSelect.selectedIndex = 0;
        const templateGroupClear = document.getElementById('dutyTemplateGroup');
        if (templateGroupClear && currentRole === 'superadmin') templateGroupClear.value = '';
        setDutyTemplateStatus('');
        resetCalendarView();
      }
      document.getElementById('navAdminBtn').classList.toggle('hidden', !isAdminish);
      document.getElementById('navVolunteerMgmtBtn').classList.toggle('hidden', !isAdminish);
      document.getElementById('navCreateDutyBtn').classList.toggle('hidden', !isAdminish);
      // Show Time Clock and Photos for volunteers AND admins/superadmins
      document.getElementById('navClockBtn').classList.toggle('hidden', !(isVolunteer || isAdminish));
      document.getElementById('navHomeBtn').onclick = () => { resetGlobalFilters(); navigateTo('homeSection'); };
      function resetVolunteerMgmtUI() {
        const orgRow = document.getElementById('vmSuperOrgRow');
        const orgSel = document.getElementById('vmOrgPicker');
        const evtRow = document.getElementById('vmEventRow');
        const evtSel = document.getElementById('vmEvent');
        const dutySel = document.getElementById('vmDuty');
        const volSel = document.getElementById('vmVolunteer');
        const search = document.getElementById('vmVolunteerSearch');
        const logs = document.getElementById('vmLogList');
        const editPanel = document.getElementById('vmEditPanel');
        if (orgRow) orgRow.classList.add('hidden');
        if (orgSel) orgSel.value = '';
        if (evtRow) evtRow.classList.toggle('hidden', currentRole === 'superadmin');
        if (evtSel) { evtSel.innerHTML = '<option value="">— Select event —</option>'; evtSel.disabled = true; }
        if (dutySel) { dutySel.disabled = true; dutySel.innerHTML = '<option value="">— Select organization first —</option>'; }
        if (volSel) { volSel.disabled = (currentRole === 'superadmin'); volSel.innerHTML = '<option value="">— Select volunteer —</option>'; }
        if (search) search.value = '';
        if (logs) logs.innerHTML = '';
        if (editPanel) editPanel.classList.add('hidden');
        const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', currentRole === 'superadmin');
        const editRow = document.getElementById('vmEditSelectRow'); if (editRow) editRow.classList.toggle('hidden', currentRole === 'superadmin');
        const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
      }
      document.getElementById('navAdminBtn').onclick = () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo(currentRole === 'superadmin' ? 'superadminSection' : 'adminSection');
        // Immediately populate volunteer management so the dropdown is ready
        populateVolunteerMgmt();
        const table = document.getElementById('groupTable');
        if (table) table.classList.add('hidden');
        const infoWrap = document.getElementById('superadminOrgInfo');
        const infoBody = document.getElementById('superadminOrgInfoBody');
        if (infoWrap && infoBody) {
          const picker = document.getElementById('superadminOrgPicker');
          if (picker && picker.value) {
            showEditableOrgInfoPanel(picker.value);
          } else {
            infoBody.innerHTML = '';
            infoWrap.classList.add('hidden');
          }
        }
      };
      // Wire superadmin org picker to filter-linked UI pieces
      const orgPicker = document.getElementById('superadminOrgPicker');
      if (orgPicker && !orgPicker._wired) {
        orgPicker.addEventListener('change', () => {
          // Keep superadmin page pickers in sync
          const eFilter = document.getElementById('superEventGroupFilter');
          if (eFilter) eFilter.value = orgPicker.value || '';
          const dFilter = document.getElementById('superDutyGroupFilter');
          if (dFilter) dFilter.value = orgPicker.value || '';
          setActiveTimeZoneForGroup(orgPicker.value || null);
          // Update single-org info panel and keep full table hidden
          const infoWrap = document.getElementById('superadminOrgInfo');
          const infoBody = document.getElementById('superadminOrgInfoBody');
          const table = document.getElementById('groupTable');
          if (table) table.classList.add('hidden');
          if (infoWrap && infoBody) { showEditableOrgInfoPanel(orgPicker.value); }
          // Refresh pages that depend on org
          fetchEvents();
          fetchDuties();
          populateEventDropdownsForGroup(orgPicker.value);
          // Refresh User Management list when org changes
          populateSuperadminUsers();
          const selRow = document.getElementById('saAdminRow');
          if (selRow) {
            const roleSel2 = document.getElementById('saUserRole');
            const chosenRole2 = (roleSel2 && roleSel2.value) ? roleSel2.value : 'admin';
            const requireOrg2 = (chosenRole2 === 'admin' || chosenRole2 === 'volunteer');
            selRow.classList.toggle('hidden', requireOrg2 ? !orgPicker.value : false);
          }
          // Refresh Volunteer Mgmt scoped to org
          populateVolunteerMgmt();
          refreshVolunteerLogs();
          populateSuperTimeVolunteerSelect();
          fetchApprovals();
        });
        orgPicker._wired = true;
      }
      // Wire VM org picker to duty/volunteer cascading
      const vmOrgSel = document.getElementById('vmOrgPicker');
      if (vmOrgSel && !vmOrgSel._wired) {
        vmOrgSel.addEventListener('change', async () => {
          // On change: enable event row, gate others, and reload data for this org
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          if (dutySel) { dutySel.disabled = true; dutySel.innerHTML = '<option value="">— Select event —</option>'; }
          if (volSel) { volSel.disabled = false; volSel.innerHTML = '<option value="">— Select volunteer —</option>'; }
          const evtSel = document.getElementById('vmEvent');
          const evtRow = document.getElementById('vmEventRow');
          if (evtRow) evtRow.classList.toggle('hidden', !vmOrgSel.value);
          if (evtSel) { evtSel.disabled = !vmOrgSel.value; evtSel.innerHTML = '<option value="">— Select event —</option>'; }
          setActiveTimeZoneForGroup(vmOrgSel.value || null);
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.toggle('hidden', currentRole === 'superadmin');
          const vmEditPanel = document.getElementById('vmEditPanel'); if (vmEditPanel) vmEditPanel.classList.add('hidden');
          // Sync top superadmin pickers
          const dFilter = document.getElementById('superDutyGroupFilter'); if (dFilter) dFilter.value = vmOrgSel.value || '';
          const eFilter = document.getElementById('superEventGroupFilter'); if (eFilter) eFilter.value = vmOrgSel.value || '';
          await populateVmEventsByOrg(vmOrgSel.value);
          await populateVolunteerMgmt();
          await populateVmDutiesByOrgAndEvent(vmOrgSel.value, document.getElementById('vmEvent')?.value || null);
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', !vmOrgSel.value);
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
          await refreshVolunteerLogs();
        });
        vmOrgSel._wired = true;
      }

      // When an event is chosen, reload duties filtered by event and enable volunteer once duty chosen later
      const vmEventSel2 = document.getElementById('vmEvent');
      if (vmEventSel2 && !vmEventSel2._wired) {
        vmEventSel2.addEventListener('change', async () => {
          const volSel = document.getElementById('vmVolunteer');
          const dutySel = document.getElementById('vmDuty');
          if (volSel) { volSel.disabled = false; }
          if (dutySel) { dutySel.disabled = !vmEventSel2.value; }
          await populateVolunteerMgmt();
          // Determine org id for admins and superadmins
          const gidForDuties =
            (currentRole === 'superadmin')
              ? (document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || null)
              : (groupId != null ? String(groupId) : null);
          await populateVmDutiesByOrgAndEvent(gidForDuties, vmEventSel2.value || null);
          // Explicitly enable duty select when we have an event and org context
          if (dutySel) { dutySel.disabled = !(gidForDuties && vmEventSel2.value); }
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.toggle('hidden', currentRole === 'superadmin');
          const vmEditPanel = document.getElementById('vmEditPanel'); if (vmEditPanel) vmEditPanel.classList.add('hidden');
        });
        vmEventSel2._wired = true;
      }
      // When a duty is chosen, unlock volunteer selection
      const vmDutySel = document.getElementById('vmDuty');
      if (vmDutySel && !vmDutySel._wired) {
        vmDutySel.addEventListener('change', () => {
          const volSel = document.getElementById('vmVolunteer');
          if (volSel) {
            // Keep volunteer selectable regardless of duty; only superadmin without org should be gated
            const hasOrg = !!document.getElementById('vmOrgPicker')?.value || !!document.getElementById('superadminOrgPicker')?.value;
            volSel.disabled = (currentRole === 'superadmin') ? !hasOrg : false;
          }
          // Show edit select only once duty is chosen and org+event exist
          const hasOrg = (currentRole !== 'superadmin') || !!document.getElementById('vmOrgPicker')?.value || !!document.getElementById('superadminOrgPicker')?.value;
          const hasEvent = !!document.getElementById('vmEvent')?.value;
          const vmEditRow = document.getElementById('vmEditSelectRow');
          if (vmEditRow) vmEditRow.classList.toggle('hidden', !(hasOrg && hasEvent && vmDutySel.value));
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.toggle('hidden', !(hasOrg && hasEvent && vmDutySel.value));
        });
        vmDutySel._wired = true;
      }
      document.getElementById('navCreateDutyBtn').onclick = () => {
        if (!isAdminish) { return; }
        navigateTo('createDutySection');
        document.getElementById('createDutyAdmin').classList.toggle('hidden', !isAdminish);
        const volRow = document.getElementById('createDutyVol');
        if (volRow) volRow.classList.add('hidden');
        document.getElementById('dutyEditSelectorWrap').classList.toggle('hidden', !isAdminish);
        // Keep Edit Duty hidden until a duty is selected to edit
        const dutyEdit = document.getElementById('dutyEditWrap');
        if (dutyEdit) dutyEdit.classList.add('hidden');
        // Superadmin must pick org to view duties
        const dFilter = document.getElementById('dutiesSuperFilter');
        if (dFilter) dFilter.classList.toggle('hidden', currentRole !== 'superadmin');
        if (currentRole === 'superadmin') {
          const gSel = document.getElementById('superDutyGroupFilter');
          const editSel = document.getElementById('dutyEditSelect');
          const vmDutySel = document.getElementById('vmDuty');
          const needsOrg = !(gSel && gSel.value);
          if (editSel) { editSel.innerHTML = `<option value="">${needsOrg ? '— Select organization first —' : '— Select duty —'}</option>`; editSel.disabled = needsOrg; }
          if (vmDutySel) { vmDutySel.innerHTML = `<option value=\"\">${needsOrg ? '— Select organization first —' : '— Select duty —'}</option>`; vmDutySel.disabled = needsOrg; }
        }
        // Ensure duty event dropdowns reflect selected org context
        const gid = (currentRole === 'superadmin') ? (document.getElementById('superDutyGroupFilter')?.value || '') : (groupId != null ? String(groupId) : '');
        populateEventDropdownsForGroup(gid);
        // Populate duties list/select for current org context
        fetchDuties();
      };
      document.getElementById('navEventsBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('eventsSection');
        // Show create form only for admins/superadmins
        const wrap = document.getElementById('eventsCreateWrap');
        if (wrap) wrap.classList.toggle('hidden', !isAdminish);
        const actionsHeader = document.getElementById('eventActionsHeader');
        if (actionsHeader) actionsHeader.classList.toggle('hidden', !isAdminish);
        const joinHeader = document.getElementById('eventJoinHeader');
        if (joinHeader) joinHeader.classList.toggle('hidden', currentRole !== 'volunteer');
        // Keep edit form hidden until an event is selected to edit
        const editWrap = document.getElementById('eventEditWrap');
        if (editWrap) editWrap.classList.add('hidden');
        // Superadmin must pick org to view events
        const eFilter = document.getElementById('eventsSuperFilter');
        if (eFilter) eFilter.classList.toggle('hidden', currentRole !== 'superadmin');
        await fetchEvents();
      };
      document.getElementById('navCalendarBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('calendarSection');
        const filterRow = document.getElementById('calendarFilterRow');
        const orgCol = document.getElementById('calendarOrgFilterCol');
        const filterHint = document.getElementById('calendarFilterHint');
        const groupSel = document.getElementById('calendarGroupFilter');
        if (currentRole === 'superadmin') {
          if (filterRow) filterRow.classList.remove('hidden');
          if (orgCol) orgCol.classList.remove('hidden');
          if (groupSel) groupSel.disabled = false;
          if (filterHint) filterHint.textContent = 'View all organizations or narrow to one.';
        } else {
          if (orgCol) orgCol.classList.add('hidden');
          if (groupSel) {
            groupSel.disabled = true;
            if (groupId != null) groupSel.value = String(groupId);
          }
          if (filterHint) {
            filterHint.textContent = currentRole === 'admin'
              ? 'Calendar is scoped to your organization.'
              : 'Calendar is read-only for volunteers.';
          }
        }
        updateCalendarMonthLabel();
        renderCalendar();
        if (calendarState.needsRefresh) {
          await refreshCalendarEvents();
        } else {
          showCalendarStatus('');
        }
        calendarState.needsRefresh = false;
      };
      document.getElementById('navClockBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('clockSection');
        const isAdminishClock = currentRole === 'admin' || currentRole === 'superadmin';
        const filterRow = document.getElementById('clockSuperFilter');
        if (filterRow) filterRow.classList.add('hidden');
          const dutiesWrap = document.getElementById('clockDutiesWrap');
          const timesWrap = document.getElementById('clockTimesWrap');
        const adjustWrap = document.getElementById('clockAdminAdjustWrap');
        if (dutiesWrap) dutiesWrap.classList.toggle('hidden', isAdminishClock);
        if (timesWrap) timesWrap.classList.toggle('hidden', isAdminishClock);
        if (adjustWrap) adjustWrap.classList.toggle('hidden', !isAdminishClock);
        const note = document.getElementById('clockSuperNote');
        if (note) note.textContent = '';
        if (isAdminishClock) {
          const orgRow = document.getElementById('clockAdminOrgRow');
          if (orgRow) orgRow.classList.toggle('hidden', currentRole !== 'superadmin');
          if (currentRole === 'superadmin') {
            await populateClockAdminOrgPicker();
          } else {
            await populateClockAdminVolunteersByOrg(groupId != null ? String(groupId) : '');
          }
          return;
        }
        await fetchDuties();
        await fetchTimeTracking();
      };

      document.getElementById('navVolunteerMgmtBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('volMgmtSection');
        // Superadmin: show VM org picker and load groups
        const vmOrgRow = document.getElementById('vmSuperOrgRow');
        const vmOrgSel = document.getElementById('vmOrgPicker');
        if (currentRole === 'superadmin') {
          if (vmOrgRow) vmOrgRow.classList.remove('hidden');
          try {
            const res = await authed('/groups');
            const groups = await res.json();
            if (vmOrgSel) {
              const current = vmOrgSel.value;
              vmOrgSel.innerHTML = '<option value="">— Select organization —</option>';
              groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                vmOrgSel.appendChild(opt);
              });
              if (current) vmOrgSel.value = current;
              // mirror top superadmin org if already chosen
              const topOrg = document.getElementById('superadminOrgPicker');
              if (topOrg && topOrg.value && !vmOrgSel.value) vmOrgSel.value = topOrg.value;
            }
          } catch { /* silent */ }
          // Gate duty/volunteer selects until org chosen
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          if (dutySel) { dutySel.innerHTML = '<option value="">— Select organization first —</option>'; dutySel.disabled = true; }
          if (volSel) { volSel.innerHTML = '<option value="">— Select organization first —</option>'; volSel.disabled = true; }
          // If org was mirrored above, trigger change to load
          if (vmOrgSel && vmOrgSel.value) { const evt = new Event('change'); vmOrgSel.dispatchEvent(evt); }
        } else {
          if (vmOrgRow) vmOrgRow.classList.add('hidden');
        }
          await populateVolunteerMgmt();
          // Force-show key rows for admins (org implied by their group)
          const eRow = document.getElementById('vmEventRow'); if (eRow) eRow.classList.remove('hidden');
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.remove('hidden');
          const editRow = document.getElementById('vmEditSelectRow'); if (editRow) editRow.classList.remove('hidden');
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
        await refreshVolunteerLogs();
      };
      document.getElementById('navAccountBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('infoSection');
        if (currentRole === 'admin') {
          await loadBrandingForCurrentGroup({ populateForm: true });
        }
      };
      document.getElementById('navLogoutBtn').onclick = () => document.getElementById('logoutBtn').click();
      // Populate Volunteer Management when entering Admin section
      if (isAdminish) {
        populateVolunteerMgmt();
        populateTopVolunteerForAdmin();
        const volSel = document.getElementById('vmVolunteer');
        if (volSel && !volSel._wired) {
          // Always sync the top list from the edit dropdown on focus/click so it cannot be empty
          const syncFromEdit = () => {
            const editSel = document.getElementById('vmEditSelect');
            if (!editSel) return;
            const keep = volSel.value;
            volSel.innerHTML = editSel.innerHTML || '<option value="">— Select volunteer —</option>';
            if (keep) volSel.value = keep;
            volSel.disabled = false;
          };
          const refillFromCache = () => {
            if (!volSel._all || volSel.options.length > 1) return;
            const current = volSel.value;
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            (volSel._all || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volSel.appendChild(opt);
            });
            if (current) volSel.value = current;
          };
          const refillByFetch = async () => {
            if (volSel.options.length > 1) return;
            try {
              const orgVal = (currentRole === 'superadmin') ? (document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || '') : (groupId != null ? String(groupId) : '');
              const vols = await fetchVolunteers(orgVal);
              volSel._all = vols || [];
              const current = volSel.value;
              volSel.innerHTML = '<option value="">— Select volunteer —</option>';
              (volSel._all || []).forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name ? `${v.name}` : v.email;
                volSel.appendChild(opt);
              });
              if (current) volSel.value = current;
            } catch { /* silent */ }
          };
          volSel.addEventListener('focus', syncFromEdit);
          volSel.addEventListener('mousedown', syncFromEdit);
          volSel.addEventListener('click', syncFromEdit);
          volSel.addEventListener('focus', refillFromCache);
          volSel.addEventListener('mousedown', refillFromCache);
          volSel.addEventListener('click', refillFromCache);
          volSel.addEventListener('focus', refillByFetch);
          volSel.addEventListener('mousedown', refillByFetch);
          volSel.addEventListener('click', refillByFetch);
          volSel.addEventListener('change', () => {
            // Always refresh logs when a volunteer is chosen
            refreshVolunteerLogs();
            // Also open the edit panel for the selected volunteer (admins mirror superadmin edit UX)
            const id = Number(volSel.value);
            const list = volSel._all || [];
            const v = list.find(x => x.id === id);
            if (!v) return;
            const panel = document.getElementById('vmEditPanel');
            if (panel) panel.classList.remove('hidden');
            const row = document.getElementById('vmEditSelectRow');
            if (row) row.classList.toggle('hidden', currentRole === 'superadmin' ? !((document.getElementById('vmOrgPicker')?.value) || (document.getElementById('superadminOrgPicker')?.value)) : false);
            const logsRow = document.getElementById('vmLogsRow');
            if (logsRow) logsRow.classList.remove('hidden');
            const syncEditSel = document.getElementById('vmEditSelect');
            if (syncEditSel) syncEditSel.value = String(id);
            document.getElementById('vmEditId').value = String(v.id);
            document.getElementById('vmEditName').value = v.name || '';
            document.getElementById('vmEditEmail').value = v.email || '';
            const pw = document.getElementById('vmEditPassword'); if (pw) pw.value = '';
            document.getElementById('vmEditPhone').value = v.phone || '';
            document.getElementById('vmEditAddress').value = v.address || '';
          });
          volSel._wired = true;
        }
        const addBtn = document.getElementById('vmAddBtn');
        if (addBtn && !addBtn._wired) {
          addBtn.addEventListener('click', async () => {
            const err = document.getElementById('vmErr');
            if (err) err.textContent = '';
            updateStatusMessage('vmTimeStatus', '');
            const volunteer_id = Number(document.getElementById('vmVolunteer').value);
            const duty_id = Number(document.getElementById('vmDuty').value);
            const start_time = document.getElementById('vmStart').value;
            const end_time = document.getElementById('vmEnd').value || null;
            const duty_date = start_time ? String(start_time).split('T')[0] : null;
            try {
              const startUtc = convertLocalInputToUtc(start_time, activeTimeZone);
              const endUtc = end_time ? convertLocalInputToUtc(end_time, activeTimeZone) : null;
              if (!startUtc) { if (err) err.textContent = 'Invalid start time'; return; }
              const res = await authed('/admin/time-tracking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volunteer_id, duty_id, start_time: startUtc, end_time: endUtc, duty_date })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to add time'; updateStatusMessage('vmTimeStatus','',false); return; }
              await fetchTimeTracking();
              await refreshVolunteerLogs();
        if (duty_date) invalidateCalendarSchedule(duty_date, { refresh: true });
              updateStatusMessage('vmTimeStatus', 'Clocked in.');
            } catch {
              if (err) err.textContent = 'Error adding time';
              updateStatusMessage('vmTimeStatus','',false);
            }
          });
          addBtn._wired = true;
        }
        const saveUserBtn = document.getElementById('vmSaveUserBtn');
        if (saveUserBtn && !saveUserBtn._wired) {
          saveUserBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('vmEditId').value);
            const name = document.getElementById('vmEditName').value.trim();
            const email = document.getElementById('vmEditEmail').value.trim();
            const password = document.getElementById('vmEditPassword')?.value || '';
            const phone = document.getElementById('vmEditPhone').value.trim();
            const address = document.getElementById('vmEditAddress').value.trim();
            const err = document.getElementById('vmSaveUserErr');
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phone, address, ...(password ? { password } : {}) })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to save user'; return; }
              const pw = document.getElementById('vmEditPassword');
              if (pw) pw.value = '';
              await populateVolunteerMgmt();
              const panel = document.getElementById('vmEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error saving user'; }
          });
          saveUserBtn._wired = true;
        }
        const closeBtn = document.getElementById('vmCloseEditBtn');
        if (closeBtn && !closeBtn._wired) {
          closeBtn.addEventListener('click', () => {
            const panel = document.getElementById('vmEditPanel');
            if (panel) panel.classList.add('hidden');
          });
          closeBtn._wired = true;
        }
        // Volunteer password helpers
        const vmPw = document.getElementById('vmEditPassword');
        const vmToggle = document.getElementById('vmTogglePwBtn');
        if (vmToggle && !vmToggle._wired) {
          vmToggle.addEventListener('click', () => {
            if (!vmPw) return;
            const show = vmPw.type !== 'text';
            vmPw.type = show ? 'text' : 'password';
            vmToggle.textContent = show ? 'Hide' : 'Show';
          });
          vmToggle._wired = true;
        }
        // removed Generate button per request
        const vmUpdate = document.getElementById('vmUpdatePwBtn');
        if (vmUpdate && !vmUpdate._wired) {
          vmUpdate.addEventListener('click', async () => {
            if (!vmPw || !vmPw.value) return;
            const id = Number(document.getElementById('vmEditId').value);
            const err = document.getElementById('vmSaveUserErr');
            if (err) err.textContent = '';
            if (vmPw.value.length < 6) { if (err) err.textContent = 'Password must be at least 6 chars'; return; }
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: vmPw.value })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to update password'; return; }
              vmPw.value = '';
            } catch { if (err) err.textContent = 'Error updating password'; }
          });
          vmUpdate._wired = true;
        }
        // Delete volunteer
        const delUserBtn = document.getElementById('vmDeleteUserBtn');
        if (delUserBtn && !delUserBtn._wired) {
          delUserBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('vmEditId').value);
            const err = document.getElementById('vmSaveUserErr');
            if (!id) return;
            if (!confirm('Delete this user?')) return;
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, { method: 'DELETE' });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to delete user'; return; }
              await populateVolunteerMgmt();
              const panel = document.getElementById('vmEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error deleting user'; }
          });
          delUserBtn._wired = true;
        }
      }
      // Superadmin admin-management wiring
      if (currentRole === 'superadmin') {
        populateSuperadminUsers();
        const selRow = document.getElementById('saAdminRow');
        if (selRow) selRow.classList.toggle('hidden', !orgPicker.value);
        const sel = document.getElementById('saAdminSelect');
        if (sel && !sel._wired) {
          sel.addEventListener('change', () => {
            const id = Number(sel.value);
            const optionData = sel._users || [];
            const u = optionData.find(x => x.id === id);
            if (!u) return;
            const panel = document.getElementById('saAdminEditPanel');
            if (panel) panel.classList.remove('hidden');
            document.getElementById('saAdminEditId').value = String(u.id);
            document.getElementById('saAdminEditName').value = u.name || '';
            document.getElementById('saAdminEditEmail').value = u.email || '';
            document.getElementById('saAdminEditPhone').value = u.phone || '';
            document.getElementById('saAdminEditAddress').value = u.address || '';
          });
          sel._wired = true;
        }
        const roleFilter = document.getElementById('saUserRole');
        if (roleFilter && !roleFilter._wired) {
          roleFilter.addEventListener('change', () => {
            populateSuperadminUsers();
            const selRow2 = document.getElementById('saAdminRow');
            const orgPicker2 = document.getElementById('superadminOrgPicker');
            const chosenRole3 = roleFilter.value || 'admin';
            const requireOrg3 = (chosenRole3 === 'admin' || chosenRole3 === 'volunteer');
            if (selRow2) selRow2.classList.toggle('hidden', requireOrg3 ? !orgPicker2?.value : false);
          });
          roleFilter._wired = true;
        }
        // Password helpers
        const pwInput = document.getElementById('saAdminEditPassword');
        const toggleBtn = document.getElementById('saTogglePwBtn');
        if (toggleBtn && !toggleBtn._wired) {
          toggleBtn.addEventListener('click', () => {
            if (!pwInput) return;
            const show = pwInput.type !== 'text';
            pwInput.type = show ? 'text' : 'password';
            toggleBtn.textContent = show ? 'Hide' : 'Show';
          });
          toggleBtn._wired = true;
        }
        // removed Generate button per request
        const updatePwBtn = document.getElementById('saUpdatePwBtn');
        if (updatePwBtn && !updatePwBtn._wired) {
          updatePwBtn.addEventListener('click', async () => {
            if (!pwInput || !pwInput.value) return;
            const id = Number(document.getElementById('saAdminEditId').value);
            const err = document.getElementById('saAdminSaveErr');
            if (err) err.textContent = '';
            if (pwInput.value.length < 6) { if (err) err.textContent = 'Password must be at least 6 chars'; return; }
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pwInput.value })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to update password'; return; }
              pwInput.value = '';
            } catch { if (err) err.textContent = 'Error updating password'; }
          });
          updatePwBtn._wired = true;
        }
        const saveBtn = document.getElementById('saSaveAdminBtn');
        if (saveBtn && !saveBtn._wired) {
          saveBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('saAdminEditId').value);
            const name = document.getElementById('saAdminEditName').value.trim();
            const email = document.getElementById('saAdminEditEmail').value.trim();
            const password = document.getElementById('saAdminEditPassword').value;
            const phone = document.getElementById('saAdminEditPhone').value.trim();
            const address = document.getElementById('saAdminEditAddress').value.trim();
            const err = document.getElementById('saAdminSaveErr');
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phone, address, ...(password ? { password } : {}) })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to save user'; return; }
              // Clear password field after save
              const pw = document.getElementById('saAdminEditPassword');
              if (pw) pw.value = '';
              await populateSuperadminUsers();
              const panel = document.getElementById('saAdminEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error saving user'; }
          });
          saveBtn._wired = true;
        }
        const delBtn = document.getElementById('saDeleteUserBtn');
        if (delBtn && !delBtn._wired) {
          delBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('saAdminEditId').value);
            const err = document.getElementById('saAdminSaveErr');
            if (!id || !Number.isFinite(id)) return;
            if (!confirm('Delete this user? This cannot be undone.')) return;
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, { method: 'DELETE' });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to delete user'; return; }
              await populateSuperadminUsers();
              const panel = document.getElementById('saAdminEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error deleting user'; }
          });
          delBtn._wired = true;
        }
        const closeBtn = document.getElementById('saCloseAdminEditBtn');
        if (closeBtn && !closeBtn._wired) {
          closeBtn.addEventListener('click', () => {
            const panel = document.getElementById('saAdminEditPanel');
            if (panel) panel.classList.add('hidden');
          });
          closeBtn._wired = true;
        }
      }
    }
    // password generation removed per request

    prepareCalendarSection();

    // CSV download (role-scoped)
    const dlBtn = document.getElementById('downloadCsvBtn');
    if (dlBtn) dlBtn.addEventListener('click', async () => {
      const errEl = document.getElementById('downloadCsvError');
      if (errEl) errEl.textContent = '';
      const selectedIds = getSelectedAdminVolunteerIds();
      if (!selectedIds.length) {
        if (errEl) errEl.textContent = 'Select at least one volunteer first.';
        return;
      }
      try {
        const params = new URLSearchParams();
        selectedIds.forEach(id => params.append('volunteer_id', id));
        const approvedToggle = document.getElementById('downloadCsvApprovedOnly');
        params.set('approved_only', (!approvedToggle || approvedToggle.checked) ? 'true' : 'false');
        const res = await authed(`/time-tracking.csv?${params.toString()}`);
        if (!res.ok) {
          if (errEl) errEl.textContent = 'Failed to download CSV';
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'time-tracking.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        if (errEl) errEl.textContent = 'Error downloading CSV';
      }
    });

    const volCsvBtn = document.getElementById('volDownloadCsvBtn');
    if (volCsvBtn) volCsvBtn.addEventListener('click', async () => {
      const errEl = document.getElementById('volDownloadCsvError');
      if (errEl) errEl.textContent = '';
      try {
        const res = await authed('/time-tracking.csv');
        if (!res.ok) {
          if (errEl) errEl.textContent = 'Failed to download CSV';
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my-timesheet.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        if (errEl) errEl.textContent = 'Error downloading CSV';
      }
    });

    const volDutiesBtn = document.getElementById('volDownloadDutiesBtn');
    if (volDutiesBtn) volDutiesBtn.addEventListener('click', () => {
      const errEl = document.getElementById('volDownloadDutiesError');
      if (errEl) errEl.textContent = '';
      try {
        const rows = Array.from(document.querySelectorAll('#dutyList tr'));
        if (!rows.length) {
          if (errEl) errEl.textContent = 'No duties available to download.';
          return;
        }
        const header = ['Duty ID','Title','Description','Status','Capacity','Active'];
        const body = rows.map(tr => {
          const cells = tr.querySelectorAll('td');
          if (!cells.length) return null;
          const [idCell, titleCell, descCell, statusCell, capacityCell, activeCell] = cells;
          return [
            (idCell?.textContent || '').trim(),
            (titleCell?.textContent || '').trim(),
            (descCell?.textContent || '').trim(),
            (statusCell?.textContent || '').trim(),
            (capacityCell?.textContent || '').trim(),
            (activeCell?.textContent || '').trim()
          ];
        }).filter(Boolean);
        if (!body.length) {
          if (errEl) errEl.textContent = 'No duties available to download.';
          return;
        }
        const csv = [header, ...body]
          .map(row => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(','))
          .join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my-duties.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        if (errEl) errEl.textContent = 'Error preparing CSV';
      }
    });

    const superCsvBtn = document.getElementById('superDownloadCsvBtn');
    if (superCsvBtn) superCsvBtn.addEventListener('click', async () => {
      const errEl = document.getElementById('superDownloadCsvError');
      if (errEl) errEl.textContent = '';
      const orgPicker = document.getElementById('superadminOrgPicker');
      if (!orgPicker?.value) {
        if (errEl) errEl.textContent = 'Select an organization first.';
        return;
      }
      const selectedIds = getSelectedSuperVolunteerIds();
      if (!selectedIds.length) {
        if (errEl) errEl.textContent = 'Select at least one volunteer first.';
        return;
      }
      try {
        const params = new URLSearchParams();
        selectedIds.forEach(id => params.append('volunteer_id', id));
        const approvedToggle = document.getElementById('superDownloadCsvApprovedOnly');
        params.set('approved_only', (!approvedToggle || approvedToggle.checked) ? 'true' : 'false');
        const res = await authed(`/time-tracking.csv?${params.toString()}`);
        if (!res.ok) {
          if (errEl) errEl.textContent = 'Failed to download CSV';
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'time-tracking.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        if (errEl) errEl.textContent = 'Error downloading CSV';
      }
    });

  </script>
</body>
</html>