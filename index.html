<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Volunteer Time Tracking</title>
  <style>
    :root { color-scheme: light dark; --primary: #000000; --text: #ffffff; --accent1: #35b1fb; --accent2: #0289db; --accent3: #054a74; --accent4: #00433a; --accent5: #ffffff; }
    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.35; background-size: cover; background-repeat: no-repeat; color: var(--text); background-color: var(--primary); min-height: 100vh; display: flex; flex-direction: column; }
    header { position: relative; display:flex; justify-content:center; align-items:center; padding: 51px 0; margin-bottom: -32px; overflow: hidden; border-radius: 0; margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); }
    header::before { content: ""; position: absolute; inset: 0; background: url('https://i.postimg.cc/t4S6CDjx/cityscape.jpg') 50% 34%/cover no-repeat; opacity: 0.75; pointer-events: none; }
    header > * { position: relative; z-index: 1; }
    #logo { max-height: 112px; border-radius: 6px; transform: translateY(-7%); }
    h1 { margin: 0 0 16px; font-size: 22px; color: var(--accent1); text-align:center; }
    #appTitle { display:block; width: fit-content; margin: 0 auto 16px; background: #000; padding: 8px 12px; border-radius: 8px; position: relative; z-index: 2; transform: translateY(4%); }
    h2 { margin: 14px 0 10px; font-size: 18px; color: var(--accent2); }
    h3 { margin: 12px 0 8px; font-size: 16px; color: var(--accent3); }
    a { color: var(--accent1); }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 360px; border: 1px solid var(--accent3); padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.04); }
    label { display:block; margin-top: 6px; font-size: 14px; color: var(--accent5); }
    input, select { margin: 4px 0 8px; padding: 8px; width: 100%; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--accent3); background: rgba(0,0,0,0.25); color: var(--text); }
    button { padding: 8px 12px; margin: 6px 6px 0 0; border-radius: 10px; border: 1px solid var(--accent2); background: var(--primary); color: var(--text); cursor: pointer; }
    button:hover { background: var(--accent2); }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    thead th { background: rgba(255,255,255,0.06); color: var(--text); }
    th, td { border: 1px solid var(--accent3); padding: 6px 8px; vertical-align: top; }
    .hidden { display: none !important; }
    .error { color: #b00020; margin-top: 6px; }
    .hint { color: var(--accent2); margin-top: 6px; }
    .ok { color: #0b6; }
    .nowrap { white-space: nowrap; }
    /* Defensive: hide extension popovers/overlays if present */
    *[popover]{display:none!important;visibility:hidden!important;opacity:0!important;}
    #top-layer{display:none!important}

    /* Predictive org suggestions (no button) */
    .org-suggest-wrap { position: relative; }
    .org-suggest { position: absolute; left: 0; right: 0; top: 100%; z-index: 1000; border: 1px solid var(--accent3); background: rgba(0,0,0,0.95); border-radius: 8px; margin-top: 4px; max-height: 220px; overflow-y: auto; }
    .org-suggest.hidden { display: none !important; }
    .org-suggest div { padding: 6px 8px; cursor: pointer; }
    .org-suggest div:hover { background: rgba(255,255,255,0.06); }

    /* Toolbar */
    nav#toolbar { display:flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 12px 0 16px; background: rgba(0,0,0,0.6); border: 1px solid var(--accent3); border-radius: 8px; padding: 8px; }
    nav#toolbar button { background: rgba(0,0,0,0.2); }
    /* */
    /* */

    /* Home section tweaks */
    #homeSection { max-width: 640px; margin: 0 auto 16px; text-align: center; flex: 0 1 640px; }
    #homeHero { display: block; margin: 8px auto 0; max-width: 420px; width: 100%; border-radius: 10px; }

    /* Footer background image */
    footer#footer { position: relative; height: 288px; margin-top: auto; border-radius: 0; overflow: hidden; pointer-events: none; margin-left: -24px; margin-right: -24px; width: calc(100% + 48px); }
    footer#footer::before { content: ""; position: absolute; inset: 0; background: url('https://i.postimg.cc/8Cfgxn5P/theater-seats.jpg') 50% 78%/cover no-repeat; opacity: 0.75; pointer-events: none; }
  </style>

  <!-- Strip any tracking params like ?utm_source=... to avoid parser oddities -->
  <script>
    (function stripQuery() {
      if (location.search && /utm_|fbclid|gclid/i.test(location.search)) {
        history.replaceState({}, document.title, location.pathname);
      }
    })();
  </script>
</head>
<body>
  <!-- build: 6cd6141 (signup typeahead prefix-first) refreshed at 2025-11-20T00:00:00Z -->
  <header>
    <a id="logoLink" href="#" target="_blank" rel="noopener noreferrer">
      <img id="logo" alt="logo" class="hidden" />
    </a>
  </header>
  <h1 id="appTitle">Volunteer Time Tracking</h1>
  <nav id="toolbar" class="hidden">
    <button id="navHomeBtn">Home</button>
    <button id="navAccountBtn">Account</button>
    <button id="navAdminBtn">Admin Tools</button>
    <button id="navEventsBtn">Events</button>
    <button id="navCreateDutyBtn">Create Duty</button>
    <button id="navVolunteerMgmtBtn" class="hidden">Volunteer Management</button>
    <button id="navClockBtn">Time Clock</button>
    <button id="navPhotosBtn">Photos</button>
    <button id="navLogoutBtn">Logout</button>
  </nav>
  <section id="homeSection" class="col hidden">
    <h2>Welcome to the TTTC Volunteer Tracker App</h2>
    <img id="homeHero" alt="Welcome" src="https://i.postimg.cc/gjsftpNw/original-ticket.jpg" />
    <p>Use the toolbar above to navigate: create duties, clock time, manage events, and more.</p>
  </section>

  <!-- VOLUNTEER: TIME CLOCK PAGE -->
  <section id="clockSection" class="col hidden">
    <h2>Time Clock</h2>
    <div id="clockSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization</label>
        <select id="clockOrgFilter"><option value="">— Select organization —</option></select>
        <label style="margin-left:10px">Event</label>
        <select id="clockEventFilter" disabled><option value="">— Select event —</option></select>
        <label style="margin-left:10px">Duty</label>
        <select id="clockDutyFilter" disabled><option value="">— Select duty —</option></select>
      </div>
    </div>
    <div id="clockSuperNote" class="hint"></div>
    <div id="clockDutiesWrap">
      <h3>My Duties</h3>
      <table>
        <thead><tr><th>ID</th><th>Title</th><th>Description</th><th>Status</th><th>Track Time</th></tr></thead>
        <tbody id="dutyList"></tbody>
      </table>
    </div>

    <div id="clockTimesWrap">
      <h3>My Timesheet</h3>
      <table>
        <thead><tr><th>ID</th><th>Duty</th><th>Start</th><th>End</th><th>Hours</th><th>Date</th></tr></thead>
        <tbody id="timeList"></tbody>
      </table>
    </div>
  </section>

  <!-- VOLUNTEER: PHOTOS PAGE -->
  <section id="photosSection" class="col hidden">
    <h2>Photos</h2>
    <div id="photosFilterWrap" class="row hidden">
      <div class="col">
        <label>Volunteer (filter)</label>
        <select id="photosVolunteerFilter"><option value="">— All —</option></select>
      </div>
    </div>
    <div id="photoUploadWrap">
      <label for="photoDuty">Duty</label>
      <select id="photoDuty"></select>
      <input id="photoCaption" type="text" placeholder="Caption (optional)" />
      <input id="photoFile" type="file" accept="image/*" capture="environment" />
      <button id="uploadPhotoBtn">Upload Photo</button>
      <div id="photoError" class="error"></div>
    </div>
    <div id="photoGallery"></div>
  </section>

  <!-- VOLUNTEER: EVENTS PAGE -->
  <section id="eventsSection" class="col hidden">
    <h2>Events</h2>
    <div id="eventsSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization (superadmin filter)</label>
        <select id="superEventGroupFilter"><option value="">— Select organization —</option></select>
        <div id="eventsSuperNote" class="hint"></div>
      </div>
    </div>
    <div id="eventsCreateWrap" class="row hidden">
      <div class="col">
        <h3>Create Event</h3>
        <label>Title</label><input id="eventTitle2" type="text" />
        <label>Description</label><input id="eventDesc2" type="text" />
        <label>Organization</label>
        <select id="eventGroup2"><option value="">— Select group —</option></select>
        <label>Start Date</label><input id="eventStart2" type="date" />
        <label>End Date</label><input id="eventEnd2" type="date" />
        <button id="createEventBtn2">Create Event</button>
        <div id="createEventError2" class="error"></div>
      </div>
    </div>
    <table>
      <thead><tr><th>ID</th><th>Title</th><th>Date(s)</th><th>Join</th><th id="eventActionsHeader" class="hidden">Actions</th></tr></thead>
      <tbody id="eventList"></tbody>
    </table>
    <div id="eventEditWrap" class="row hidden">
      <div class="col">
        <h3>Edit Event</h3>
        <label>Event ID</label><input id="editEventId" type="number" />
        <label>Title</label><input id="editEventTitle" type="text" />
        <label>Description</label><input id="editEventDesc" type="text" />
        <label>Start Date</label><input id="editEventStart" type="date" />
        <label>End Date</label><input id="editEventEnd" type="date" />
        <button id="saveEventBtn">Save Event</button>
        <div id="editEventError" class="error"></div>
      </div>
    </div>
  </section>

  <section id="createDutySection" class="col hidden">
    <h2>Create Duty</h2>
    <div id="dutiesSuperFilter" class="row hidden">
      <div class="col">
        <label>Organization (superadmin filter)</label>
        <select id="superDutyGroupFilter"><option value="">— Select organization —</option></select>
        <div id="dutiesSuperNote" class="hint"></div>
      </div>
    </div>
    <div id="createDutyAdmin" class="row">
      <div class="col">
        <h3>Admin Create Duty</h3>
        <label>Title</label><input id="dutyTitle" type="text" />
        <label>Description</label><input id="dutyDesc" type="text" />
        <label>Group</label>
        <select id="dutyGroup"><option value="">— Select group —</option></select>
        <label>Event (optional)</label>
        <select id="dutyEvent"><option value="">— None —</option></select>
        <label>Status</label>
        <select id="dutyStatus">
          <option value="open">open</option>
          <option value="closed">closed</option>
        </select>
        <button id="createDutyBtn">Create Duty</button>
        <div id="createDutyError" class="error"></div>
      </div>
    </div>
    <div id="createDutyVol" class="row">
      <div class="col">
        <h3>Volunteer Create Duty</h3>
        <label>Title</label><input id="volDutyTitle" type="text" />
        <label>Description</label><input id="volDutyDesc" type="text" />
        <label>Event (optional)</label>
        <select id="volDutyEvent"><option value="">— None —</option></select>
        <button id="volCreateDutyBtn">Create Duty</button>
        <div id="volCreateDutyError" class="error"></div>
      </div>
    </div>
    <div id="dutyEditSelectorWrap" class="row hidden">
      <div class="col">
        <label>Select Duty to Edit</label>
        <select id="dutyEditSelect"><option value="">— Select duty —</option></select>
      </div>
    </div>
    <div id="dutyEditWrap" class="row hidden">
      <div class="col">
        <h3>Edit Duty</h3>
        <label>Duty ID</label><input id="editDutyId" type="number" />
        <label>Title</label><input id="editDutyTitle" type="text" />
        <label>Description</label><input id="editDutyDesc" type="text" />
        <label>Status</label>
        <select id="editDutyStatus">
          <option value="pending">pending</option>
          <option value="in_progress">in_progress</option>
          <option value="completed">completed</option>
        </select>
        <button id="saveDutyBtn">Save Duty</button>
        <div id="editDutyError" class="error"></div>
      </div>
    </div>
  </section>

  <!-- LOGIN -->
  <section id="authSection" class="col">
    <h2>Login</h2>
    <label>Email</label>
    <input id="email" type="email" autocomplete="username" />
    <label>Password</label>
    <input id="password" type="password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <div id="loginError" class="error"></div>

    <button id="showSignupBtn" style="margin-top:16px">Sign up</button>
    <div id="signupWrap" class="hidden">
      <h2 style="margin-top:16px">Sign Up</h2>
      <label>Name</label>
      <input id="signupName" type="text" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
      <label>Email</label>
      <input id="signupEmail" type="email" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
      <label>Password</label>
      <input id="signupPassword" type="password" autocomplete="new-password" />
      <label>Organization</label>
      <div id="signupGroupWrap" class="org-suggest-wrap">
        <input id="signupGroupInput" type="text" autocomplete="off" spellcheck="false" placeholder="Type to search organizations" />
        <!-- Removed native datalist to avoid grey browser dropdown -->
        <div id="signupGroupSuggestions" class="org-suggest hidden"></div>
      </div>
      <div id="signupOrgError" class="error"></div>
      <label>Phone</label>
      <input id="signupPhone" type="text" autocomplete="off" inputmode="tel" />
      <button id="signupBtn" type="button">Create Account</button>
      <div id="signupError" class="error"></div>
    </div>
  </section>

  <!-- ACCOUNT INFO (Name, Email, Phone, Address only) -->
  <section id="infoSection" class="col hidden">
    <h2>Account</h2>
    <div>Role: <strong id="role"></strong></div>
    <div>Group: <strong id="groupName"></strong> <span id="groupIdWrap" class="nowrap hidden">(ID: <span id="groupId"></span>)</span></div>
    <div>User ID: <strong id="userId"></strong></div>
    <button id="logoutBtn">Logout</button>
    <hr />
    <h3>Profile</h3>
    <div class="row">
      <div class="col">
        <label>Name</label>
        <input id="acctName" type="text" />
        <label>Email</label>
        <input id="acctEmail" type="email" />
        <label>Phone</label>
        <input id="acctPhone" type="text" />
        <label>Address</label>
        <input id="acctAddress" type="text" />
        <button id="saveAccountInfo">Save</button>
        <div id="accountInfoError" class="error"></div>
      </div>
    </div>
  </section>

  <!-- SUPERADMIN -->
  <section id="superadminSection" class="col hidden">
    <h2>Superadmin Tools</h2>

    <h3>Create Organization (Group)</h3>
    <div class="row">
      <div class="col">
        <label>Organization Name</label><input id="groupNameInput" type="text" />
        <label>Status</label>
        <select id="groupStatus">
          <option value="active">active</option>
          <option value="inactive">inactive</option>
        </select>
        <button id="createGroupBtn">Create Group</button>
        <div id="createGroupError" class="error"></div>
      </div>
    </div>

    <h3>All Organizations</h3>
    <div class="row">
      <div class="col">
        <label>Organizations</label>
        <select id="superadminOrgPicker"><option value="">— Select organization —</option></select>
      </div>
    </div>
    <div id="superadminOrgInfo" class="row hidden">
      <div class="col">
    <table>
          <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Save</th></tr></thead>
          <tbody id="superadminOrgInfoBody"></tbody>
        </table>
        <div id="superadminOrgInfoErr" class="error"></div>
      </div>
    </div>
    <table id="groupTable" class="hidden">
      <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="groupList"></tbody>
    </table>

    <h3>User Management</h3>
    <div class="row" id="saUserRoleRow">
      <div class="col">
        <label>Role</label>
        <select id="saUserRole">
          <option value="admin">admin</option>
          <option value="superadmin">superadmin</option>
          <option value="volunteer">volunteer</option>
          <option value="all">all</option>
        </select>
      </div>
    </div>
    <div class="row hidden" id="saAdminRow">
      <div class="col">
        <label>Select User to Edit</label>
        <select id="saAdminSelect"><option value="">— Select user —</option></select>
      </div>
    </div>
    <div id="saAdminEditPanel" class="row hidden">
      <div class="col">
        <h3>Edit User</h3>
        <label>User ID</label><input id="saAdminEditId" type="number" />
        <label>Name</label><input id="saAdminEditName" type="text" />
        <label>Email</label><input id="saAdminEditEmail" type="email" />
        <label>New Password (leave blank to keep)</label><input id="saAdminEditPassword" type="password" />
        <div style="margin:6px 0">
          <button id="saTogglePwBtn" type="button">Show</button>
          <button id="saUpdatePwBtn" type="button" style="margin-left:8px">Update Password</button>
        </div>
        <label>Phone</label><input id="saAdminEditPhone" type="text" />
        <label>Address</label><input id="saAdminEditAddress" type="text" />
        <button id="saSaveAdminBtn">Save User</button>
        <button id="saDeleteUserBtn" style="margin-left:8px;color:#b00020">Delete User</button>
        <button id="saCloseAdminEditBtn" style="margin-left:8px">Close</button>
        <div id="saAdminSaveErr" class="error"></div>
      </div>
    </div>

    <h3>All Time Logs (By Organization)</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Volunteer</th><th>Duty</th><th>Start</th><th>End</th><th>Hours</th><th>Date</th><th>Edit</th><th>Delete</th></tr>
      </thead>
      <tbody id="superAdminTimeList"></tbody>
    </table>

    <h3>Photo Approvals</h3>
    <div id="superPhotoApprovals"></div>

    <h3>Create User (Superadmin)</h3>
    <div class="row">
      <div class="col">
        <label>Role</label>
        <select id="newUserRole">
          <option value="superadmin">superadmin</option>
          <option value="admin">admin</option>
          <option value="volunteer">volunteer</option>
        </select>
        <label>Name</label><input id="newUserName" type="text" />
        <label>Email</label><input id="newUserEmail" type="email" />
        <label>Password</label><input id="newUserPassword" type="password" />
        <label>Group (optional for superadmin/global)</label>
        <select id="newUserGroup"><option value="">— None —</option></select>
        <button id="createUserBtn">Create User</button>
        <div id="createUserError" class="error"></div>
      </div>
    </div>

    
  </section>

  <!-- ADMIN -->
  <section id="adminSection" class="col hidden">
    <h2>Admin Tools</h2>

    

    

    <h3>Create Admin</h3>
    <div class="row">
      <div class="col">
        <label>Email</label><input id="adminEmail" type="email" />
        <label>Password</label><input id="adminPassword" type="password" />
        <label>Group</label>
        <select id="adminGroup"><option value="">— None —</option></select>
        <button id="createAdminBtn">Create Admin</button>
        <div id="createAdminErr" class="error"></div>
      </div>
    </div>

    

    

    <h3>Pending Approvals</h3>
    <table>
      <thead><tr><th>Log ID</th><th>Volunteer</th><th>Hours</th><th>Date</th><th>Approve</th></tr></thead>
      <tbody id="approvalList"></tbody>
    </table>

    <button id="downloadCsvBtn">Download Timesheet CSV</button>
    <div id="downloadCsvError" class="error"></div>

    <h3>All Time Logs (Scoped to Org)</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Volunteer</th><th>Duty</th><th>Start</th><th>End</th><th>Hours</th><th>Date</th><th>Edit</th><th>Delete</th></tr>
      </thead>
      <tbody id="adminTimeList"></tbody>
    </table>

    
    <h3>Photo Approvals</h3>
    <div id="photoApprovals"></div>
  </section>

  <!-- VOLUNTEER MANAGEMENT (Admin/Superadmin) -->
  <section id="volMgmtSection" class="col hidden">
    <h2>Volunteer Management</h2>
    <div class="row">
      <div class="col">
        <h3>Create Volunteer</h3>
        <label>Name</label><input id="vmVolName" type="text" />
        <label>Email</label><input id="vmVolEmail" type="email" />
        <label>Password</label><input id="vmVolPassword" type="password" />
        <label>Group</label>
        <select id="vmVolGroup"><option value="">— None —</option></select>
        <button id="vmCreateVolBtn">Create Volunteer</button>
        <div id="vmCreateVolErr" class="error"></div>
      </div>
    </div>
    <div id="vmSuperOrgRow" class="row hidden">
      <div class="col">
        <label>Organization</label>
        <select id="vmOrgPicker"><option value="">— Select organization —</option></select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Search volunteers (name or email)</label>
        <input id="vmVolunteerSearch" type="text" placeholder="Start typing..." />
      </div>
    </div>
    <div id="vmEventRow" class="row">
      <div class="col">
        <label>Event</label>
        <select id="vmEvent"><option value="">— Select event —</option></select>
      </div>
    </div>
    <div class="row" id="vmVolunteerRow">
      <div class="col">
        <label>Volunteer</label>
        <select id="vmVolunteer"><option value="">— Select volunteer —</option></select>
        <label style="margin-top:10px">Duty</label>
        <select id="vmDuty"><option value="">— Select duty —</option></select>
        <label>Start Time</label>
        <input id="vmStart" type="datetime-local" />
        <label>End Time (optional)</label>
        <input id="vmEnd" type="datetime-local" />
        
        <button id="vmAddBtn">Add Time Entry</button>
        <div id="vmErr" class="error"></div>
      </div>
    </div>
    <div id="vmEditPanel" class="row hidden">
      <div class="col">
        <h3>Edit Volunteer</h3>
        <label>User ID</label><input id="vmEditId" type="number" />
        <label>Name</label><input id="vmEditName" type="text" />
        <label>Email</label><input id="vmEditEmail" type="email" />
        <label>New Password (leave blank to keep)</label><input id="vmEditPassword" type="password" />
        <div style="margin:6px 0">
          <button id="vmTogglePwBtn" type="button">Show</button>
          <button id="vmUpdatePwBtn" type="button" style="margin-left:8px">Update Password</button>
        </div>
        <label>Phone</label><input id="vmEditPhone" type="text" />
        <label>Address</label><input id="vmEditAddress" type="text" />
        <button id="vmSaveUserBtn">Save User</button>
        <button id="vmCloseEditBtn" style="margin-left:8px">Close</button>
        <div id="vmSaveUserErr" class="error"></div>
      </div>
    </div>
    <div class="row" id="vmLogsRow">
      <div class="col">
        <h3>Selected Volunteer Logs</h3>
    <table>
      <thead><tr><th>ID</th><th>Duty</th><th>Start</th><th>End</th><th>Hours</th><th>Date</th></tr></thead>
          <tbody id="vmLogList"></tbody>
    </table>
      </div>
    </div>
    <div class="row" id="vmEditSelectRow">
      <div class="col">
        <label>Select Volunteer to Edit</label>
        <select id="vmEditSelect"><option value="">— Select volunteer —</option></select>
      </div>
    </div>
  </section>

  <!-- VOLUNTEER (legacy combined section removed; now split into dedicated pages) -->

  <footer id="footer"></footer>

  <script>
    const apiUrl = window.location.origin;
    let token = null;
    let role = null;
    let groupId = null;
    let userId = null;

    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }

    // CONFIG/BRANDING
    async function fetchConfig() {
      try {
        const res = await fetch(`${apiUrl}/config`);
        if (!res.ok) return;
        const cfg = await res.json();
        if (cfg.appName) {
          document.title = cfg.appName;
          const titleEl = document.getElementById('appTitle');
          if (titleEl) titleEl.textContent = cfg.appName;
        }
        if (cfg.primaryColor) document.documentElement.style.setProperty('--primary', cfg.primaryColor);
        if (cfg.textColor) document.documentElement.style.setProperty('--text', cfg.textColor);
        if (cfg.accents && cfg.accents[0]) document.documentElement.style.setProperty('--accent1', cfg.accents[0]);
        if (cfg.accents && cfg.accents[1]) document.documentElement.style.setProperty('--accent2', cfg.accents[1]);
        if (cfg.accents && cfg.accents[2]) document.documentElement.style.setProperty('--accent3', cfg.accents[2]);
        if (cfg.accents && cfg.accents[3]) document.documentElement.style.setProperty('--accent4', cfg.accents[3]);
        if (cfg.accents && cfg.accents[4]) document.documentElement.style.setProperty('--accent5', cfg.accents[4]);
        if (cfg.bgImageUrl) document.body.style.backgroundImage = `url('${cfg.bgImageUrl}')`;
        if (cfg.logoUrl) {
          const logoEl = document.getElementById('logo');
          const linkEl = document.getElementById('logoLink');
          if (linkEl) linkEl.href = cfg.logoUrl;
          if (logoEl) {
            logoEl.src = cfg.logoUrl;
            logoEl.onerror = () => { logoEl.classList.add('hidden'); };
            logoEl.classList.remove('hidden');
          }
        }
      } catch { /* silent */ }
    }
    fetchConfig();

    // Try to restore session on page load
    (async function restoreSession() {
      try {
        const saved = localStorage.getItem('auth');
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (!parsed || !parsed.token) return;
        token = parsed.token;
        const res = await authed('/me');
        if (!res.ok) { try { localStorage.removeItem('auth'); } catch {} ; return; }
        const me = await res.json();
        await bootstrapAfterAuth({ token: parsed.token, role: me.role, group_id: me.group_id, id: me.id });
      } catch {}
    })();

    // (Per-user theming removed)
    // SUPERADMIN: Create User
    document.getElementById('createUserBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('newUserName')?.value?.trim() || undefined;
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const roleSel = document.getElementById('newUserRole');
      const roleVal = roleSel ? roleSel.value : 'volunteer';
      const grpSel = document.getElementById('newUserGroup');
      const gid = grpSel && grpSel.value ? Number(grpSel.value) : null;
      const errEl = document.getElementById('createUserError');
      errEl.textContent = '';
      try {
        if (!email || !password) { errEl.textContent = 'Email and password required'; return; }
        const res = await authed('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, role: roleVal, group_id: gid })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { errEl.textContent = data.message || 'Failed to create user'; return; }
        if (document.getElementById('newUserName')) document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        if (grpSel) grpSel.value = '';
        errEl.textContent = '';
        alert('User created.');
      } catch {
        errEl.textContent = 'Error creating user';
      }
    });

    // Admin tools: create specific roles
    async function createUserWith(roleVal, emailId, passId, groupSelId, errId, nameId) {
      const email = document.getElementById(emailId).value.trim();
      const password = document.getElementById(passId).value;
      const grpSel = document.getElementById(groupSelId);
      const gid = grpSel && grpSel.value ? Number(grpSel.value) : (groupId ?? null);
      const errEl = document.getElementById(errId);
      errEl.textContent = '';
      try {
        const name = nameId ? document.getElementById(nameId).value.trim() : undefined;
        if (!email || !password) { errEl.textContent = 'Email and password required'; return; }
        const res = await authed('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role: roleVal, group_id: gid, name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { errEl.textContent = data.message || 'Failed to create user'; return; }
        document.getElementById(emailId).value = '';
        document.getElementById(passId).value = '';
        if (grpSel) grpSel.value = '';
        if (nameId) document.getElementById(nameId).value = '';
        alert('User created.');
      } catch { errEl.textContent = 'Error creating user'; }
    }

    // Removed ability for admins to create superadmins
    document.getElementById('createAdminBtn')?.addEventListener('click', async () => {
      await createUserWith('admin', 'adminEmail', 'adminPassword', 'adminGroup', 'createAdminErr', 'adminName');
    });
    document.getElementById('createVolBtn')?.addEventListener('click', async () => {
      await createUserWith('volunteer', 'volEmail', 'volPassword', 'volGroup', 'createVolErr', 'volName');
    });
    // Volunteer Management: Create Volunteer
    document.getElementById('vmCreateVolBtn')?.addEventListener('click', async () => {
      await createUserWith('volunteer', 'vmVolEmail', 'vmVolPassword', 'vmVolGroup', 'vmCreateVolErr', 'vmVolName');
      await populateVolunteerMgmt();
    });

    // UTIL: fetch wrapper with auth
    async function authed(path, opts = {}) {
      const headers = Object.assign({}, opts.headers || {}, token ? { Authorization: `Bearer ${token}` } : {});
      const res = await fetch(`${apiUrl}${path}`, Object.assign({}, opts, { headers }));
      return res;
    }

    async function bootstrapAfterAuth(data) {
      token = data.token;
      role = data.role;
      groupId = data.group_id || null;
      userId = data.id;

      try {
        localStorage.setItem('auth', JSON.stringify({ token, role, group_id: groupId, id: userId }));
      } catch {}

      document.getElementById('role').textContent = role;
      document.getElementById('groupId').textContent = groupId ?? '-';
      if (groupId != null) document.getElementById('groupIdWrap').classList.remove('hidden');
      document.getElementById('userId').textContent = userId;

      hide('authSection');
      setupToolbar(role);
      navigateTo('homeSection');

      await loadMe();
      await fetchConfig();
      await fetchGroups();
      await fetchEvents();
      await fetchDuties();
      await fetchTimeTracking();
      await fetchPhotos();
      await fetchApprovals();
      await fetchAdminTimes();
      await fetchPhotoApprovals();
    }

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      document.getElementById('loginError').textContent = '';
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value
          })
        });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('loginError').textContent = data.message || 'Login failed';
          return;
        }
        await bootstrapAfterAuth(data);
      } catch (e) {
        document.getElementById('loginError').textContent = 'Error logging in';
      }
    });

    // SIGNUP
    async function fetchPublicGroups() {
      try {
        // Front-page signup should always use the public list so volunteers can choose before login
        const res = await fetch(`${apiUrl}/public/groups`);
        if (!res.ok) return;
        const groups = await res.json();
        window.signupGroups = groups || [];
        window.signupGroupMap = {};
        groups
          .sort((a,b) => String(a.name).localeCompare(String(b.name)))
          .forEach(g => {
            window.signupGroupMap[String(g.name).toLowerCase()] = g.id;
          });
        // Wire simple suggestions dropdown as a fallback for browsers with limited datalist UX
        const input = document.getElementById('signupGroupInput');
        const sugg = document.getElementById('signupGroupSuggestions');
        const dataList = document.getElementById('signupGroupList');
        if (dataList) { dataList.innerHTML = ''; } // keep empty until user types
        // Lightweight predictive suggestions (no button) for consistent UX
        if (input && sugg && !input._wiredPredict) {
          const render = () => {
            const q = (input.value || '').trim().toLowerCase();
            const all = window.signupGroups || [];
            let matches = [];
            if (q) {
              const starts = all.filter(g => String(g.name).toLowerCase().startsWith(q));
              const contains = all.filter(g => {
                const n = String(g.name).toLowerCase();
                return n.includes(q) && !n.startsWith(q);
              });
              matches = [...starts, ...contains].slice(0, 10);
            }
            sugg.innerHTML = '';
            if (matches.length === 0) { sugg.classList.add('hidden'); return; }
            // update native datalist with only matched options (prevents full list on focus)
            const dl = document.getElementById('signupGroupList');
            if (dl) {
              dl.innerHTML = '';
              matches.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.name;
                dl.appendChild(opt);
              });
            }
            matches.forEach(g => {
              const div = document.createElement('div');
              div.textContent = g.name;
              div.dataset.value = g.name;
              sugg.appendChild(div);
            });
            sugg.classList.remove('hidden');
          };
          input.addEventListener('input', render);
          input.addEventListener('focus', () => {
            // keep datalist empty on focus to avoid full list popup; fetch data silently
            const dl = document.getElementById('signupGroupList');
            if (dl) dl.innerHTML = '';
            if (!window.signupGroups || window.signupGroups.length === 0) {
              // fetch, then render if user already typed something
              fetchPublicGroups().then(() => {
                if ((input.value || '').trim()) render();
              });
            }
          });
          input.addEventListener('blur', () => setTimeout(() => sugg.classList.add('hidden'), 120));
          sugg.addEventListener('mousedown', (e) => {
            const v = e.target && e.target.dataset && e.target.dataset.value;
            if (!v) return;
            input.value = v;
            sugg.classList.add('hidden');
          });
          input._wiredPredict = true;
        }
        // If the field is focused and has text when the groups finish loading, render immediately
        if (input === document.activeElement && (input.value || '').trim()) {
          const evt = new Event('input');
          input.dispatchEvent(evt);
        }
        // No custom dropdown; rely on native datalist with DB entries
      } catch {}
    }
    fetchPublicGroups();
    // Also refresh list on focus so the browser's native datalist shows DB-backed options
    document.getElementById('signupGroupInput')?.addEventListener('focus', () => {
      if (!window.signupGroups || window.signupGroups.length === 0) fetchPublicGroups();
    });
    document.getElementById('showSignupBtn').addEventListener('click', () => {
      const wrap = document.getElementById('signupWrap');
      wrap.classList.toggle('hidden');
      if (!window.signupGroups || window.signupGroups.length === 0) fetchPublicGroups();
    });

    document.getElementById('signupBtn').addEventListener('click', async () => {
      document.getElementById('signupError').textContent = '';
      try {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        const phone = document.getElementById('signupPhone').value.trim();
        const orgInput = document.getElementById('signupGroupInput');
        let nameToId = window.signupGroupMap || {};
        const typed = (orgInput?.value || '').trim();
        let group_id = null;
        if (typed) {
          const key = typed.toLowerCase();
          if (nameToId && nameToId[key] != null) group_id = Number(nameToId[key]);
        }
        const response = await fetch(`${apiUrl}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, phone, group_id, group_name: typed })
        });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('signupError').textContent = data.message || 'Signup failed';
          return;
        }
        // Auto-login
        await bootstrapAfterAuth(data);
      } catch {
        document.getElementById('signupError').textContent = 'Error creating account';
      }
    });

    // LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
      token = null; role = null; groupId = null; userId = null;
      try { localStorage.removeItem('auth'); } catch {}
      show('authSection');
      ['infoSection','superadminSection','adminSection','homeSection','createDutySection','clockSection','eventsSection','photosSection']
        .forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); });
    });

    // GROUPS (front-end shows name; backend uses id)
    async function fetchGroups() {
      try {
        const res = await authed('/groups');
        const groups = await res.json();

        // map id->name for display
        const nameById = {};
        groups.forEach(g => nameById[g.id] = g.name);

        // show user-facing group name if we know their groupId
        const groupNameEl = document.getElementById('groupName');
        if (groupId != null && nameById[groupId]) {
          groupNameEl.textContent = nameById[groupId];
        } else {
          groupNameEl.textContent = '-';
        }

        // superadmin/admin: populate org list and new-user/duty group selector(s)
        const tbody = document.getElementById('groupList');
        if (tbody) {
          tbody.innerHTML = '';
          groups.forEach(g => {
            const tr = document.createElement('tr');
            tr.innerHTML =
              `<td>${g.id}</td><td>${g.name}</td><td>${g.status ?? g.group_status ?? ''}</td>
               <td>
                 <button onclick="archiveGroup(${g.id})">Archive</button>
                 <button onclick="deleteGroup(${g.id})" style="margin-left:6px;color:#b00020">Delete</button>
               </td>`;
            tbody.appendChild(tr);
          });
        }

        // Prepare signup organization predictive map only (do not prefill datalist to avoid full list popup)
        try {
          window.signupGroupMap = {};
          groups
            .sort((a,b) => String(a.name).localeCompare(String(b.name)))
            .forEach(g => {
              window.signupGroupMap[String(g.name).toLowerCase()] = g.id;
            });
          const list = document.getElementById('signupGroupList');
          if (list) list.innerHTML = ''; // keep empty until user types
        } catch { /* silent */ }

        // Populate superadmin org picker
        const orgPicker = document.getElementById('superadminOrgPicker');
        if (orgPicker) {
          const current = orgPicker.value;
          orgPicker.innerHTML = '<option value="">— Select organization —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            orgPicker.appendChild(opt);
          });
          if (current) orgPicker.value = current;
          // Update single-org info panel based on current selection
          const infoWrap = document.getElementById('superadminOrgInfo');
          const infoBody = document.getElementById('superadminOrgInfoBody');
          if (infoWrap && infoBody) {
            if (orgPicker.value) {
              const g = groups.find(x => String(x.id) === String(orgPicker.value));
              if (g) {
                const statusTxt = g.status ?? g.group_status ?? '';
                infoBody.innerHTML = `<tr><td>${g.id}</td><td>${g.name}</td><td>${statusTxt}</td></tr>`;
                infoWrap.classList.remove('hidden');
              } else {
                infoBody.innerHTML = '';
                infoWrap.classList.add('hidden');
              }
            } else {
              infoBody.innerHTML = '';
              infoWrap.classList.add('hidden');
            }
          }
        }

        const groupSelectors = [
          document.getElementById('newUserGroup'),
          document.getElementById('superGroup'),
          document.getElementById('adminGroup'),
          document.getElementById('volGroup'),
          document.getElementById('dutyGroup'),
          document.getElementById('superEventGroupFilter'),
          document.getElementById('superDutyGroupFilter')
        ];
        groupSelectors.forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          const isFilter = sel.id === 'superEventGroupFilter' || sel.id === 'superDutyGroupFilter';
          sel.innerHTML = isFilter ? '<option value="">— Select organization —</option>' : '<option value="">— None —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current; else if (isFilter && groupId != null) sel.value = String(groupId);
          // trigger refresh on filter change
          if (isFilter && !sel._wiredChange) {
            sel.addEventListener('change', () => {
              if (sel.id === 'superEventGroupFilter') fetchEvents();
              if (sel.id === 'superDutyGroupFilter') {
                // Clear current duties immediately and hide any open editor
                const tbody = document.getElementById('dutyList');
                if (tbody) tbody.innerHTML = '';
                const editSel = document.getElementById('dutyEditSelect');
                if (editSel) editSel.innerHTML = '<option value="">— Select duty —</option>';
                const wrap = document.getElementById('dutyEditWrap');
                if (wrap) wrap.classList.add('hidden');
                // Keep Create Duty group selector in sync with chosen org
                const dutyGroupSel = document.getElementById('dutyGroup');
                if (dutyGroupSel) dutyGroupSel.value = sel.value || '';
                // Refresh events for that org first, then duties
                populateEventDropdownsForGroup(sel.value);
                fetchDuties();
              }
            });
            sel._wiredChange = true;
          }
          // when admin changes target group for new duty, repopulate event dropdowns to that org
          if (sel.id === 'dutyGroup' && !sel._wiredDuty) {
            sel.addEventListener('change', () => {
              const gid = sel.value || (groupId != null ? String(groupId) : '');
              populateEventDropdownsForGroup(gid);
            });
            sel._wiredDuty = true;
          }
        });
      } catch (e) { /* silent */ }
    }

    async function deleteGroup(id) {
      try {
        if (!confirm('Delete this organization? This will permanently remove it. You can also Archive instead. Continue?')) return;
        const res = await authed(`/groups/${id}`, { method: 'DELETE' });
        if (res.ok) fetchGroups();
      } catch (e) { /* silent */ }
    }
    async function archiveGroup(id) {
      try {
        if (!confirm('Archive this organization? It will be marked inactive and hidden from selection, but not deleted. Continue?')) return;
        const res = await authed(`/groups/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'inactive' })
        });
        if (res.ok) fetchGroups();
      } catch (e) { /* silent */ }
    }

    document.getElementById('createGroupBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('groupNameInput').value.trim();
      const status = document.getElementById('groupStatus').value;
      try {
        const res = await authed('/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, status })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createGroupError').textContent = data.message || 'Failed to create group';
          return;
        }
        document.getElementById('createGroupError').textContent = '';
        document.getElementById('groupNameInput').value = '';
        fetchGroups();
      } catch {
        document.getElementById('createGroupError').textContent = 'Error creating group';
      }
    });

    // EVENTS
    async function fetchEvents() {
      try {
        let path = '/events';
        if (role === 'superadmin') {
          const sel = document.getElementById('superEventGroupFilter');
          if (sel && sel.value) path = `/events?group_id=${encodeURIComponent(sel.value)}`;
        }
        const res = await authed(path);
        const events = await res.json();
        const tbody = document.getElementById('eventList');
        if (role === 'superadmin') {
          const filterSel = document.getElementById('superEventGroupFilter');
          const filterWrap = document.getElementById('eventsSuperFilter');
          const note = document.getElementById('eventsSuperNote');
          const enforcing = filterWrap && !filterWrap.classList.contains('hidden');
          if (enforcing && filterSel && (!filterSel.value || filterSel.value === '')) {
            if (tbody) tbody.innerHTML = '';
            if (note) { note.classList.remove('error'); note.classList.add('hint'); note.textContent = 'Select an organization above to view events.'; }
            return;
          }
          if (note) note.textContent = '';
        }
        if (tbody) {
        tbody.innerHTML = '';
        events.forEach(e => {
          const tr = document.createElement('tr');
            let actions = '';
            if (role === 'admin' || role === 'superadmin') {
              actions = `<button data-eid="${e.id}" class="editEventPrefillBtn">Edit</button> <button data-eid="${e.id}" class="archiveEventBtn">Archive</button> <button data-eid="${e.id}" class="deleteEventBtn">Delete</button>`;
            }
          const dateTxt = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          tr.innerHTML =
            `<td>${e.id}</td><td>${e.title}</td><td>${dateTxt}</td>
               <td>${e.joined ? `<button data-eid="${e.id}" class="leaveBtn">Leave</button>` : `<button data-eid=\"${e.id}\" class=\"joinBtn\">Join</button>`}</td>
               <td>${actions}</td>`;
          tbody.appendChild(tr);
        });
          // wire actions
          tbody.querySelectorAll('.editEventPrefillBtn').forEach(btn => btn.addEventListener('click', (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            document.getElementById('eventEditWrap').classList.remove('hidden');
            document.getElementById('editEventId').value = String(id);
            const row = Array.from(ev.currentTarget.closest('tr').children);
            document.getElementById('editEventTitle').value = row[1].textContent || '';
            document.getElementById('editEventStart').value = e.start_date || '';
            document.getElementById('editEventEnd').value = e.end_date || '';
            document.getElementById('editEventDesc').value = '';
          }));
          tbody.querySelectorAll('.joinBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/join`, { method: 'POST' });
              if (res.ok) fetchEvents(); else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to join'); }
            } catch { alert('Error joining'); }
          }));
          tbody.querySelectorAll('.leaveBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/leave`, { method: 'POST' });
              if (res.ok) fetchEvents(); else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to leave'); }
            } catch { alert('Error leaving'); }
          }));
          tbody.querySelectorAll('.archiveEventBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            try {
              const res = await authed(`/events/${id}/archive`, { method: 'POST' });
              if (res.ok) fetchEvents(); else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to archive'); }
            } catch { alert('Error archiving'); }
          }));
          tbody.querySelectorAll('.deleteEventBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
            const id = Number(ev.currentTarget.getAttribute('data-eid'));
            if (!confirm('Delete this event?')) return;
            try {
              const res = await authed(`/events/${id}`, { method: 'DELETE' });
              if (res.ok) fetchEvents(); else { const d = await res.json().catch(()=>({})); alert(d.message||'Failed to delete'); }
            } catch { alert('Error deleting'); }
          }));
        }

        // Populate optional event dropdowns for duty creation
        const eventSelects = [document.getElementById('dutyEvent'), document.getElementById('volDutyEvent')];
        eventSelects.forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          sel.innerHTML = '<option value="">— None —</option>';
          events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
            opt.textContent = `${e.title} ${d ? '— ' + d : ''}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current;
        });
        // Populate event group selectors
        const grpSels = [document.getElementById('eventGroup2')];
        for (const grpSel of grpSels) {
          if (!grpSel) continue;
          // ensure groups loaded
          const resG = await authed('/groups');
          const groups = await resG.json();
          const current = grpSel.value;
          grpSel.innerHTML = '<option value="">— Select group —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            grpSel.appendChild(opt);
          });
          if (current) grpSel.value = current; else if (groupId != null) grpSel.value = String(groupId);
        }
      } catch (e) { /* silent */ }
    }

    // Populate duty event dropdowns for a specific organization
    async function populateEventDropdownsForGroup(gid) {
      try {
        const dutySel = document.getElementById('dutyEvent');
        const volSel = document.getElementById('volDutyEvent');
        const clear = (sel) => { if (sel) sel.innerHTML = '<option value="">— None —</option>'; };
        if (!gid) { clear(dutySel); clear(volSel); return; }
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) { clear(dutySel); clear(volSel); return; }
        const events = await res.json();
        [dutySel, volSel].forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          sel.innerHTML = '<option value="">— None —</option>';
          events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
            opt.textContent = `${e.title} ${d ? '— ' + d : ''}`;
            sel.appendChild(opt);
          });
          if (current) sel.value = current;
        });
      } catch { /* silent */ }
    }

    // Populate Clock events by organization (superadmin filter)
    async function populateClockEventsForGroup(gid) {
      try {
        const sel = document.getElementById('clockEventFilter');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select event —</option>';
        sel.disabled = !gid;
        if (!gid) return;
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) return;
        const events = await res.json();
        events.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          opt.textContent = `${e.title}${d ? ' — ' + d : ''}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Populate Clock duties by organization and optional event (superadmin filter)
    async function populateClockDutiesByOrgAndEvent(gid, eventId) {
      try {
        const sel = document.getElementById('clockDutyFilter');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select duty —</option>';
        sel.disabled = !gid ? true : false;
        if (!gid) return;
        let duties = [];
        try {
          const res = await authed(`/duties?group_id=${encodeURIComponent(gid)}`);
          if (res.ok) duties = await res.json();
        } catch { /* ignore */ }
        if (!duties || duties.length === 0) {
          try {
            const resAll = await authed('/duties');
            if (resAll.ok) duties = await resAll.json();
          } catch { /* silent */ }
        }
        const hasEventId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'event_id'));
        if (eventId && hasEventId) duties = duties.filter(d => (d.event_id == null) || (Number(d.event_id) === Number(eventId)));
        const hasGroupId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'group_id'));
        if (hasGroupId) duties = duties.filter(d => (d.group_id == null) || (String(d.group_id) === String(gid)));
        duties.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = `${d.id} — ${d.title}`;
          sel.appendChild(opt);
        });
        sel.disabled = false;
        if (current) sel.value = current;
      } catch { /* silent */ }
    }
    // Populate VM Event select strictly by organization
    async function populateVmEventsByOrg(gid) {
      try {
        const sel = document.getElementById('vmEvent');
        if (!sel) return;
        sel.disabled = !gid;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select event —</option>';
        if (!gid) return;
        const res = await authed(`/events?group_id=${encodeURIComponent(gid)}`);
        if (!res.ok) return;
        const events = await res.json();
        events.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.id;
          const d = e.start_date ? (e.end_date ? `${e.start_date} – ${e.end_date}` : `${e.start_date}`) : (e.event_date || '');
          opt.textContent = `${e.title}${d ? ' — ' + d : ''}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Populate VM Duty select by organization and optional event filter
    async function populateVmDutiesByOrgAndEvent(gid, eventId) {
      try {
        const sel = document.getElementById('vmDuty');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select duty —</option>';
        sel.disabled = !gid ? true : false;
        if (!gid) return;
        // Try org-scoped fetch first; if none returned, fall back to all duties
        let duties = [];
        try {
          const res = await authed(`/duties?group_id=${encodeURIComponent(gid)}`);
          if (res.ok) duties = await res.json();
        } catch { /* ignore, try fallback */ }
        if (!duties || duties.length === 0) {
          try {
            const resAll = await authed('/duties');
            if (resAll.ok) duties = await resAll.json();
          } catch { /* silent */ }
        }
        // Only filter by event if duties actually have an event_id column
        const hasEventId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'event_id'));
        if (eventId && hasEventId) duties = duties.filter(d => (d.event_id == null) || (Number(d.event_id) === Number(eventId)));
        // Prefer matching org when group_id exists; otherwise include all
        const hasGroupId = duties.some(d => Object.prototype.hasOwnProperty.call(d, 'group_id'));
        if (hasGroupId) duties = duties.filter(d => (d.group_id == null) || (String(d.group_id) === String(gid)));
        duties.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = `${d.id} — ${d.title}`;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      } catch { /* silent */ }
    }

    // Removed duplicate Admin Tools create-event handler; use Events page create form instead

    // Create Event (from Events page admin-only form)
    document.getElementById('createEventBtn2')?.addEventListener('click', async () => {
      const title = document.getElementById('eventTitle2').value.trim();
      const description = document.getElementById('eventDesc2').value.trim();
      const grpSel2 = document.getElementById('eventGroup2');
      const gid2 = grpSel2 && grpSel2.value ? Number(grpSel2.value) : (groupId ?? null);
      const start_date = document.getElementById('eventStart2').value;
      const end_date = document.getElementById('eventEnd2').value;
      try {
        const res = await authed('/events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, start_date, end_date, group_id: gid2 })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createEventError2').textContent = data.message || 'Failed to create event';
          return;
        }
        document.getElementById('createEventError2').textContent = '';
        document.getElementById('eventTitle2').value = '';
        document.getElementById('eventDesc2').value = '';
        document.getElementById('eventStart2').value = '';
        document.getElementById('eventEnd2').value = '';
        if (grpSel2) grpSel2.value = groupId != null ? String(groupId) : '';
        fetchEvents();
      } catch {
        document.getElementById('createEventError2').textContent = 'Error creating event';
      }
    });

    // Save event edits
    document.getElementById('saveEventBtn')?.addEventListener('click', async () => {
      const id = Number(document.getElementById('editEventId').value);
      const title = document.getElementById('editEventTitle').value.trim();
      const description = document.getElementById('editEventDesc').value.trim();
      const start_date = document.getElementById('editEventStart').value;
      const end_date = document.getElementById('editEventEnd').value;
      try {
        const res = await authed(`/events/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, start_date, end_date })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { document.getElementById('editEventError').textContent = data.message || 'Failed to save event'; return; }
        document.getElementById('editEventError').textContent = '';
        document.getElementById('eventEditWrap').classList.add('hidden');
        await fetchEvents();
      } catch { document.getElementById('editEventError').textContent = 'Error saving event'; }
    });

    // DUTIES (admin-managed; volunteer sees assigned duties)
    async function fetchDuties() {
      try {
        let path = '/duties';
        if (role === 'superadmin') {
          const sel = document.getElementById('superDutyGroupFilter');
          if (sel && sel.value) path = `/duties?group_id=${encodeURIComponent(sel.value)}`;
          // Superadmin should not see the "My Duties" table
          const dutiesWrap = document.getElementById('clockDutiesWrap');
          if (dutiesWrap) dutiesWrap.classList.add('hidden');
        }
        const res = await authed(path); // backend should return duties user can see
        const duties = await res.json();
        // Build a duty map for later event-based filtering in time-tracking
        try {
          window.dutyById = {};
          (duties || []).forEach(d => { if (d && d.id != null) window.dutyById[d.id] = d; });
        } catch { /* ignore */ }
        const tbody = document.getElementById('dutyList');
        if (role === 'superadmin') {
          const filterSel = document.getElementById('superDutyGroupFilter');
          const filterWrap = document.getElementById('dutiesSuperFilter');
          const note = document.getElementById('dutiesSuperNote');
          const enforcing = filterWrap && !filterWrap.classList.contains('hidden');
          if (enforcing && filterSel && (!filterSel.value || filterSel.value === '')) {
            if (tbody) tbody.innerHTML = '';
            // Disable dependent duty selects until org is chosen
            const photoDutySel = document.getElementById('photoDuty');
            if (photoDutySel) { photoDutySel.innerHTML = '<option value="">— Select organization first —</option>'; photoDutySel.disabled = true; }
            const editSel = document.getElementById('dutyEditSelect');
            if (editSel) { editSel.innerHTML = '<option value="">— Select organization first —</option>'; editSel.disabled = true; }
            const vmDutySel = document.getElementById('vmDuty');
            if (vmDutySel) { vmDutySel.innerHTML = '<option value="">— Select organization first —</option>'; vmDutySel.disabled = true; }
            if (note) { note.classList.remove('error'); note.classList.add('hint'); note.textContent = 'Select an organization above to view duties.'; }
            return;
          }
          if (note) note.textContent = '';
        }
        if (!tbody) return;
        tbody.innerHTML = '';
        // populate duty table rows and photo duty select
        const dutySelect = document.getElementById('photoDuty');
        const editSelect = document.getElementById('dutyEditSelect');
        if (dutySelect) { dutySelect.innerHTML = ''; dutySelect.disabled = false; }
        if (editSelect) { editSelect.innerHTML = '<option value="">— Select duty —</option>'; editSelect.disabled = false; }
        const vmDutySelEnabled = document.getElementById('vmDuty');
        if (vmDutySelEnabled) vmDutySelEnabled.disabled = false;
        duties.forEach(d => {
          const tr = document.createElement('tr');
          let adminActions = '';
          if (role === 'admin' || role === 'superadmin') {
            adminActions = `<button data-did="${d.id}" class="prefillDutyEditBtn">Edit</button>`;
          }
          tr.innerHTML =
            `<td>${d.id}</td><td>${d.title}</td><td>${d.description || ''}</td><td>${d.status}</td>
             <td>
               <input type="date" id="dutyDate-${d.id}" required>
               <button onclick="startTime(${d.id})">Clock In</button>
               <button onclick="stopTime(${d.id})">Clock Out</button>
               ${adminActions}
             </td>`;
          tbody.appendChild(tr);
          if (dutySelect) {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.id} — ${d.title}`;
            dutySelect.appendChild(opt);
          }
          if (editSelect) {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.id} — ${d.title}`;
            editSelect.appendChild(opt);
          }
        });
        // wire prefill duty edit
        tbody.querySelectorAll('.prefillDutyEditBtn').forEach(btn => btn.addEventListener('click', (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-did'));
          const row = ev.currentTarget.closest('tr').children;
          const wrap = document.getElementById('dutyEditWrap');
          if (wrap) wrap.classList.remove('hidden');
          document.getElementById('editDutyId').value = String(id);
          document.getElementById('editDutyTitle').value = row[1].textContent || '';
          document.getElementById('editDutyDesc').value = row[2].textContent || '';
          document.getElementById('editDutyStatus').value = (row[3].textContent || 'pending');
        }));
      } catch (e) { /* silent */ }
    }

    // Wire selecting a duty to prefill edit form
    document.getElementById('dutyEditSelect')?.addEventListener('change', () => {
      const sel = document.getElementById('dutyEditSelect');
      if (!sel || !sel.value) return;
      const id = Number(sel.value);
      const row = Array.from(document.querySelectorAll('#dutyList tr')).find(tr => tr.firstChild?.textContent == String(id));
      if (!row) { document.getElementById('dutyEditWrap').classList.remove('hidden'); document.getElementById('editDutyId').value = String(id); return; }
      const cells = row.children;
      document.getElementById('dutyEditWrap').classList.remove('hidden');
      document.getElementById('editDutyId').value = String(id);
      document.getElementById('editDutyTitle').value = cells[1].textContent || '';
      document.getElementById('editDutyDesc').value = cells[2].textContent || '';
      document.getElementById('editDutyStatus').value = (cells[3].textContent || 'pending');
    });

    // Create Duty (admin)
    document.getElementById('createDutyBtn')?.addEventListener('click', async () => {
      const title = document.getElementById('dutyTitle').value.trim();
      const description = document.getElementById('dutyDesc').value.trim();
      const groupSel = document.getElementById('dutyGroup');
      const group_id = groupSel && groupSel.value ? Number(groupSel.value) : (groupId ?? null);
      const eventSel = document.getElementById('dutyEvent');
      const event_id = eventSel && eventSel.value ? Number(eventSel.value) : null;
      const status = document.getElementById('dutyStatus').value;
      try {
        const res = await authed('/duties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, status, group_id, event_id })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('createDutyError').textContent = data.message || 'Failed to create duty';
          return;
        }
        document.getElementById('createDutyError').textContent = '';
        document.getElementById('dutyTitle').value = '';
        document.getElementById('dutyDesc').value = '';
        if (eventSel) eventSel.value = '';
        // If superadmin, sync the top org filter to the group used so list shows immediately
        if (role === 'superadmin') {
          const topFilter = document.getElementById('superDutyGroupFilter');
          if (topFilter && group_id != null) topFilter.value = String(group_id);
        }
        await fetchDuties();
        // Select the newly created duty in the edit dropdown
        const editSel = document.getElementById('dutyEditSelect');
        if (editSel && group_id != null) {
          // Pick the last option (newest) if present
          if (editSel.options.length > 1) editSel.selectedIndex = editSel.options.length - 1;
          const evt = new Event('change');
          editSel.dispatchEvent(evt);
        }
      } catch {
        document.getElementById('createDutyError').textContent = 'Error creating duty';
      }
    });

    // Save duty edits
    document.getElementById('saveDutyBtn')?.addEventListener('click', async () => {
      const id = Number(document.getElementById('editDutyId').value);
      const title = document.getElementById('editDutyTitle').value.trim();
      const description = document.getElementById('editDutyDesc').value.trim();
      const status = document.getElementById('editDutyStatus').value;
      try {
        const res = await authed(`/duties/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, status })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { document.getElementById('editDutyError').textContent = data.message || 'Failed to save duty'; return; }
        document.getElementById('editDutyError').textContent = '';
        document.getElementById('dutyEditWrap').classList.add('hidden');
        await fetchDuties();
      } catch { document.getElementById('editDutyError').textContent = 'Error saving duty'; }
    });

    // Create Duty (volunteer)
    document.getElementById('volCreateDutyBtn')?.addEventListener('click', async () => {
      const title = document.getElementById('volDutyTitle').value.trim();
      const description = document.getElementById('volDutyDesc').value.trim();
      const eventSel = document.getElementById('volDutyEvent');
      const event_id = eventSel && eventSel.value ? Number(eventSel.value) : null;
      try {
        const res = await authed('/duties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, event_id })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('volCreateDutyError').textContent = data.message || 'Failed to create duty';
          return;
        }
        document.getElementById('volCreateDutyError').textContent = '';
        document.getElementById('volDutyTitle').value = '';
        document.getElementById('volDutyDesc').value = '';
        if (eventSel) eventSel.value = '';
        fetchDuties();
      } catch {
        document.getElementById('volCreateDutyError').textContent = 'Error creating duty';
      }
    });

    async function startTime(dutyId) {
      try {
        const dutyDate = document.getElementById(`dutyDate-${dutyId}`).value;
        const res = await authed(`/duties/${dutyId}/time/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duty_date: dutyDate })
        });
        if (res.ok) fetchTimeTracking();
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to clock in');
        }
      } catch {
        alert('Error clocking in');
      }
    }

    async function stopTime(dutyId) {
      try {
        const res = await authed(`/duties/${dutyId}/time/end`, { method: 'POST' });
        if (res.ok) fetchTimeTracking();
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to clock out');
        }
      } catch {
        alert('Error clocking out');
      }
    }

    // TIMESHEET
    async function fetchTimeTracking() {
      try {
        const tbody = document.getElementById('timeList');
        if (!tbody) return;
        let rows = [];
        // Scope for admin and superadmin and enforce superadmin gating by org->event->duty
        if (role === 'superadmin') {
          const note = document.getElementById('clockSuperNote');
          const gid = document.getElementById('clockOrgFilter')?.value || '';
          const eid = document.getElementById('clockEventFilter')?.value || '';
          const did = document.getElementById('clockDutyFilter')?.value || '';
          if (!gid) {
            if (note) note.textContent = 'Select an organization to view times.';
            const timesWrap = document.getElementById('clockTimesWrap');
            if (timesWrap) timesWrap.classList.add('hidden');
            tbody.innerHTML = '';
            return;
          }
          if (!eid) {
            if (note) note.textContent = 'Select an event to view times.';
            const timesWrap = document.getElementById('clockTimesWrap');
            if (timesWrap) timesWrap.classList.add('hidden');
            tbody.innerHTML = '';
            return;
          }
          if (!did) {
            if (note) note.textContent = 'Select a duty to view times.';
            const timesWrap = document.getElementById('clockTimesWrap');
            if (timesWrap) timesWrap.classList.add('hidden');
            tbody.innerHTML = '';
            return;
          }
          if (note) note.textContent = '';
          const timesWrap = document.getElementById('clockTimesWrap');
          if (timesWrap) timesWrap.classList.remove('hidden');
          const res = await authed(`/time-tracking?group_id=${encodeURIComponent(gid)}`);
          if (!res.ok) { tbody.innerHTML=''; return; }
          rows = await res.json();
          // Client-side filter by selected duty; if rows lack duty_id, nothing will show
          rows = (rows || []).filter(r => String(r.duty_id || '') === String(did));
        } else {
          const params = new URLSearchParams();
          if (role === 'admin' && groupId != null) params.set('group_id', String(groupId));
          const res = await authed(`/time-tracking${params.toString() ? `?${params.toString()}` : ''}`);
          if (!res.ok) { tbody.innerHTML=''; return; }
          rows = await res.json();
        }
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          tr.innerHTML =
            `<td>${r.id}</td><td>${r.duty_id || ''}</td>
             <td class="nowrap">${r.start_time || ''}</td>
             <td class="nowrap">${r.end_time || ''}</td>
             <td>${hours}</td>
             <td>${r.duty_date || ''}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) { /* silent */ }
    }

    // Volunteer Management helpers
    async function fetchVolunteers(groupIdForFilter) {
      try {
        const params = new URLSearchParams();
        params.set('role', 'volunteer');
        // Filter by org when provided (admins and superadmins)
        if (groupIdForFilter) params.set('group_id', String(groupIdForFilter));
        const res = await authed(`/users?${params.toString()}`);
        if (!res.ok) return [];
        return await res.json();
      } catch { return []; }
    }

    // Explicitly populate the top Volunteer dropdown for admins using the same API as the edit list
    async function populateTopVolunteerForAdmin() {
      try {
        if (role !== 'admin') return;
        const volSel = document.getElementById('vmVolunteer');
        if (!volSel) return;
        const res = await authed('/users?role=volunteer');
        if (!res.ok) return;
        const list = await res.json();
        const cur = volSel.value;
        volSel.innerHTML = '<option value="">— Select volunteer —</option>';
        list.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name ? `${v.name}` : v.email;
          volSel.appendChild(opt);
        });
        volSel.disabled = false;
        if (cur) volSel.value = cur;
        // cache for focus repopulation
        volSel._all = list;
      } catch { /* silent */ }
    }
    async function fetchUsersForSuperadmin() {
      try {
        const orgSel = document.getElementById('superadminOrgPicker');
        const roleSel = document.getElementById('saUserRole');
        const chosenRole = (roleSel && roleSel.value) ? roleSel.value : 'admin';
        const params = new URLSearchParams();
        if (chosenRole && chosenRole !== 'all') params.set('role', chosenRole);
        // Only apply org filter for admin/volunteer; superadmins are global
        const applyOrg = (chosenRole === 'admin' || chosenRole === 'volunteer');
        if (applyOrg && orgSel && orgSel.value) params.set('group_id', orgSel.value);
        const res = await authed(`/users?${params.toString()}`);
        if (!res.ok) return [];
        return await res.json();
      } catch { return []; }
    }
    async function populateSuperadminUsers() {
      try {
        const users = await fetchUsersForSuperadmin();
        const sel = document.getElementById('saAdminSelect');
        const selRow = document.getElementById('saAdminRow');
        if (selRow) {
          const roleSel = document.getElementById('saUserRole');
          const chosenRole = (roleSel && roleSel.value) ? roleSel.value : 'admin';
          const orgPicker = document.getElementById('superadminOrgPicker');
          const requireOrg = (chosenRole === 'admin' || chosenRole === 'volunteer');
          selRow.classList.toggle('hidden', requireOrg ? !orgPicker?.value : false);
        }
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '<option value="">— Select user —</option>';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          const label = u.name ? `${u.name} — ${u.email}` : u.email;
          opt.textContent = label;
          sel.appendChild(opt);
        });
        sel._users = users;
        if (current) sel.value = current;
        // Hide edit panel if selection cleared or missing user
        const panel = document.getElementById('saAdminEditPanel');
        if (panel && (!sel.value || !users.find(a => String(a.id) === sel.value))) panel.classList.add('hidden');
      } catch { /* silent */ }
    }
    async function populateVolunteerMgmt() {
      try {
        const orgVal = (role === 'superadmin') ? (document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || '') : (groupId != null ? String(groupId) : '');
        // Admins don't pick org: ensure key rows are visible
        if (role !== 'superadmin') {
          const vRow0 = document.getElementById('vmVolunteerRow'); if (vRow0) vRow0.classList.remove('hidden');
          const eRow0 = document.getElementById('vmEditSelectRow'); if (eRow0) eRow0.classList.remove('hidden');
        }
        // Gate volunteer controls until org is selected for superadmin
        if (role === 'superadmin' && !orgVal) {
          const vSel = document.getElementById('vmVolunteer');
          if (vSel) { vSel.innerHTML = '<option value="">— Select organization first —</option>'; vSel.disabled = true; }
          const eSel = document.getElementById('vmEditSelect');
          if (eSel) { eSel.innerHTML = '<option value="">— Select organization first —</option>'; eSel.disabled = true; }
          const logBody = document.getElementById('vmLogList');
          if (logBody) logBody.innerHTML = '';
          // Also set Create Volunteer group to selected org when user picks it later
          const gSelInit = document.getElementById('vmVolGroup');
          if (gSelInit) gSelInit.value = '';
          return;
        }
        const volunteers = await fetchVolunteers(orgVal);
        const volSel = document.getElementById('vmVolunteer');
        if (volSel) {
          const current = volSel.value;
          // Always show volunteer placeholder (org gating handled earlier)
          volSel.innerHTML = '<option value="">— Select volunteer —</option>';
          // cache list and apply search filter
          volSel._all = volunteers;
          const search = document.getElementById('vmVolunteerSearch');
          const applyFilter = () => {
            const q = (search?.value || '').trim().toLowerCase();
            const list = volSel._all || [];
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            list.filter(v => !q || (v.name && v.name.toLowerCase().includes(q)) || (v.email && v.email.toLowerCase().includes(q)))
                .forEach(v => {
                  const opt = document.createElement('option');
                  opt.value = v.id;
                  opt.textContent = v.name ? `${v.name}` : v.email;
                  volSel.appendChild(opt);
                });
            if (current) volSel.value = current;
          };
          applyFilter();
          if (search && !search._wired) { search.addEventListener('input', applyFilter); search._wired = true; }
          // Enable volunteer selection for superadmin when org is chosen
          const enableVol = (role !== 'superadmin') || !!orgVal;
          volSel.disabled = !enableVol;
          if (current) volSel.value = current;
          // Fallback: if nothing rendered, append all volunteers explicitly
          if (volSel.options.length <= 1 && (volSel._all && volSel._all.length)) {
            const cur2 = volSel.value;
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            (volSel._all || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volSel.appendChild(opt);
            });
            if (cur2) volSel.value = cur2;
          }
        }
        // Populate volunteer edit dropdown
        const editSel = document.getElementById('vmEditSelect');
        if (editSel) {
          const current = editSel.value;
          editSel.innerHTML = '<option value="">— Select volunteer —</option>';
          volunteers.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = `${v.id} — ${v.name || v.email}`;
            editSel.appendChild(opt);
          });
          if (current) editSel.value = current;
          if (!editSel._wired) {
            editSel.addEventListener('change', () => {
              const id = Number(editSel.value);
              const v = volunteers.find(x => x.id === id);
          if (!v) return;
              const panel = document.getElementById('vmEditPanel');
              if (panel) panel.classList.remove('hidden');
              document.getElementById('vmEditId').value = String(v.id);
              document.getElementById('vmEditName').value = v.name || '';
              document.getElementById('vmEditEmail').value = v.email || '';
              const pw = document.getElementById('vmEditPassword'); if (pw) pw.value = '';
              document.getElementById('vmEditPhone').value = v.phone || '';
              document.getElementById('vmEditAddress').value = v.address || '';
              // Mirror the edit selection into the top Volunteer dropdown so it always has options and selection
              try {
                const volTop = document.getElementById('vmVolunteer');
                if (volTop) {
                  volTop.innerHTML = '<option value="">— Select volunteer —</option>';
                  (volunteers || []).forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = u.name ? `${u.name}` : u.email;
                    volTop.appendChild(opt);
                  });
                  volTop.value = String(id);
                  volTop.disabled = false;
                }
              } catch { /* silent */ }
            });
            editSel._wired = true;
          }
          editSel.disabled = false;
          // Also seed the top Volunteer dropdown if it only has the placeholder
          const volTop = document.getElementById('vmVolunteer');
          if (volTop && volTop.options.length <= 1) {
            const cur = volTop.value;
            volTop.innerHTML = '<option value="">— Select volunteer —</option>';
            volunteers.forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volTop.appendChild(opt);
            });
            if (cur) volTop.value = cur;
          }
          // Show volunteer edit selector: superadmin only after org selected; admins always
          const vmEditRow = document.getElementById('vmEditSelectRow');
          if (vmEditRow) vmEditRow.classList.toggle('hidden', role === 'superadmin' ? !orgVal : false);
          // Ensure top Volunteer is always fully synced to the same list as the edit dropdown
          try {
            const volTop2 = document.getElementById('vmVolunteer');
            if (volTop2) {
              const keep2 = volTop2.value;
              // Copy the exact options from the edit dropdown so both show identical data
              volTop2.innerHTML = editSel.innerHTML;
              if (keep2) volTop2.value = keep2;
              volTop2.disabled = (role === 'superadmin') ? !orgVal : false;
            }
          } catch { /* silent */ }
        }
        // Groups for Create Volunteer
        const resG = await authed('/groups');
        const groups = await resG.json();
        const gSel = document.getElementById('vmVolGroup');
        if (gSel) {
          const current = gSel.value;
          gSel.innerHTML = '<option value="">— None —</option>';
          groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = `${g.name}`;
            gSel.appendChild(opt);
          });
          if (current) gSel.value = current; else if (role === 'superadmin' && orgVal) gSel.value = String(orgVal); else if (groupId != null) gSel.value = String(groupId);
        }
        // Events list (current org) for cascade
        const vmEventRow = document.getElementById('vmEventRow');
        const vmEventSel = document.getElementById('vmEvent');
        if (role === 'superadmin') {
          if (vmEventRow) vmEventRow.classList.toggle('hidden', !orgVal);
          // Gate Duty/Volunteer placeholders firmly based on current cascade state
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          if (dutySel) { dutySel.disabled = !orgVal; dutySel.innerHTML = orgVal ? '<option value="">— Select duty —</option>' : '<option value="">— Select organization first —</option>'; }
          if (volSel) {
            // Only disable/enable; don't wipe options that were already populated
            volSel.disabled = !vmOrgSel.value;
            if (!vmOrgSel.value && volSel.options.length <= 1) {
              volSel.innerHTML = '<option value="">— Select organization first —</option>';
            }
          }
        } else {
          // Admins: event row should be visible since org is implied; keep volunteers enabled
          if (vmEventRow) vmEventRow.classList.remove('hidden');
          const volSel = document.getElementById('vmVolunteer');
          if (volSel) { volSel.disabled = false; /* keep existing options */ }
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.remove('hidden');
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.remove('hidden');
          const logsRow = document.getElementById('vmLogsRow'); if (logsRow) logsRow.classList.remove('hidden');
        }
        let events = [];
        if (orgVal) {
          const resE = await authed(`/events?group_id=${encodeURIComponent(orgVal)}`);
          events = await resE.json();
        }
        if (vmEventSel) {
          const currentEvt = vmEventSel.value;
          vmEventSel.innerHTML = '<option value="">— Select event —</option>';
          events.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.title || `Event #${e.id}`;
            vmEventSel.appendChild(opt);
          });
          if (currentEvt) vmEventSel.value = currentEvt;
          vmEventSel.disabled = !orgVal;
        }
        // Duties list (current org, optionally filter by selected event)
        let duties = [];
        if (orgVal) {
          const res = await authed(`/duties?group_id=${encodeURIComponent(orgVal)}`);
          duties = await res.json();
        }
        const eventFilterId = Number(document.getElementById('vmEvent')?.value || '') || null;
        // Only filter by event when duties actually carry event_id; include duties with no event_id linkage
        if (eventFilterId && duties.some(d => Object.prototype.hasOwnProperty.call(d, 'event_id')))
          duties = duties.filter(d => (d.event_id == null) || (Number(d.event_id) === eventFilterId));
        const dutySel = document.getElementById('vmDuty');
        if (dutySel) {
          const current = dutySel.value;
          dutySel.innerHTML = '<option value="">— Select duty —</option>';
          duties.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `${d.id} — ${d.title}`;
            dutySel.appendChild(opt);
          });
          dutySel.disabled = !orgVal ? true : false;
          if (current) dutySel.value = current;
        }
        // Final safeguard: ensure the top Volunteer dropdown is fully populated for admins just like the edit list
        try {
          const volTopFinal = document.getElementById('vmVolunteer');
          if (volTopFinal) {
            const keep = volTopFinal.value;
            volTopFinal.disabled = (role === 'superadmin') ? !orgVal : false;
            volTopFinal.innerHTML = '<option value="">— Select volunteer —</option>';
            (volunteers || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volTopFinal.appendChild(opt);
            });
            if (keep) volTopFinal.value = keep;
          }
        } catch { /* silent */ }
      } catch { /* silent */ }
    }
    async function fetchVolunteerLogs(volunteerId) {
      try {
        const res = await authed(`/time-tracking?volunteer_id=${encodeURIComponent(volunteerId)}`);
        if (!res.ok) return [];
        return await res.json();
      } catch { return []; }
    }
    async function refreshVolunteerLogs() {
      const sel = document.getElementById('vmVolunteer');
      const tbody = document.getElementById('vmLogList');
      if (!sel || !tbody || !sel.value) { if (tbody) tbody.innerHTML=''; return; }
      const logs = await fetchVolunteerLogs(sel.value);
      tbody.innerHTML = '';
      logs.forEach(r => {
        const tr = document.createElement('tr');
        const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
        tr.innerHTML = `<td>${r.id}</td><td>${r.duty_id || ''}</td><td>${r.start_time || ''}</td><td>${r.end_time || ''}</td><td>${hours}</td><td>${r.duty_date || ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // APPROVAL QUEUE (admin)
    async function fetchApprovals() {
      if (role !== 'admin' && role !== 'superadmin') return;
      try {
        const res = await authed('/time-tracking');
        const rows = await res.json();
        const tbody = document.getElementById('approvalList');
        if (!tbody) return;
        tbody.innerHTML = '';
        rows.filter(r => !r.approved).forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          tr.innerHTML =
            `<td>${r.id}</td><td>${r.volunteer_id || ''}</td><td>${hours}</td><td>${r.duty_date || ''}</td>
             <td><button onclick="approve(${r.id})">Approve</button></td>`;
          tbody.appendChild(tr);
        });
      } catch (e) { /* silent */ }
    }
    async function approve(id) {
      try {
        const res = await authed(`/time-tracking/${id}/approve`, { method: 'POST' });
        if (res.ok) fetchApprovals();
      } catch (e) { /* silent */ }
    }

    // ADMIN TIMES TABLE
   async function fetchAdminTimes() {
      if (role !== 'admin' && role !== 'superadmin') return;
      try {
        let path = '/time-tracking';
        if (role === 'superadmin') {
          const gid = document.getElementById('superadminOrgPicker')?.value;
          const t1 = document.getElementById('adminTimeList');
          const t2 = document.getElementById('superAdminTimeList');
          if (!gid) { [t1, t2].forEach(t => { if (t) t.innerHTML = ''; }); return; }
          path += `?group_id=${encodeURIComponent(gid)}`;
        }
        const res = await authed(path);
        const rows = await res.json();
        const tbody = document.getElementById('superAdminTimeList') || document.getElementById('adminTimeList');
        if (!tbody) return;
        tbody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const hours = (r.duration_hours != null ? Number(r.duration_hours).toFixed(2) : '');
          tr.innerHTML =
            `<td>${r.id}</td><td>${r.volunteer_id || ''}</td><td>${r.duty_id || ''}</td>
             <td><input type="datetime-local" id="start-${r.id}" value="${formatDateTimeLocal(r.start_time)}"></td>
             <td><input type="datetime-local" id="end-${r.id}" value="${formatDateTimeLocal(r.end_time)}"></td>
             <td>${hours}</td>
             <td><input type="date" id="date-${r.id}" value="${formatDateLocal(r.duty_date)}"></td>
             <td><button onclick="saveTime(${r.id})">Save</button></td>
             <td><button onclick="deleteTime(${r.id})">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      } catch (e) { /* silent */ }
    }

    function formatDateTimeLocal(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function formatDateLocal(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    async function saveTime(id) {
      try {
        const payload = {
          start_time: document.getElementById(`start-${id}`).value || null,
          end_time: document.getElementById(`end-${id}`).value || null,
          duty_date: document.getElementById(`date-${id}`).value || null,
        };
        const res = await authed(`/time-tracking/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) { fetchAdminTimes(); fetchTimeTracking(); fetchApprovals(); }
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to save');
        }
      } catch { alert('Error saving'); }
    }
    async function deleteTime(id) {
      if (!confirm('Delete this time log?')) return;
      try {
        const res = await authed(`/time-tracking/${id}`, { method: 'DELETE' });
        if (res.ok) { fetchAdminTimes(); fetchTimeTracking(); fetchApprovals(); }
        else {
          const data = await res.json().catch(() => ({}));
          alert(data.message || 'Failed to delete');
        }
      } catch { alert('Error deleting'); }
    }
    

    // Profile
    async function loadMe() {
      try {
        const res = await authed('/me');
        if (!res.ok) return;
        const me = await res.json();
        document.getElementById('acctName').value = me.name || '';
        document.getElementById('acctEmail').value = me.email || '';
        document.getElementById('acctPhone').value = me.phone || '';
        document.getElementById('acctAddress').value = me.address || '';
      } catch { /* silent */ }
    }

    document.getElementById('saveAccountInfo')?.addEventListener('click', async () => {
      document.getElementById('accountInfoError').textContent = '';
      try {
        const res = await authed('/account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: document.getElementById('acctName').value.trim(),
            email: document.getElementById('acctEmail').value.trim(),
            phone: document.getElementById('acctPhone').value.trim(),
            address: document.getElementById('acctAddress').value.trim(),
          })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('accountInfoError').textContent = data.message || 'Failed to save profile';
          return;
        }
        document.getElementById('accountInfoError').textContent = '';
      } catch {
        document.getElementById('accountInfoError').textContent = 'Error saving profile';
      }
    });

    // (Per-user theming removed)

    // NAVIGATION / TOOLBAR
    function hideMainSections() {
      ['infoSection','superadminSection','homeSection','createDutySection','clockSection','photosSection','eventsSection','adminSection','volMgmtSection'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }
    function navigateTo(sectionId) {
      hideMainSections();
      show(sectionId);
    }
    function setupToolbar(currentRole) {
      async function showEditableOrgInfoPanel(selectedId) {
        const infoWrap = document.getElementById('superadminOrgInfo');
        const infoBody = document.getElementById('superadminOrgInfoBody');
        if (!infoWrap || !infoBody) return;
        if (!selectedId) { infoBody.innerHTML=''; infoWrap.classList.add('hidden'); return; }
        // Ensure header has Save/Archive/Delete cols
        const table = infoWrap.querySelector('table thead tr');
        if (table) {
          const headers = Array.from(table.children).map(th => th.textContent?.toLowerCase?.() || '');
          if (!headers.includes('save')) { const th = document.createElement('th'); th.textContent = 'Save'; table.appendChild(th); }
          if (!headers.includes('archive')) { const thA = document.createElement('th'); thA.textContent = 'Archive'; table.appendChild(thA); }
          if (!headers.includes('delete')) { const thD = document.createElement('th'); thD.textContent = 'Delete'; table.appendChild(thD); }
        }
        // Load groups to get status
        let group = null;
        try {
          const res = await authed('/groups');
          if (res.ok) {
            const groups = await res.json();
            group = groups.find(g => String(g.id) === String(selectedId));
          }
        } catch {}
        const name = group?.name || (document.getElementById('superadminOrgPicker')?.options[document.getElementById('superadminOrgPicker')?.selectedIndex || 0]?.textContent || '');
        const status = (group?.status ?? group?.group_status ?? 'active').toString().toLowerCase();
        infoBody.innerHTML = `<tr>
            <td>${selectedId}</td>
            <td><input id="saOrgName" type="text" value="${name.replace(/"/g,'&quot;')}"></td>
            <td>
              <select id="saOrgStatus">
                <option value="active" ${status==='active'?'selected':''}>active</option>
                <option value="inactive" ${status==='inactive'?'selected':''}>inactive</option>
              </select>
            </td>
            <td><button id="saOrgSaveBtn">Save</button></td>
            <td><button id="saOrgArchiveBtn">Archive</button></td>
            <td><button id="saOrgDeleteBtn" style="color:#b00020">Delete</button></td>
          </tr>`;
        infoWrap.classList.remove('hidden');
        const errEl = document.getElementById('superadminOrgInfoErr'); if (errEl) errEl.textContent='';
        const save = document.getElementById('saOrgSaveBtn');
        if (save) {
          save.onclick = async () => {
            const nameVal = document.getElementById('saOrgName')?.value.trim();
            const statusVal = document.getElementById('saOrgStatus')?.value;
            if (errEl) errEl.textContent='';
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: nameVal, status: statusVal }) });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (errEl) errEl.textContent = data.message || 'Failed to save'; return; }
              // Reflect updated values in picker
              const picker = document.getElementById('superadminOrgPicker');
              if (picker && nameVal) {
                const opt = Array.from(picker.options).find(o => o.value === String(selectedId));
                if (opt) opt.textContent = nameVal;
              }
            } catch { if (errEl) errEl.textContent = 'Error saving'; }
          };
        }
        const archiveBtn = document.getElementById('saOrgArchiveBtn');
        if (archiveBtn) {
          archiveBtn.onclick = async () => {
            if (!confirm('Archive this organization? It will be marked inactive and hidden from selection. Continue?')) return;
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'inactive' }) });
              if (!res.ok) { const d = await res.json().catch(()=>({})); if (errEl) errEl.textContent = d.message || 'Failed to archive'; return; }
              if (errEl) errEl.textContent = '';
              fetchGroups();
            } catch { if (errEl) errEl.textContent = 'Error archiving'; }
          };
        }
        const deleteBtn = document.getElementById('saOrgDeleteBtn');
        if (deleteBtn) {
          deleteBtn.onclick = async () => {
            if (!confirm('Delete this organization? This permanently removes it. You can archive instead. Continue to delete?')) return;
            try {
              const res = await authed(`/groups/${selectedId}`, { method: 'DELETE' });
              if (!res.ok) { const d = await res.json().catch(()=>({})); if (errEl) errEl.textContent = d.message || 'Failed to delete'; return; }
              if (errEl) errEl.textContent = '';
              // Clear picker after delete
              const picker = document.getElementById('superadminOrgPicker'); if (picker) picker.value = '';
              fetchGroups();
            } catch { if (errEl) errEl.textContent = 'Error deleting'; }
          };
        }
      }
      const tb = document.getElementById('toolbar');
      if (!tb) return;
      // Toolbar ready; rely on DOM order
      tb.classList.remove('hidden');
      const isVolunteer = currentRole === 'volunteer';
      const isAdminish = currentRole === 'admin' || currentRole === 'superadmin';
      // Hard reset of cross-page dropdown selections
      function resetGlobalFilters() {
        // Superadmin global pickers
        const sap = document.getElementById('superadminOrgPicker'); if (sap) sap.value = '';
        const sdf = document.getElementById('superDutyGroupFilter'); if (sdf) sdf.value = '';
        const sef = document.getElementById('superEventGroupFilter'); if (sef) sef.value = '';
        const evf = document.getElementById('eventsSuperFilter'); if (evf) evf.value = '';
        // Create Duty/Edit Duty dependent selects
        const deSel = document.getElementById('dutyEditSelect'); if (deSel) { deSel.innerHTML = '<option value="">— Select duty —</option>'; deSel.disabled = true; }
        // Photos filters
        const pvf = document.getElementById('photosVolunteerFilter'); if (pvf) pvf.value = '';
        // Volunteer Mgmt selections/rows
        const vmOrg = document.getElementById('vmOrgPicker'); if (vmOrg) vmOrg.value = '';
        const vmEvt = document.getElementById('vmEvent'); if (vmEvt) vmEvt.innerHTML = '<option value="">— Select event —</option>';
        const vmDuty = document.getElementById('vmDuty'); if (vmDuty) { vmDuty.innerHTML = '<option value="">— Select organization first —</option>'; vmDuty.disabled = true; }
        const vmVol = document.getElementById('vmVolunteer'); if (vmVol) { vmVol.innerHTML = '<option value="">— Select volunteer —</option>'; vmVol.disabled = (currentRole === 'superadmin'); }
        const vmEditSel = document.getElementById('vmEditSelect'); if (vmEditSel) vmEditSel.innerHTML = '<option value="">— Select volunteer —</option>';
        const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', currentRole === 'superadmin');
        const eRow = document.getElementById('vmEventRow'); if (eRow) eRow.classList.toggle('hidden', currentRole === 'superadmin');
        const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
        const vmPanel = document.getElementById('vmEditPanel'); if (vmPanel) vmPanel.classList.add('hidden');
      }
      document.getElementById('navAdminBtn').classList.toggle('hidden', !isAdminish);
      document.getElementById('navVolunteerMgmtBtn').classList.toggle('hidden', !isAdminish);
      document.getElementById('navCreateDutyBtn').classList.toggle('hidden', !isAdminish);
      // Show Time Clock and Photos for volunteers AND admins/superadmins
      document.getElementById('navClockBtn').classList.toggle('hidden', !(isVolunteer || isAdminish));
      document.getElementById('navPhotosBtn').classList.toggle('hidden', !(isVolunteer || isAdminish));
      document.getElementById('navHomeBtn').onclick = () => { resetGlobalFilters(); navigateTo('homeSection'); };
      function resetVolunteerMgmtUI() {
        const orgRow = document.getElementById('vmSuperOrgRow');
        const orgSel = document.getElementById('vmOrgPicker');
        const evtRow = document.getElementById('vmEventRow');
        const evtSel = document.getElementById('vmEvent');
        const dutySel = document.getElementById('vmDuty');
        const volSel = document.getElementById('vmVolunteer');
        const search = document.getElementById('vmVolunteerSearch');
        const logs = document.getElementById('vmLogList');
        const editPanel = document.getElementById('vmEditPanel');
        if (orgRow) orgRow.classList.add('hidden');
        if (orgSel) orgSel.value = '';
        if (evtRow) evtRow.classList.toggle('hidden', currentRole === 'superadmin');
        if (evtSel) { evtSel.innerHTML = '<option value="">— Select event —</option>'; evtSel.disabled = true; }
        if (dutySel) { dutySel.disabled = true; dutySel.innerHTML = '<option value="">— Select organization first —</option>'; }
        if (volSel) { volSel.disabled = (currentRole === 'superadmin'); volSel.innerHTML = '<option value="">— Select volunteer —</option>'; }
        if (search) search.value = '';
        if (logs) logs.innerHTML = '';
        if (editPanel) editPanel.classList.add('hidden');
        const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', currentRole === 'superadmin');
        const editRow = document.getElementById('vmEditSelectRow'); if (editRow) editRow.classList.toggle('hidden', currentRole === 'superadmin');
        const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
      }
      document.getElementById('navAdminBtn').onclick = () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo(currentRole === 'superadmin' ? 'superadminSection' : 'adminSection');
        const table = document.getElementById('groupTable');
        if (table) table.classList.add('hidden');
        const infoWrap = document.getElementById('superadminOrgInfo');
        const infoBody = document.getElementById('superadminOrgInfoBody');
        if (infoWrap && infoBody) {
          const picker = document.getElementById('superadminOrgPicker');
          if (picker && picker.value) {
            showEditableOrgInfoPanel(picker.value);
          } else {
            infoBody.innerHTML = '';
            infoWrap.classList.add('hidden');
          }
        }
      };
      // Wire superadmin org picker to filter-linked UI pieces
      const orgPicker = document.getElementById('superadminOrgPicker');
      if (orgPicker && !orgPicker._wired) {
        orgPicker.addEventListener('change', () => {
          // Keep superadmin page pickers in sync
          const eFilter = document.getElementById('superEventGroupFilter');
          if (eFilter) eFilter.value = orgPicker.value || '';
          const dFilter = document.getElementById('superDutyGroupFilter');
          if (dFilter) dFilter.value = orgPicker.value || '';
          // Update single-org info panel and keep full table hidden
          const infoWrap = document.getElementById('superadminOrgInfo');
          const infoBody = document.getElementById('superadminOrgInfoBody');
          const table = document.getElementById('groupTable');
          if (table) table.classList.add('hidden');
          if (infoWrap && infoBody) { showEditableOrgInfoPanel(orgPicker.value); }
          // Refresh pages that depend on org
          fetchEvents();
          fetchDuties();
          populateEventDropdownsForGroup(orgPicker.value);
          // Refresh User Management list when org changes
          populateSuperadminUsers();
          const selRow = document.getElementById('saAdminRow');
          if (selRow) {
            const roleSel2 = document.getElementById('saUserRole');
            const chosenRole2 = (roleSel2 && roleSel2.value) ? roleSel2.value : 'admin';
            const requireOrg2 = (chosenRole2 === 'admin' || chosenRole2 === 'volunteer');
            selRow.classList.toggle('hidden', requireOrg2 ? !orgPicker.value : false);
          }
          // Refresh Volunteer Mgmt scoped to org
          populateVolunteerMgmt();
          refreshVolunteerLogs();
        });
        orgPicker._wired = true;
      }
      // Wire VM org picker to duty/volunteer cascading
      const vmOrgSel = document.getElementById('vmOrgPicker');
      if (vmOrgSel && !vmOrgSel._wired) {
        vmOrgSel.addEventListener('change', async () => {
          // On change: enable event row, gate others, and reload data for this org
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          if (dutySel) { dutySel.disabled = true; dutySel.innerHTML = '<option value="">— Select event —</option>'; }
          if (volSel) { volSel.disabled = !vmOrgSel.value; volSel.innerHTML = vmOrgSel.value ? '<option value="">— Select volunteer —</option>' : '<option value="">— Select organization first —</option>'; }
          const evtSel = document.getElementById('vmEvent');
          const evtRow = document.getElementById('vmEventRow');
          if (evtRow) evtRow.classList.toggle('hidden', !vmOrgSel.value);
          if (evtSel) { evtSel.disabled = !vmOrgSel.value; evtSel.innerHTML = '<option value="">— Select event —</option>'; }
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.toggle('hidden', currentRole === 'superadmin');
          const vmEditPanel = document.getElementById('vmEditPanel'); if (vmEditPanel) vmEditPanel.classList.add('hidden');
          // Sync top superadmin pickers
          const dFilter = document.getElementById('superDutyGroupFilter'); if (dFilter) dFilter.value = vmOrgSel.value || '';
          const eFilter = document.getElementById('superEventGroupFilter'); if (eFilter) eFilter.value = vmOrgSel.value || '';
          await populateVmEventsByOrg(vmOrgSel.value);
          await populateVolunteerMgmt();
          await populateVmDutiesByOrgAndEvent(vmOrgSel.value, document.getElementById('vmEvent')?.value || null);
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.toggle('hidden', !vmOrgSel.value);
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
          await refreshVolunteerLogs();
        });
        vmOrgSel._wired = true;
      }
      // When an event is chosen, reload duties filtered by event and enable volunteer once duty chosen later
      const vmEventSel2 = document.getElementById('vmEvent');
      if (vmEventSel2 && !vmEventSel2._wired) {
        vmEventSel2.addEventListener('change', async () => {
          const volSel = document.getElementById('vmVolunteer');
          const dutySel = document.getElementById('vmDuty');
          if (volSel) { volSel.disabled = false; }
          if (dutySel) { dutySel.disabled = !vmEventSel2.value; }
          await populateVolunteerMgmt();
          await populateVmDutiesByOrgAndEvent(document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || null, vmEventSel2.value || null);
          const vmEditRow = document.getElementById('vmEditSelectRow'); if (vmEditRow) vmEditRow.classList.toggle('hidden', currentRole === 'superadmin');
          const vmEditPanel = document.getElementById('vmEditPanel'); if (vmEditPanel) vmEditPanel.classList.add('hidden');
        });
        vmEventSel2._wired = true;
      }
      // When a duty is chosen, unlock volunteer selection
      const vmDutySel = document.getElementById('vmDuty');
      if (vmDutySel && !vmDutySel._wired) {
        vmDutySel.addEventListener('change', () => {
          const volSel = document.getElementById('vmVolunteer');
          if (volSel) {
            // Keep volunteer selectable regardless of duty; only superadmin without org should be gated
            const hasOrg = !!document.getElementById('vmOrgPicker')?.value || !!document.getElementById('superadminOrgPicker')?.value;
            volSel.disabled = (currentRole === 'superadmin') ? !hasOrg : false;
          }
          // Show edit select only once duty is chosen and org+event exist
          const hasOrg = (currentRole !== 'superadmin') || !!document.getElementById('vmOrgPicker')?.value || !!document.getElementById('superadminOrgPicker')?.value;
          const hasEvent = !!document.getElementById('vmEvent')?.value;
          const vmEditRow = document.getElementById('vmEditSelectRow');
          if (vmEditRow) vmEditRow.classList.toggle('hidden', !(hasOrg && hasEvent && vmDutySel.value));
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.toggle('hidden', !(hasOrg && hasEvent && vmDutySel.value));
        });
        vmDutySel._wired = true;
      }
      document.getElementById('navCreateDutyBtn').onclick = () => {
        if (!isAdminish) { return; }
        navigateTo('createDutySection');
        document.getElementById('createDutyAdmin').classList.toggle('hidden', !isAdminish);
        const volRow = document.getElementById('createDutyVol');
        if (volRow) volRow.classList.add('hidden');
        document.getElementById('dutyEditSelectorWrap').classList.toggle('hidden', !isAdminish);
        // Keep Edit Duty hidden until a duty is selected to edit
        const dutyEdit = document.getElementById('dutyEditWrap');
        if (dutyEdit) dutyEdit.classList.add('hidden');
        // Superadmin must pick org to view duties
        const dFilter = document.getElementById('dutiesSuperFilter');
        if (dFilter) dFilter.classList.toggle('hidden', currentRole !== 'superadmin');
        if (currentRole === 'superadmin') {
          const gSel = document.getElementById('superDutyGroupFilter');
          const editSel = document.getElementById('dutyEditSelect');
          const photoDutySel = document.getElementById('photoDuty');
          const vmDutySel = document.getElementById('vmDuty');
          const needsOrg = !(gSel && gSel.value);
          if (editSel) { editSel.innerHTML = `<option value="">${needsOrg ? '— Select organization first —' : '— Select duty —'}</option>`; editSel.disabled = needsOrg; }
          if (photoDutySel) { photoDutySel.innerHTML = `<option value="">${needsOrg ? '— Select organization first —' : ''}</option>`; photoDutySel.disabled = needsOrg; }
          if (vmDutySel) { vmDutySel.innerHTML = `<option value=\"\">${needsOrg ? '— Select organization first —' : '— Select duty —'}</option>`; vmDutySel.disabled = needsOrg; }
        }
        // Ensure duty event dropdowns reflect selected org context
        const gid = (currentRole === 'superadmin') ? (document.getElementById('superDutyGroupFilter')?.value || '') : (groupId != null ? String(groupId) : '');
        populateEventDropdownsForGroup(gid);
        // Populate duties list/select for current org context
        fetchDuties();
      };
      document.getElementById('navEventsBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('eventsSection');
        // Show create form only for admins/superadmins
        const wrap = document.getElementById('eventsCreateWrap');
        if (wrap) wrap.classList.toggle('hidden', !isAdminish);
        const actionsHeader = document.getElementById('eventActionsHeader');
        if (actionsHeader) actionsHeader.classList.toggle('hidden', !isAdminish);
        // Keep edit form hidden until an event is selected to edit
        const editWrap = document.getElementById('eventEditWrap');
        if (editWrap) editWrap.classList.add('hidden');
        // Superadmin must pick org to view events
        const eFilter = document.getElementById('eventsSuperFilter');
        if (eFilter) eFilter.classList.toggle('hidden', currentRole !== 'superadmin');
        await fetchEvents();
      };
      document.getElementById('navClockBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('clockSection');
        // Superadmin: show filters to require org -> event -> duty chain
        const filterRow = document.getElementById('clockSuperFilter');
        if (filterRow) filterRow.classList.toggle('hidden', currentRole !== 'superadmin');
        if (currentRole === 'superadmin') {
          // Populate organizations
          const orgSel = document.getElementById('clockOrgFilter');
          const evtSel = document.getElementById('clockEventFilter');
          const dutySel = document.getElementById('clockDutyFilter');
          try {
            const res = await authed('/groups');
            if (res.ok && orgSel) {
              const groups = await res.json();
              const current = orgSel.value;
              orgSel.innerHTML = '<option value=\"\">— Select organization —</option>';
              groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                orgSel.appendChild(opt);
              });
              if (current) orgSel.value = current;
            }
          } catch { /* silent */ }
          if (evtSel) { evtSel.disabled = !orgSel?.value; evtSel.innerHTML = '<option value=\"\">— Select event —</option>'; }
          if (dutySel) { dutySel.disabled = true; dutySel.innerHTML = '<option value=\"\">— Select duty —</option>'; }
          if (orgSel && !orgSel._wired) {
            orgSel.addEventListener('change', async () => {
              await populateClockEventsForGroup(orgSel.value);
              const dutySel2 = document.getElementById('clockDutyFilter');
              if (dutySel2) { dutySel2.disabled = true; dutySel2.innerHTML = '<option value=\"\">— Select duty —</option>'; }
              // hide data until fully selected
              const timesWrap = document.getElementById('clockTimesWrap');
              if (timesWrap) timesWrap.classList.add('hidden');
              fetchTimeTracking();
            });
            orgSel._wired = true;
          }
          if (evtSel && !evtSel._wired) {
            evtSel.addEventListener('change', async () => {
              await populateClockDutiesByOrgAndEvent(document.getElementById('clockOrgFilter')?.value || '', evtSel.value || '');
              const timesWrap = document.getElementById('clockTimesWrap');
              if (timesWrap) timesWrap.classList.add('hidden');
              fetchTimeTracking();
            });
            evtSel._wired = true;
          }
          if (dutySel && !dutySel._wired) {
            dutySel.addEventListener('change', () => {
              // show data only when all selected
              const orgVal = document.getElementById('clockOrgFilter')?.value || '';
              const evtVal = document.getElementById('clockEventFilter')?.value || '';
              const dVal = document.getElementById('clockDutyFilter')?.value || '';
              const timesWrap = document.getElementById('clockTimesWrap');
              if (timesWrap) timesWrap.classList.toggle('hidden', !(orgVal && evtVal && dVal));
              fetchTimeTracking();
            });
            dutySel._wired = true;
          }
          // Initial visibility on open
          const showData = !!orgSel?.value && !!evtSel?.value && !!dutySel?.value;
          const dutiesWrap = document.getElementById('clockDutiesWrap');
          if (dutiesWrap) dutiesWrap.classList.add('hidden'); // superadmin never sees My Duties table
          const timesWrap = document.getElementById('clockTimesWrap');
          if (timesWrap) timesWrap.classList.toggle('hidden', !showData);
        }
        if (currentRole !== 'superadmin') { await fetchDuties(); }
        await fetchTimeTracking();
      };
      document.getElementById('navPhotosBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('photosSection');
        await fetchDuties();
        const wrap = document.getElementById('photosFilterWrap');
        if (wrap) wrap.classList.toggle('hidden', !(currentRole === 'admin' || currentRole === 'superadmin'));
        // Populate volunteer filter scoped by organization
        try {
          const sel = document.getElementById('photosVolunteerFilter');
          if (!sel) { await fetchPhotos(); return; }
          let gid = '';
          if (currentRole === 'superadmin') {
            gid = document.getElementById('superadminOrgPicker')?.value || '';
            if (!gid) {
              sel.innerHTML = '<option value=\"\">— Select organization first —</option>';
              sel.disabled = true;
              await fetchPhotos(); // will no-op until org chosen
              return;
            }
          } else if (currentRole === 'admin') {
            gid = (groupId != null ? String(groupId) : '');
          }
          const qp = new URLSearchParams({ role: 'volunteer' });
          if (gid) qp.set('group_id', gid);
          const res = await authed(`/users?${qp.toString()}`);
          if (res.ok) {
            const vols = await res.json();
            const current = sel.value;
            sel.disabled = false;
            sel.innerHTML = '<option value=\"\">— All —</option>';
            vols.forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name} — ${v.email}` : v.email;
              sel.appendChild(opt);
            });
            if (current) sel.value = current;
            if (!sel._wired) { sel.addEventListener('change', fetchPhotos); sel._wired = true; }
          }
        } catch { /* silent */ }
        await fetchPhotos();
      };
      document.getElementById('navVolunteerMgmtBtn').onclick = async () => {
        resetGlobalFilters();
        resetVolunteerMgmtUI();
        navigateTo('volMgmtSection');
        // Superadmin: show VM org picker and load groups
        const vmOrgRow = document.getElementById('vmSuperOrgRow');
        const vmOrgSel = document.getElementById('vmOrgPicker');
        if (currentRole === 'superadmin') {
          if (vmOrgRow) vmOrgRow.classList.remove('hidden');
          try {
            const res = await authed('/groups');
            const groups = await res.json();
            if (vmOrgSel) {
              const current = vmOrgSel.value;
              vmOrgSel.innerHTML = '<option value="">— Select organization —</option>';
              groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.textContent = g.name;
                vmOrgSel.appendChild(opt);
              });
              if (current) vmOrgSel.value = current;
              // mirror top superadmin org if already chosen
              const topOrg = document.getElementById('superadminOrgPicker');
              if (topOrg && topOrg.value && !vmOrgSel.value) vmOrgSel.value = topOrg.value;
            }
          } catch { /* silent */ }
          // Gate duty/volunteer selects until org chosen
          const dutySel = document.getElementById('vmDuty');
          const volSel = document.getElementById('vmVolunteer');
          if (dutySel) { dutySel.innerHTML = '<option value="">— Select organization first —</option>'; dutySel.disabled = true; }
          if (volSel) { volSel.innerHTML = '<option value="">— Select organization first —</option>'; volSel.disabled = true; }
          // If org was mirrored above, trigger change to load
          if (vmOrgSel && vmOrgSel.value) { const evt = new Event('change'); vmOrgSel.dispatchEvent(evt); }
        } else {
          if (vmOrgRow) vmOrgRow.classList.add('hidden');
        }
          await populateVolunteerMgmt();
          // Force-show key rows for admins (org implied by their group)
          const eRow = document.getElementById('vmEventRow'); if (eRow) eRow.classList.remove('hidden');
          const vRow = document.getElementById('vmVolunteerRow'); if (vRow) vRow.classList.remove('hidden');
          const editRow = document.getElementById('vmEditSelectRow'); if (editRow) editRow.classList.remove('hidden');
          const lRow = document.getElementById('vmLogsRow'); if (lRow) lRow.classList.add('hidden');
        await refreshVolunteerLogs();
      };
      document.getElementById('navAccountBtn').onclick = () => { resetGlobalFilters(); resetVolunteerMgmtUI(); navigateTo('infoSection'); };
      document.getElementById('navLogoutBtn').onclick = () => document.getElementById('logoutBtn').click();
      // Populate Volunteer Management when entering Admin section
      if (isAdminish) {
        populateVolunteerMgmt();
        populateTopVolunteerForAdmin();
        const volSel = document.getElementById('vmVolunteer');
        if (volSel && !volSel._wired) {
          // Always sync the top list from the edit dropdown on focus/click so it cannot be empty
          const syncFromEdit = () => {
            const editSel = document.getElementById('vmEditSelect');
            if (!editSel) return;
            volSel.innerHTML = editSel.innerHTML || '<option value="">— Select volunteer —</option>';
            volSel.disabled = false;
          };
          const refillFromCache = () => {
            if (!volSel._all || volSel.options.length > 1) return;
            const current = volSel.value;
            volSel.innerHTML = '<option value="">— Select volunteer —</option>';
            (volSel._all || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v.id;
              opt.textContent = v.name ? `${v.name}` : v.email;
              volSel.appendChild(opt);
            });
            if (current) volSel.value = current;
          };
          const refillByFetch = async () => {
            if (volSel.options.length > 1) return;
            try {
              const orgVal = (currentRole === 'superadmin') ? (document.getElementById('vmOrgPicker')?.value || document.getElementById('superadminOrgPicker')?.value || '') : (groupId != null ? String(groupId) : '');
              const vols = await fetchVolunteers(orgVal);
              volSel._all = vols || [];
              const current = volSel.value;
              volSel.innerHTML = '<option value="">— Select volunteer —</option>';
              (volSel._all || []).forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name ? `${v.name}` : v.email;
                volSel.appendChild(opt);
              });
              if (current) volSel.value = current;
            } catch { /* silent */ }
          };
          volSel.addEventListener('focus', syncFromEdit);
          volSel.addEventListener('mousedown', syncFromEdit);
          volSel.addEventListener('click', syncFromEdit);
          volSel.addEventListener('focus', refillFromCache);
          volSel.addEventListener('mousedown', refillFromCache);
          volSel.addEventListener('click', refillFromCache);
          volSel.addEventListener('focus', refillByFetch);
          volSel.addEventListener('mousedown', refillByFetch);
          volSel.addEventListener('click', refillByFetch);
          volSel.addEventListener('change', () => {
            // Always refresh logs when a volunteer is chosen
            refreshVolunteerLogs();
            // Also open the edit panel for the selected volunteer (admins mirror superadmin edit UX)
            const id = Number(volSel.value);
            const list = volSel._all || [];
            const v = list.find(x => x.id === id);
            if (!v) return;
            const panel = document.getElementById('vmEditPanel');
            if (panel) panel.classList.remove('hidden');
            const row = document.getElementById('vmEditSelectRow');
            if (row) row.classList.toggle('hidden', currentRole === 'superadmin' ? !((document.getElementById('vmOrgPicker')?.value) || (document.getElementById('superadminOrgPicker')?.value)) : false);
            const logsRow = document.getElementById('vmLogsRow');
            if (logsRow) logsRow.classList.remove('hidden');
            const syncEditSel = document.getElementById('vmEditSelect');
            if (syncEditSel) syncEditSel.value = String(id);
            document.getElementById('vmEditId').value = String(v.id);
            document.getElementById('vmEditName').value = v.name || '';
            document.getElementById('vmEditEmail').value = v.email || '';
            const pw = document.getElementById('vmEditPassword'); if (pw) pw.value = '';
            document.getElementById('vmEditPhone').value = v.phone || '';
            document.getElementById('vmEditAddress').value = v.address || '';
          });
          volSel._wired = true;
        }
        const addBtn = document.getElementById('vmAddBtn');
        if (addBtn && !addBtn._wired) {
          addBtn.addEventListener('click', async () => {
            const err = document.getElementById('vmErr');
            if (err) err.textContent = '';
            const volunteer_id = Number(document.getElementById('vmVolunteer').value);
            const duty_id = Number(document.getElementById('vmDuty').value);
            const start_time = document.getElementById('vmStart').value;
            const end_time = document.getElementById('vmEnd').value || null;
            const duty_date = document.getElementById('vmDate').value || null;
            try {
              const res = await authed('/admin/time-tracking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ volunteer_id, duty_id, start_time, end_time, duty_date })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to add time'; return; }
              await fetchTimeTracking();
              await refreshVolunteerLogs();
            } catch {
              if (err) err.textContent = 'Error adding time';
            }
          });
          addBtn._wired = true;
        }
        const saveUserBtn = document.getElementById('vmSaveUserBtn');
        if (saveUserBtn && !saveUserBtn._wired) {
          saveUserBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('vmEditId').value);
            const name = document.getElementById('vmEditName').value.trim();
            const email = document.getElementById('vmEditEmail').value.trim();
            const password = document.getElementById('vmEditPassword')?.value || '';
            const phone = document.getElementById('vmEditPhone').value.trim();
            const address = document.getElementById('vmEditAddress').value.trim();
            const err = document.getElementById('vmSaveUserErr');
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phone, address, ...(password ? { password } : {}) })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to save user'; return; }
              const pw = document.getElementById('vmEditPassword');
              if (pw) pw.value = '';
              await populateVolunteerMgmt();
              const panel = document.getElementById('vmEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error saving user'; }
          });
          saveUserBtn._wired = true;
        }
        const closeBtn = document.getElementById('vmCloseEditBtn');
        if (closeBtn && !closeBtn._wired) {
          closeBtn.addEventListener('click', () => {
            const panel = document.getElementById('vmEditPanel');
            if (panel) panel.classList.add('hidden');
          });
          closeBtn._wired = true;
        }
        // Volunteer password helpers
        const vmPw = document.getElementById('vmEditPassword');
        const vmToggle = document.getElementById('vmTogglePwBtn');
        if (vmToggle && !vmToggle._wired) {
          vmToggle.addEventListener('click', () => {
            if (!vmPw) return;
            const show = vmPw.type !== 'text';
            vmPw.type = show ? 'text' : 'password';
            vmToggle.textContent = show ? 'Hide' : 'Show';
          });
          vmToggle._wired = true;
        }
        // removed Generate button per request
        const vmUpdate = document.getElementById('vmUpdatePwBtn');
        if (vmUpdate && !vmUpdate._wired) {
          vmUpdate.addEventListener('click', async () => {
            if (!vmPw || !vmPw.value) return;
            const id = Number(document.getElementById('vmEditId').value);
            const err = document.getElementById('vmSaveUserErr');
            if (err) err.textContent = '';
            if (vmPw.value.length < 6) { if (err) err.textContent = 'Password must be at least 6 chars'; return; }
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: vmPw.value })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to update password'; return; }
              vmPw.value = '';
            } catch { if (err) err.textContent = 'Error updating password'; }
          });
          vmUpdate._wired = true;
        }
      }
      // Superadmin admin-management wiring
      if (currentRole === 'superadmin') {
        populateSuperadminUsers();
        const selRow = document.getElementById('saAdminRow');
        if (selRow) selRow.classList.toggle('hidden', !orgPicker.value);
        const sel = document.getElementById('saAdminSelect');
        if (sel && !sel._wired) {
          sel.addEventListener('change', () => {
            const id = Number(sel.value);
            const optionData = sel._users || [];
            const u = optionData.find(x => x.id === id);
            if (!u) return;
            const panel = document.getElementById('saAdminEditPanel');
            if (panel) panel.classList.remove('hidden');
            document.getElementById('saAdminEditId').value = String(u.id);
            document.getElementById('saAdminEditName').value = u.name || '';
            document.getElementById('saAdminEditEmail').value = u.email || '';
            document.getElementById('saAdminEditPhone').value = u.phone || '';
            document.getElementById('saAdminEditAddress').value = u.address || '';
          });
          sel._wired = true;
        }
        const roleFilter = document.getElementById('saUserRole');
        if (roleFilter && !roleFilter._wired) {
          roleFilter.addEventListener('change', () => {
            populateSuperadminUsers();
            const selRow2 = document.getElementById('saAdminRow');
            const orgPicker2 = document.getElementById('superadminOrgPicker');
            const chosenRole3 = roleFilter.value || 'admin';
            const requireOrg3 = (chosenRole3 === 'admin' || chosenRole3 === 'volunteer');
            if (selRow2) selRow2.classList.toggle('hidden', requireOrg3 ? !orgPicker2?.value : false);
          });
          roleFilter._wired = true;
        }
        // Password helpers
        const pwInput = document.getElementById('saAdminEditPassword');
        const toggleBtn = document.getElementById('saTogglePwBtn');
        if (toggleBtn && !toggleBtn._wired) {
          toggleBtn.addEventListener('click', () => {
            if (!pwInput) return;
            const show = pwInput.type !== 'text';
            pwInput.type = show ? 'text' : 'password';
            toggleBtn.textContent = show ? 'Hide' : 'Show';
          });
          toggleBtn._wired = true;
        }
        // removed Generate button per request
        const updatePwBtn = document.getElementById('saUpdatePwBtn');
        if (updatePwBtn && !updatePwBtn._wired) {
          updatePwBtn.addEventListener('click', async () => {
            if (!pwInput || !pwInput.value) return;
            const id = Number(document.getElementById('saAdminEditId').value);
            const err = document.getElementById('saAdminSaveErr');
            if (err) err.textContent = '';
            if (pwInput.value.length < 6) { if (err) err.textContent = 'Password must be at least 6 chars'; return; }
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pwInput.value })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to update password'; return; }
              pwInput.value = '';
            } catch { if (err) err.textContent = 'Error updating password'; }
          });
          updatePwBtn._wired = true;
        }
        const saveBtn = document.getElementById('saSaveAdminBtn');
        if (saveBtn && !saveBtn._wired) {
          saveBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('saAdminEditId').value);
            const name = document.getElementById('saAdminEditName').value.trim();
            const email = document.getElementById('saAdminEditEmail').value.trim();
            const password = document.getElementById('saAdminEditPassword').value;
            const phone = document.getElementById('saAdminEditPhone').value.trim();
            const address = document.getElementById('saAdminEditAddress').value.trim();
            const err = document.getElementById('saAdminSaveErr');
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phone, address, ...(password ? { password } : {}) })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to save user'; return; }
              // Clear password field after save
              const pw = document.getElementById('saAdminEditPassword');
              if (pw) pw.value = '';
              await populateSuperadminUsers();
              const panel = document.getElementById('saAdminEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error saving user'; }
          });
          saveBtn._wired = true;
        }
        const delBtn = document.getElementById('saDeleteUserBtn');
        if (delBtn && !delBtn._wired) {
          delBtn.addEventListener('click', async () => {
            const id = Number(document.getElementById('saAdminEditId').value);
            const err = document.getElementById('saAdminSaveErr');
            if (!id || !Number.isFinite(id)) return;
            if (!confirm('Delete this user? This cannot be undone.')) return;
            if (err) err.textContent = '';
            try {
              const res = await authed(`/users/${id}`, { method: 'DELETE' });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) { if (err) err.textContent = data.message || 'Failed to delete user'; return; }
              await populateSuperadminUsers();
              const panel = document.getElementById('saAdminEditPanel');
              if (panel) panel.classList.add('hidden');
            } catch { if (err) err.textContent = 'Error deleting user'; }
          });
          delBtn._wired = true;
        }
        const closeBtn = document.getElementById('saCloseAdminEditBtn');
        if (closeBtn && !closeBtn._wired) {
          closeBtn.addEventListener('click', () => {
            const panel = document.getElementById('saAdminEditPanel');
            if (panel) panel.classList.add('hidden');
          });
          closeBtn._wired = true;
        }
      }
    }
    // password generation removed per request

    // CSV download (role-scoped)
    document.getElementById('downloadCsvBtn')?.addEventListener('click', async () => {
      document.getElementById('downloadCsvError').textContent = '';
      try {
        const res = await authed('/time-tracking.csv');
        if (!res.ok) {
          document.getElementById('downloadCsvError').textContent = 'Failed to download CSV';
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'time-tracking.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch {
        document.getElementById('downloadCsvError').textContent = 'Error downloading CSV';
      }
    });

    // Photos
    async function fetchPhotos() {
      try {
        const params = new URLSearchParams();
        // Scope by org for admin/superadmin
        if (role === 'superadmin') {
          const gid = document.getElementById('superadminOrgPicker')?.value || '';
          if (!gid) {
            const gallery = document.getElementById('photoGallery');
            if (gallery) gallery.innerHTML = '';
            return;
          }
          params.set('group_id', gid);
        } else if (role === 'admin') {
          if (groupId != null) params.set('group_id', String(groupId));
        }
        // Optional volunteer filter
        const sel = document.getElementById('photosVolunteerFilter');
        if (sel && sel.value) params.set('volunteer_id', sel.value);
        const res = await authed(`/photos${params.toString() ? `?${params.toString()}` : ''}`);
        if (!res.ok) return;
        const rows = await res.json();
        const gallery = document.getElementById('photoGallery');
        if (!gallery) return;
        gallery.innerHTML = '';
        rows.forEach(p => {
          const div = document.createElement('div');
          div.style.marginTop = '8px';
          const delBtn = (role === 'admin' || role === 'superadmin') ? `<button data-pid="${p.id}" class="photoDelBtn" style="margin-left:8px">Delete</button>` : '';
          div.innerHTML = `<img src="${p.file_path}" alt="photo" style="max-width:200px;border-radius:8px;"> <div>${p.caption || ''} ${p.approved ? '✔️' : '⏳'} ${delBtn}</div>`;
          gallery.appendChild(div);
        });
        // wire delete
        gallery.querySelectorAll('.photoDelBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-pid'));
          if (!confirm('Delete this photo?')) return;
          try {
            const res = await authed(`/photos/${id}`, { method: 'DELETE' });
            if (res.ok) fetchPhotos();
          } catch { /* silent */ }
        }));
      } catch { /* silent */ }
    }
    // Admin photo approvals
   async function fetchPhotoApprovals() {
      if (role !== 'admin' && role !== 'superadmin') return;
      try {
        let path = '/photos';
        if (role === 'superadmin') {
          const gid = document.getElementById('superadminOrgPicker')?.value;
          const w1 = document.getElementById('photoApprovals');
          const w2 = document.getElementById('superPhotoApprovals');
          if (!gid) { [w1, w2].forEach(w => { if (w) w.innerHTML = ''; }); return; }
          path += `?group_id=${encodeURIComponent(gid)}`;
        }
        const res = await authed(path);
        if (!res.ok) return;
        const rows = await res.json();
        const wrap = document.getElementById('superPhotoApprovals') || document.getElementById('photoApprovals');
        if (!wrap) return;
        wrap.innerHTML = '';
        rows.filter(p => !p.approved).forEach(p => {
          const div = document.createElement('div');
          div.style.marginTop = '8px';
          div.innerHTML = `<img src="${p.file_path}" alt="pending" style="max-width:160px;border-radius:6px;margin-right:8px;vertical-align:middle;">` +
                          `<span>#${p.id} — Volunteer ${p.volunteer_id} — Duty ${p.duty_id} — ${p.caption || ''}</span> ` +
                          `<button onclick="approvePhoto(${p.id})">Approve</button> ` +
                          `<button data-pid="${p.id}" class="photoDelBtn">Delete</button>`;
          wrap.appendChild(div);
        });
        wrap.querySelectorAll('.photoDelBtn').forEach(btn => btn.addEventListener('click', async (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-pid'));
          if (!confirm('Delete this photo?')) return;
          try {
            const res = await authed(`/photos/${id}`, { method: 'DELETE' });
            if (res.ok) { fetchPhotoApprovals(); fetchPhotos(); }
          } catch { /* silent */ }
        }));
      } catch { /* silent */ }
    }
    async function approvePhoto(id) {
      try {
        const res = await authed(`/photos/${id}/approve`, { method: 'POST' });
        if (res.ok) { fetchPhotoApprovals(); fetchPhotos(); }
      } catch { /* silent */ }
    }

    document.getElementById('uploadPhotoBtn')?.addEventListener('click', async () => {
      document.getElementById('photoError').textContent = '';
      try {
        const dutyId = document.getElementById('photoDuty').value;
        const file = document.getElementById('photoFile').files[0];
        const caption = document.getElementById('photoCaption').value.trim();
        if (!file) { document.getElementById('photoError').textContent = 'Choose a photo'; return; }
        const form = new FormData();
        form.append('photo', file);
        form.append('caption', caption);
        const res = await fetch(`${apiUrl}/duties/${dutyId}/photos`, {
          method: 'POST',
          headers: token ? { Authorization: `Bearer ${token}` } : {},
          body: form,
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('photoError').textContent = data.message || 'Upload failed';
          return;
        }
        document.getElementById('photoFile').value = '';
        document.getElementById('photoCaption').value = '';
        fetchPhotos();
      } catch {
        document.getElementById('photoError').textContent = 'Error uploading photo';
      }
    });
  </script>
</body>
</html>
